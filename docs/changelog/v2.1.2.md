# Changelog (Comparison v1.2.1 → Current)

This changelog describes **all relevant changes since v1.2.1**. Focus: GitHub Actions workflows, introduction of the server manager, new functionality/automation, new environment variables, and documentation updates. It also includes details about architecture, runtime flow, defaults, validation, and practical container operation.

---

## 1) GitHub Actions – Workflow Changes

### 1.1 Security & Scan Workflows (dev/release)

- **Explicit workflow permissions** were added so jobs run with minimal rights (`contents: read`, `actions: read`, `security-events: write`). This enables SARIF uploads for security scans. 【F:.github/workflows/dev.yml†L14-L20】【F:.github/workflows/release.yml†L9-L15】
- **New build context**: Images are no longer built from repo root; a prepared `image_context` with `Dockerfile` + `server_manager` is used. This reduces build context size and improves determinism. 【F:.github/workflows/dev.yml†L52-L66】【F:.github/workflows/release.yml†L42-L56】
- **Docker Scout**: Quickview/CVE scans are now **non-blocking** (exit-code = false) but still produce SARIF artifacts. 【F:.github/workflows/dev.yml†L74-L99】【F:.github/workflows/release.yml†L78-L103】
- **Trivy**: High/Critical scans are also **non-blocking** (exit-code = 0) and generate SARIF artifacts. 【F:.github/workflows/dev.yml†L107-L131】【F:.github/workflows/release.yml†L121-L146】
- **SARIF upload guard**: Uploads are skipped for fork PRs to avoid permission errors. 【F:.github/workflows/dev.yml†L94-L100】【F:.github/workflows/dev.yml†L146-L152】【F:.github/workflows/release.yml†L108-L114】【F:.github/workflows/release.yml†L160-L166】

**Practical impact:** Scans still provide transparency (SARIF in the Security view) but no longer fail builds on findings, reducing release friction while keeping visibility. 【F:.github/workflows/dev.yml†L74-L131】【F:.github/workflows/release.yml†L78-L146】

### 1.2 Docker Hub Description

- The **Docker Hub description** is no longer updated via a custom API script. It now uses `peter-evans/dockerhub-description@v5`, and the README path is set to `docs/README_DOCKER_HUB.md`. 【F:.github/workflows/release.yml†L180-L193】【F:.github/workflows/instructions.md†L16-L20】

**Practical impact:** The description update is more reliable (no custom API logic), and the Docker Hub README is managed in a clear `docs/` location. 【F:.github/workflows/release.yml†L180-L193】【F:docs/README_DOCKER_HUB.md†L1-L120】

---

## 2) Introduction of the Server Manager (Core Feature)

The major shift is the introduction of a **server manager** under `server_manager/`. It replaces the old entrypoint logic and consolidates **start, stop, update, restart, backup, health checks, logs, cron scheduling, and configuration management** into a modular system.

**Primary goals:** stable operation (PID1 handling), scheduled updates/backups, robust validation, better logging, and controlled automation. 【F:server_manager/manager.sh†L21-L208】

### 2.1 New Manager Entrypoint

- The container entrypoint is now **`tini` + `/opt/enshrouded/manager/manager.sh run`**, making the manager PID1 and ensuring proper signal handling. 【F:Dockerfile†L128-L131】
- The manager provides commands: `run`, `setup`, `start`, `stop`, `restart`, `update`, `backup`, `status`, `logs`. This replaces the prior single-shot startup script. 【F:server_manager/manager.sh†L21-L45】【F:server_manager/manager.sh†L209-L284】

**Detail:** `run` starts PID1 mode, `setup` prepares config/dirs/A2S, `status` shows manager/server/version/player state, and `logs` tails the newest log file. 【F:server_manager/manager.sh†L21-L208】

### 2.2 Lifecycle Handling (Start/Stop/Restart)

- **Start**: Launches the server via Proton, sets `WINEPREFIX`/`STEAM_COMPAT_*`, and writes PID files. 【F:server_manager/lib/server.sh†L424-L439】
- **Server runtime**: Ensures the server binary exists (downloads if missing), runs via `proton runinprefix`, and performs `wineserver -k` cleanup on exit. 【F:server_manager/lib/server.sh†L361-L452】
- **Stop**: Controlled shutdown with escalation `SIGINT → SIGTERM → SIGKILL` and a timeout. 【F:server_manager/lib/server.sh†L391-L419】
- **Restart**: Optional player-count safety checks plus pre/post hooks. 【F:server_manager/lib/server.sh†L515-L532】【F:server_manager/lib/server.sh†L534-L566】

**Detail:** The manager also detects orphaned processes (`pgrep` for `enshrouded_server`) to keep status accurate even if PID files are missing. 【F:server_manager/lib/server.sh†L15-L41】

### 2.3 Auto-Update + Versioning

- Update checks query the SteamCMD API for the latest `buildid`, compare against `.current_version`, and store the new build ID after a successful update. 【F:server_manager/lib/update.sh†L28-L70】
- Updates download via SteamCMD using `GAME_BRANCH`/`STEAMCMD_ARGS`, retry once after cleanup on failure, and can run pre/post hooks (`UPDATE_PRE_HOOK`/`UPDATE_POST_HOOK`). 【F:server_manager/lib/update.sh†L72-L175】【F:docs/environment.md†L140-L143】【F:docs/environment.md†L204-L209】
- **AUTO_UPDATE** (interval), **AUTO_UPDATE_ON_BOOT**, and **AUTO_RESTART_ON_UPDATE** support automated updates. 【F:server_manager/lib/common.sh†L276-L279】【F:docs/environment.md†L151-L155】

**Detail:** If Proton files are missing an update is forced; if build IDs are unavailable the manager warns and may skip updates to stay safe. 【F:server_manager/lib/update.sh†L20-L53】

### 2.4 Health Checks & Player Query (A2S)

- **A2S queries** provide player counts, enabling safe update/restart decisions. 【F:server_manager/lib/server.sh†L45-L119】
- **SAFE_MODE**, **UPDATE_CHECK_PLAYERS**, **RESTART_CHECK_PLAYERS** enforce “only when empty” behavior. 【F:server_manager/lib/server.sh†L121-L172】【F:server_manager/lib/common.sh†L280-L296】
- The manager installs `python-a2s` at setup time when missing to enable A2S player checks. 【F:server_manager/lib/config.sh†L1614-L1627】

**Detail:** A2S uses `python-a2s` with retry/timeout control to avoid blocking health checks. 【F:server_manager/lib/config.sh†L1614-L1627】【F:server_manager/lib/server.sh†L45-L119】

### 2.5 Logging & Log Streaming

- Log output is UTC timestamped and context-labeled; `LOG_LEVEL` filters only manager logs. 【F:server_manager/lib/common.sh†L34-L105】【F:docs/log.md†L1-L34】
- A **log streamer** tails the newest log file, uses `LOG_FILE_PATTERN`, and switches on rotation via polling (`LOG_POLL_INTERVAL`). 【F:server_manager/lib/server.sh†L569-L618】
- Streaming is controlled via `LOG_TO_STDOUT`, `LOG_TAIL_LINES`, `LOG_POLL_INTERVAL`, `LOG_FILE_PATTERN`. 【F:server_manager/lib/common.sh†L282-L285】【F:docs/environment.md†L169-L177】

**Detail:** Streaming can be disabled via `LOG_TO_STDOUT=false`; manager core logs still print to stdout. 【F:server_manager/lib/server.sh†L621-L633】【F:docs/log.md†L1-L34】

### 2.6 Backups (Manual + Automated)

- **Backup command** with pre/post hooks, zip archive creation, and retention (`BACKUP_MAX_COUNT`). 【F:server_manager/lib/backup.sh†L1-L113】
- Uses a configurable backup directory (`BACKUP_DIR`). 【F:server_manager/lib/common.sh†L298-L299】【F:docs/environment.md†L184-L185】
- Backups read the latest save from `SAVEFILE_NAME-index`, embed a clean index inside the archive, and skip cleanup when `BACKUP_MAX_COUNT=0`. 【F:server_manager/lib/backup.sh†L37-L100】

**Detail:** The backup zips the latest save, renames the save inside the archive via `zipnote`, and rotates old backups when cleanup is enabled. 【F:server_manager/lib/backup.sh†L101-L113】

### 2.7 Cron Scheduling & Requests

- **Cron scheduling** for updates, backups, and restarts is written into crontab and triggers `supervisorctl` jobs (`server-manager-update/backup/restart`). 【F:server_manager/manager.sh†L304-L352】
- **Request queue** via files (`update`/`backup`/`restart`) under `/var/run/enshrouded` is processed by the running manager loop. 【F:server_manager/manager.sh†L486-L503】【F:server_manager/lib/common.sh†L269-L342】

**Detail:** Cron only starts if schedules are set and cron is available; output is routed to PID1 stdout/stderr via `/proc/1/fd/*`. 【F:server_manager/manager.sh†L304-L352】

### 2.8 Configuration Management (JSON + ENV)

- The manager manages both `enshrouded_server.json` and **`server_manager.json`** (manager-specific config). 【F:server_manager/lib/config.sh†L234-L352】【F:server_manager/lib/config.sh†L800-L872】
- ENV overrides JSON with validation; invalid values are warned and ignored. 【F:server_manager/lib/config.sh†L352-L444】【F:server_manager/lib/config.sh†L800-L872】
- **User groups** and **game settings** are fully configurable via ENV with validation, defaults, and warnings. 【F:server_manager/lib/config.sh†L1043-L1364】【F:server_manager/lib/config.sh†L1366-L1628】
- On first creation, `enshrouded_server.json` is generated from the selected profile, `bans` is ensured, and file permissions are set to `600`. 【F:server_manager/lib/config.sh†L1292-L1321】
- Missing user group passwords are generated and optionally printed when `PRINT_GROUP_PASSWORDS=true`. 【F:server_manager/lib/config.sh†L1323-L1358】【F:docs/environment.md†L211-L212】

**Detail:** Defaults are written back into JSON so the resulting config is complete and consistent after startup. 【F:server_manager/lib/config.sh†L874-L997】【F:server_manager/lib/config.sh†L1139-L1341】

### 2.9 Profile-Based Defaults (Manager + Enshrouded)

- The manager supports **profile-based initial config**: `EN_PROFILE` selects the `enshrouded_server.json` template and `MANAGER_PROFILE` selects the `server_manager.json` defaults; invalid names fall back to `default`. 【F:server_manager/lib/config.sh†L79-L234】
- Profiles are applied **only when the config file is created**; subsequent runs keep existing JSON and apply ENV overrides and normal defaults. 【F:server_manager/lib/config.sh†L810-L862】【F:server_manager/lib/config.sh†L1292-L1321】
- **Shipped profiles** include a default Enshrouded server profile and manager profiles `default.json` and `manual.json` (manual disables automation and cron scheduling). 【F:server_manager/profiles_enshrouded/default/enshrouded_server.json†L1-L95】【F:server_manager/profiles/default.json†L1-L49】【F:server_manager/profiles/manual.json†L1-L49】

### 2.10 Supervisor, Cron Jobs & Syslog Streaming

- The manager now relies on **supervisord** and a dedicated config to run the server process and background jobs (`update`, `backup`, `restart`, `cron`) as named programs with unified stdout/stderr handling. 【F:server_manager/supervisord.conf†L1-L145】【F:server_manager/manager.sh†L388-L483】【F:server_manager/manager.sh†L647-L659】
- Scheduled cron entries trigger `supervisorctl start server-manager-<action>` so update/backup/restart jobs run under supervisor control rather than inline shell commands. 【F:server_manager/manager.sh†L304-L352】
- **Syslog streaming** is supported via `rsyslogd` and dedicated supervisor programs, and streamed output can be forwarded to stdout when `LOG_TO_STDOUT=true`. 【F:server_manager/manager.sh†L152-L287】【F:server_manager/supervisord.conf†L69-L145】【F:docs/log.md†L1-L34】

### 2.11 Permissions, User Mapping & Preflight Checks

- `PUID`/`PGID` are required and used to map the `steam` user and fix ownership on key directories (`HOME`, `INSTALL_PATH`, `RUN_DIR`). 【F:server_manager/manager.sh†L112-L128】
- Preflight checks ensure install/save/log/backup paths are writable and can auto-fix ownership/modes via `AUTO_FIX_PERMS`, `AUTO_FIX_DIR_MODE`, `AUTO_FIX_FILE_MODE`. 【F:server_manager/lib/config.sh†L1228-L1276】
- `UMASK` is applied during setup to standardize new file modes. 【F:server_manager/lib/common.sh†L204-L208】【F:server_manager/manager.sh†L131-L148】

### 2.12 Status, Requests & Concurrency

- `status` summarizes manager/server/supervisor/job states, uptime, players, and current version. 【F:server_manager/manager.sh†L520-L575】
- PID files under `/var/run/enshrouded` prevent overlapping actions, and request files (`update`/`backup`/`restart`) trigger async jobs. 【F:server_manager/lib/common.sh†L269-L304】【F:server_manager/manager.sh†L470-L503】

---

## 3) New/Structured Environment Variables

With the server manager, the project now exposes a **much broader standardized ENV surface**. Key groups:

### 3.1 Profile Selection (EN_PROFILE / MANAGER_PROFILE)

- New profile selectors: `EN_PROFILE` (Enshrouded defaults) and `MANAGER_PROFILE` (manager defaults) are applied only on first creation of their respective JSON files. 【F:docs/environment.md†L22-L27】【F:docs/environment.md†L115-L121】【F:server_manager/lib/config.sh†L79-L234】【F:server_manager/lib/config.sh†L810-L862】【F:server_manager/lib/config.sh†L1292-L1321】

### 3.2 Manager Core Variables

- Required UID/GID mapping: **`PUID`** and **`PGID`**, both validated and mandatory. 【F:server_manager/manager.sh†L112-L119】【F:docs/environment.md†L121-L123】
- Paths/runtime: fixed under `/home/steam` and `/var/run/enshrouded`. 【F:server_manager/lib/common.sh†L249-L274】
- Logging & formatting: `LOG_LEVEL`, `LOG_CONTEXT`, `NO_COLOR`, `UMASK`. 【F:server_manager/lib/common.sh†L34-L105】【F:docs/environment.md†L124-L127】
- Permissions & shutdown: `AUTO_FIX_PERMS`, `AUTO_FIX_DIR_MODE`, `AUTO_FIX_FILE_MODE`, `STOP_TIMEOUT`. 【F:docs/environment.md†L128-L133】【F:server_manager/lib/config.sh†L1228-L1276】

**Detail:** `PUID/PGID` are strictly validated (non-zero numeric), preventing invalid user mappings. 【F:server_manager/manager.sh†L112-L119】

### 3.3 Update/Restart/Health

- Automated update/restart logic: `AUTO_UPDATE`, `AUTO_UPDATE_INTERVAL`, `AUTO_UPDATE_ON_BOOT`, `AUTO_RESTART`, `AUTO_RESTART_DELAY`, `AUTO_RESTART_MAX_ATTEMPTS`, `AUTO_RESTART_ON_UPDATE`. 【F:server_manager/lib/common.sh†L276-L288】【F:docs/environment.md†L151-L158】
- Player checks & safe mode: `SAFE_MODE`, `UPDATE_CHECK_PLAYERS`, `RESTART_CHECK_PLAYERS`. 【F:server_manager/lib/common.sh†L280-L296】【F:docs/environment.md†L158-L163】
- Health check timing and A2S controls: `HEALTH_CHECK_INTERVAL`, `HEALTH_CHECK_ON_START`, `A2S_TIMEOUT`, `A2S_RETRIES`, `A2S_RETRY_DELAY`. 【F:server_manager/lib/common.sh†L289-L293】【F:docs/environment.md†L159-L165】

**Detail:** `SAFE_MODE=true` skips update/restart when player count is unknown. 【F:server_manager/lib/server.sh†L121-L172】

### 3.4 Logging & Backups

- Log streaming settings (`LOG_TO_STDOUT`, `LOG_TAIL_LINES`, `LOG_POLL_INTERVAL`, `LOG_FILE_PATTERN`). 【F:server_manager/lib/common.sh†L282-L285】【F:docs/environment.md†L169-L177】
- Backup controls (`BACKUP_DIR`, `BACKUP_MAX_COUNT`, hooks) and the backup base name (`SAVEFILE_NAME`). 【F:server_manager/lib/common.sh†L254-L300】【F:docs/environment.md†L131-L186】

**Detail:** `BACKUP_PRE_HOOK`/`BACKUP_POST_HOOK` enable integrations like external uploads after backups. 【F:server_manager/lib/backup.sh†L1-L16】【F:docs/environment.md†L186-L188】

### 3.5 Cron & Hooks

- Scheduling variables (`ENABLE_CRON`, `UPDATE_CRON`, `BACKUP_CRON`, `RESTART_CRON`) and hooks (`BOOTSTRAP_HOOK`, `UPDATE_PRE_HOOK`, `UPDATE_POST_HOOK`, `RESTART_PRE_HOOK`, `RESTART_POST_HOOK`). 【F:docs/environment.md†L191-L210】
- Password output control: `PRINT_GROUP_PASSWORDS` toggles printing generated user group passwords on first config creation. 【F:docs/environment.md†L211-L212】【F:server_manager/lib/config.sh†L1323-L1358】

**Detail:** `BOOTSTRAP_HOOK` runs once after setup, useful for initialization steps. 【F:server_manager/lib/config.sh†L1607-L1611】【F:docs/environment.md†L206-L207】

### 3.6 Enshrouded Server Settings (ENSHROUDED_ / ENSHROUDED_GS_)

- Full coverage for server settings and **game settings** and **user groups** via ENV (e.g., `ENSHROUDED_GS_*`, `ENSHROUDED_ROLE_*`). 【F:server_manager/lib/config.sh†L1-L1628】【F:docs/environment.md†L24-L76】

**Detail:** Settings are range-checked (e.g., SlotCount 1–16, QueryPort 1–65535, enum validation). Invalid values are rejected/ignored. 【F:server_manager/lib/config.sh†L1000-L1210】【F:server_manager/lib/config.sh†L1139-L1341】

---

## 4) Docker Image & Entrypoint Architecture

- The Dockerfile now **bundles the server manager** under `/opt/enshrouded/manager` and sets it as entrypoint. 【F:Dockerfile†L104-L108】【F:Dockerfile†L128-L131】
- The image is no longer driven by a single entrypoint script; instead, a **persistent manager process** handles updates, restarts, health checks, and cron. 【F:server_manager/manager.sh†L131-L208】

**Detail:** The manager starts as root, applies UID/GID mapping for the `steam` user, then re-execs as `steam` for safer runtime permissions. 【F:server_manager/manager.sh†L112-L128】【F:server_manager/manager.sh†L647-L667】

### 4.1 Dockerfile Stack & Runtime Changes (since v1.2.1)

- **Build args + Proton stage**: Build args now define base image, SteamCMD image, and Proton-GE version; Proton-GE is downloaded in a builder stage and copied into runtime. 【F:Dockerfile†L1-L92】
- **Additional runtime tools**: `cron`, `rsyslog`, `supervisor`, `jq`, `python3`, `python3-pip`, `procps`, `zip`, `curl`, etc. are installed to enable manager features (A2S, config, backups, scheduling). 【F:Dockerfile†L47-L65】
- **Dockerfile defaults**: `STEAM_APP_ID` is now set as a default ENV value. 【F:Dockerfile†L36-L42】
- **Manager install + CLI**: The manager is added under `/opt/enshrouded/manager` and exposed via a `manager.sh` symlink in `/usr/local/bin`. 【F:Dockerfile†L104-L108】
- **Entrypoint migration**: The old entrypoint script is replaced by the manager PID1 entrypoint. 【F:Dockerfile†L128-L131】【F:server_manager/manager.sh†L647-L659】

---

## 5) Documentation

- **New document**: `docs/environment.md` lists **all environment variables** (Dockerfile, manager, server settings, updates/backups/logging). 【F:docs/environment.md†L1-L240】
- **New documents**: `docs/log.md` (logging behavior, syslog/supervisor streams) and `docs/server_manager_commands.md` (manager & supervisor commands/program names). 【F:docs/log.md†L1-L34】【F:docs/server_manager_commands.md†L1-L89】
- **New documents**: profile references for both manager and Enshrouded defaults (`docs/server_manager_profiles.md`, `docs/enshrouded_profiles.md`). 【F:docs/server_manager_profiles.md†L1-L87】【F:docs/enshrouded_profiles.md†L1-L98】
- **Docker Hub README** moved to `docs/README_DOCKER_HUB.md` and is wired into the release workflow. 【F:docs/README_DOCKER_HUB.md†L1-L120】【F:.github/workflows/release.yml†L180-L193】
- The main README was expanded/updated (e.g., PUID/PGID setup, improved Quickstart). 【F:README.md†L159-L236】

**Detail:** Quickstart now uses `PUID/PGID` instead of older variables, aligning with manager design. 【F:README.md†L187-L236】

### 5.1 Documentation Impact for Operators

- **UID/GID change**: Quickstart explicitly references `PUID/PGID` (instead of `ENSHROUDED_USER_ID`/`ENSHROUDED_GROUP_ID`). This matches manager user-mapping logic. 【F:README.md†L187-L236】【F:server_manager/manager.sh†L112-L119】
- **ENV reference**: `docs/environment.md` is now the single source of truth for ENV variables, validations, and defaults. 【F:docs/environment.md†L1-L240】【F:server_manager/lib/config.sh†L352-L444】
- **Profile guidance**: Docker Hub README and docs now point to profile usage (`EN_PROFILE`, `MANAGER_PROFILE`) and describe default/manual profiles. 【F:docs/README_DOCKER_HUB.md†L95-L173】【F:docs/server_manager_profiles.md†L1-L87】【F:docs/enshrouded_profiles.md†L1-L98】

### 5.2 Repository Layout Changes

- Added the `server_manager/` implementation (`manager.sh`, `lib/*`) and supervisor config. 【F:server_manager/manager.sh†L1-L208】【F:server_manager/lib/common.sh†L1-L140】【F:server_manager/lib/config.sh†L1-L1628】【F:server_manager/supervisord.conf†L1-L145】
- Added profile templates under `server_manager/profiles/` and `server_manager/profiles_enshrouded/`. 【F:server_manager/profiles/default.json†L1-L49】【F:server_manager/profiles/manual.json†L1-L49】【F:server_manager/profiles_enshrouded/default/enshrouded_server.json†L1-L95】
- Added a complete sample manager config at `ressources/server_manager.json`. 【F:ressources/server_manager.json†L1-L50】
- Docker Hub README moved to `docs/README_DOCKER_HUB.md` and is referenced by the release workflow. 【F:docs/README_DOCKER_HUB.md†L1-L120】【F:.github/workflows/release.yml†L180-L193】

---

## 6) Summary

Since v1.2.1, the project has evolved from a one-shot startup script to a **full-featured, configurable server manager**. Build-id–based updates, backups, health checks, cron scheduling, supervisor-managed jobs, log streaming (including syslog/supervisor streams), permission mapping/auto-fix, **profile-based defaults** (including a manual profile to disable automation), and granular ENV-based configuration make deployments more stable, reproducible, and maintainable. CI workflows are more secure and resilient against fork-PR limitations. 【F:server_manager/manager.sh†L21-L208】【F:server_manager/lib/update.sh†L28-L175】【F:server_manager/lib/backup.sh†L1-L119】【F:server_manager/manager.sh†L152-L287】【F:server_manager/lib/config.sh†L1228-L1276】【F:server_manager/supervisord.conf†L1-L145】【F:server_manager/profiles/manual.json†L1-L49】【F:.github/workflows/dev.yml†L14-L152】
