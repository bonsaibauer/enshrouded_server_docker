# Changelog (Comparison v1.2.1 → Current)

This changelog describes **all relevant changes since v1.2.1**. Focus: GitHub Actions workflows, introduction of the server manager, new functionality/automation, new environment variables, and documentation updates. It also includes details about architecture, runtime flow, defaults, validation, and practical container operation.

---

## 1) GitHub Actions – Workflow Changes

### 1.1 Security & Scan Workflows (dev/release)

- **Explicit workflow permissions** were added so jobs run with minimal rights (`contents: read`, `actions: read`, `security-events: write`). This enables SARIF uploads for security scans. 【F:.github/workflows/dev.yml†L14-L20】【F:.github/workflows/release.yml†L9-L15】
- **New build context**: Images are no longer built from repo root; a prepared `image_context` with `Dockerfile` + `server_manager` is used. This reduces build context size and improves determinism. 【F:.github/workflows/dev.yml†L52-L66】【F:.github/workflows/release.yml†L42-L56】
- **Docker Scout**: Quickview/CVE scans are now **non-blocking** (exit-code = false) but still produce SARIF artifacts. 【F:.github/workflows/dev.yml†L74-L99】【F:.github/workflows/release.yml†L78-L103】
- **Trivy**: High/Critical scans are also **non-blocking** (exit-code = 0) and generate SARIF artifacts. 【F:.github/workflows/dev.yml†L107-L131】【F:.github/workflows/release.yml†L121-L146】
- **SARIF upload guard**: Uploads are skipped for fork PRs to avoid permission errors. 【F:.github/workflows/dev.yml†L94-L100】【F:.github/workflows/dev.yml†L146-L152】【F:.github/workflows/release.yml†L108-L114】【F:.github/workflows/release.yml†L160-L166】

**Practical impact:** Scans still provide transparency (SARIF in the Security view) but no longer fail builds on findings, reducing release friction while keeping visibility. 【F:.github/workflows/dev.yml†L74-L131】【F:.github/workflows/release.yml†L78-L146】

### 1.2 Docker Hub Description

- The **Docker Hub description** is no longer updated via a custom API script. It now uses `peter-evans/dockerhub-description@v5`, and the README path is set to `docs/README_DOCKER_HUB.md`. 【F:.github/workflows/release.yml†L180-L193】【F:.github/workflows/instructions.md†L16-L20】

**Practical impact:** The description update is more reliable (no custom API logic), and the Docker Hub README is managed in a clear `docs/` location. 【F:.github/workflows/release.yml†L180-L193】【F:docs/README_DOCKER_HUB.md†L1-L120】

---

## 2) Introduction of the Server Manager (Core Feature)

The major shift is the introduction of a **server manager** under `server_manager/`. It replaces the old entrypoint logic and consolidates **start, stop, update, restart, backup, health checks, logs, cron scheduling, and configuration management** into a modular system.

**Primary goals:** stable operation (PID1 handling), scheduled updates/backups, robust validation, better logging, and controlled automation. 【F:server_manager/manager.sh†L21-L208】

### 2.1 New Manager Entrypoint

- The container entrypoint is now **`tini` + `/opt/enshrouded/manager/manager.sh run`**, making the manager PID1 and ensuring proper signal handling. 【F:Dockerfile†L86-L93】
- The manager provides commands: `run`, `setup`, `start`, `stop`, `restart`, `update`, `backup`, `status`, `logs`. This replaces the prior single-shot startup script. 【F:server_manager/manager.sh†L21-L45】【F:server_manager/manager.sh†L209-L284】

**Detail:** `run` starts PID1 mode, `setup` prepares config/dirs/A2S, `status` shows manager/server/version/player state, and `logs` tails the newest log file. 【F:server_manager/manager.sh†L21-L208】

### 2.2 Lifecycle Handling (Start/Stop/Restart)

- **Start**: Launches the server via Proton, sets `WINEPREFIX`/`STEAM_COMPAT_*`, and writes PID files. 【F:server_manager/lib/server.sh†L97-L133】
- **Stop**: Controlled shutdown with escalation `SIGINT → SIGTERM → SIGKILL` and a timeout. 【F:server_manager/lib/server.sh†L135-L174】
- **Restart**: Optional player-count safety checks plus pre/post hooks. 【F:server_manager/lib/server.sh†L176-L214】

**Detail:** The manager also detects orphaned processes (`pgrep` for `enshrouded_server`) to keep status accurate even if PID files are missing. 【F:server_manager/lib/server.sh†L15-L41】

### 2.3 Auto-Update + Versioning

- The manager checks Steam build IDs, downloads updates via SteamCMD, and stores the build ID in `.current_version`. 【F:server_manager/lib/update.sh†L21-L77】【F:server_manager/lib/update.sh†L79-L160】
- **AUTO_UPDATE** (interval), **AUTO_UPDATE_ON_BOOT**, and **AUTO_RESTART_ON_UPDATE** support automated updates. 【F:server_manager/lib/common.sh†L117-L149】

**Detail:** If Proton files are missing an update is forced; if build IDs are unavailable the manager warns and may skip updates to stay safe. 【F:server_manager/lib/update.sh†L21-L77】

### 2.4 Health Checks & Player Query (A2S)

- **A2S queries** provide player counts, enabling safe update/restart decisions. 【F:server_manager/lib/server.sh†L45-L119】
- **SAFE_MODE**, **UPDATE_CHECK_PLAYERS**, **RESTART_CHECK_PLAYERS** enforce “only when empty” behavior. 【F:server_manager/lib/server.sh†L121-L172】【F:server_manager/lib/common.sh†L150-L162】

**Detail:** A2S uses `python-a2s` (installed via pip if needed), with retry/timeout control to avoid blocking health checks. 【F:server_manager/lib/config.sh†L1700-L1728】【F:server_manager/lib/server.sh†L45-L119】

### 2.5 Logging & Log Streaming

- A **log streamer** tails the latest log file and switches on rotation. 【F:server_manager/lib/logs.sh†L1-L73】
- Controlled via `LOG_TO_STDOUT`, `LOG_TAIL_LINES`, `LOG_POLL_INTERVAL`, `LOG_FILE_PATTERN`. 【F:server_manager/lib/common.sh†L132-L147】【F:server_manager/lib/logs.sh†L1-L73】

**Detail:** Log streaming is optional and can be disabled if host-side logging already handles output. 【F:server_manager/lib/logs.sh†L39-L73】

### 2.6 Backups (Manual + Automated)

- **Backup command** with pre/post hooks, zip archive creation, and retention (`BACKUP_MAX_COUNT`). 【F:server_manager/lib/backup.sh†L1-L113】
- Uses a configurable backup directory (`BACKUP_DIR`). 【F:server_manager/lib/common.sh†L150-L157】

**Detail:** The backup zips the latest save (from the `*-index`), creates a clean index file, and rotates old backups automatically. 【F:server_manager/lib/backup.sh†L38-L113】

### 2.7 Cron Scheduling & Requests

- **Cron scheduling** for updates, backups, and restarts (`UPDATE_CRON`, `BACKUP_CRON`, `RESTART_CRON`). 【F:server_manager/lib/scheduler.sh†L16-L66】
- **Request queue** via files (`update`/`backup`/`restart`) processed by the running manager. 【F:server_manager/lib/scheduler.sh†L68-L88】

**Detail:** Cron only starts if schedules are set, and output is routed to PID1 stdout/stderr. 【F:server_manager/lib/scheduler.sh†L16-L66】

### 2.8 Configuration Management (JSON + ENV)

- The manager manages both `enshrouded_server.json` and **`server_manager.json`** (manager-specific config). 【F:server_manager/lib/config.sh†L234-L352】【F:server_manager/lib/config.sh†L800-L872】
- ENV overrides JSON with validation; invalid values are warned and ignored. 【F:server_manager/lib/config.sh†L352-L444】【F:server_manager/lib/config.sh†L800-L872】
- **User groups** and **game settings** are fully configurable via ENV with validation, defaults, and warnings. 【F:server_manager/lib/config.sh†L1043-L1364】【F:server_manager/lib/config.sh†L1366-L1678】

**Detail:** Defaults are written back into JSON so the resulting config is complete and consistent after startup. 【F:server_manager/lib/config.sh†L874-L997】【F:server_manager/lib/config.sh†L1139-L1341】

---

## 3) New/Structured Environment Variables

With the server manager, the project now exposes a **much broader standardized ENV surface**. Key groups:

### 3.1 Manager Core Variables

- Required UID/GID mapping: **`PUID`** and **`PGID`**, both validated and mandatory. 【F:server_manager/manager.sh†L63-L96】【F:docs/environment.md†L83-L116】
- Paths/runtime: fixed under `/home/steam` and `/var/run/enshrouded`. 【F:server_manager/lib/common.sh†L93-L147】【F:docs/environment.md†L83-L135】
- Logging: `LOG_LEVEL`, `LOG_CONTEXT`, `NO_COLOR`, `UMASK`. 【F:server_manager/lib/common.sh†L28-L80】【F:docs/environment.md†L83-L118】

**Detail:** `PUID/PGID` are strictly validated (non-zero numeric), preventing invalid user mappings. 【F:server_manager/manager.sh†L63-L96】

### 3.2 Update/Restart/Health

- Automated update/restart logic: `AUTO_UPDATE`, `AUTO_UPDATE_INTERVAL`, `AUTO_UPDATE_ON_BOOT`, `AUTO_RESTART`, `AUTO_RESTART_DELAY`, `AUTO_RESTART_MAX_ATTEMPTS`, `AUTO_RESTART_ON_UPDATE`. 【F:server_manager/lib/common.sh†L117-L149】【F:docs/environment.md†L159-L182】
- Player checks & safe mode: `SAFE_MODE`, `UPDATE_CHECK_PLAYERS`, `RESTART_CHECK_PLAYERS`, A2S timeouts. 【F:server_manager/lib/common.sh†L150-L162】【F:docs/environment.md†L169-L182】

**Detail:** `SAFE_MODE=true` skips update/restart when player count is unknown. 【F:server_manager/lib/server.sh†L121-L172】

### 3.3 Logging & Backups

- Log streaming settings (`LOG_TO_STDOUT`, `LOG_TAIL_LINES`, `LOG_POLL_INTERVAL`, `LOG_FILE_PATTERN`) and backup controls (`BACKUP_DIR`, `BACKUP_MAX_COUNT`, hooks). 【F:server_manager/lib/common.sh†L132-L157】【F:docs/environment.md†L186-L213】

**Detail:** `BACKUP_PRE_HOOK`/`BACKUP_POST_HOOK` enable integrations like external uploads after backups. 【F:server_manager/lib/backup.sh†L1-L36】【F:docs/environment.md†L198-L213】

### 3.4 Cron & Hooks

- Scheduling variables (`ENABLE_CRON`, `UPDATE_CRON`, `BACKUP_CRON`, `RESTART_CRON`) and hooks (`BOOTSTRAP_HOOK`, `UPDATE_PRE_HOOK`, `UPDATE_POST_HOOK`, `RESTART_PRE_HOOK`, `RESTART_POST_HOOK`). 【F:server_manager/lib/common.sh†L124-L174】【F:docs/environment.md†L217-L240】

**Detail:** `BOOTSTRAP_HOOK` runs once after setup, useful for initialization steps. 【F:server_manager/lib/config.sh†L1664-L1680】【F:docs/environment.md†L232-L240】

### 3.5 Enshrouded Server Settings (ENSHROUDED_ / ENSHROUDED_GS_)

- Full coverage for server settings and **game settings** and **user groups** via ENV (e.g., `ENSHROUDED_GS_*`, `ENSHROUDED_ROLE_*`). 【F:server_manager/lib/config.sh†L1-L1678】【F:docs/environment.md†L24-L76】

**Detail:** Settings are range-checked (e.g., SlotCount 1–16, QueryPort 1–65535, enum validation). Invalid values are rejected/ignored. 【F:server_manager/lib/config.sh†L1000-L1210】【F:server_manager/lib/config.sh†L1139-L1341】

---

## 4) Docker Image & Entrypoint Architecture

- The Dockerfile now **bundles the server manager** and sets it as entrypoint. 【F:Dockerfile†L70-L93】
- The image is no longer driven by a single entrypoint script; instead, a **persistent manager process** handles updates, restarts, health checks, and cron. 【F:server_manager/manager.sh†L121-L208】

**Detail:** The manager starts as root, applies UID/GID mapping for the `steam` user, then re-execs as `steam` for safer runtime permissions. 【F:server_manager/manager.sh†L63-L155】

### 4.1 Dockerfile Stack & Runtime Changes (since v1.2.1)

- **New multi-stage build**: Proton-GE is prepared in a builder stage and copied into runtime, replacing the old WineHQ install from v1.2.1. 【F:Dockerfile†L1-L67】【F:Dockerfile†L70-L75】
- **Additional runtime tools**: `cron`, `jq`, `python3`, `python3-pip`, `zip`, etc. are installed to enable manager features (A2S, config, backups, scheduling). 【F:Dockerfile†L30-L49】
- **New Dockerfile defaults**: `STEAM_COMPAT_CLIENT_INSTALL_PATH`, `STEAM_COMPAT_DATA_PATH`, `WINEPREFIX` are now standard for Proton/Steam. 【F:Dockerfile†L20-L28】
- **Entrypoint migration**: The old `entrypoint.sh` (auto-config + Wine start) was removed; all responsibilities now live in the manager. 【F:Dockerfile†L86-L93】【F:server_manager/manager.sh†L21-L208】

---

## 5) Documentation

- **New document**: `docs/environment.md` lists **all environment variables** (Dockerfile, manager, server settings, updates/backups/logging). 【F:docs/environment.md†L1-L240】
- **Docker Hub README** moved to `docs/README_DOCKER_HUB.md` and is wired into the release workflow. 【F:docs/README_DOCKER_HUB.md†L1-L120】【F:.github/workflows/release.yml†L180-L193】
- The main README was expanded/updated (e.g., PUID/PGID setup, improved Quickstart). 【F:README.md†L159-L236】

**Detail:** Quickstart now uses `PUID/PGID` instead of older variables, aligning with manager design. 【F:README.md†L187-L236】

### 5.1 Documentation Impact for Operators

- **UID/GID change**: Quickstart explicitly references `PUID/PGID` (instead of `ENSHROUDED_USER_ID`/`ENSHROUDED_GROUP_ID`). This matches manager user-mapping logic. 【F:README.md†L187-L236】【F:server_manager/manager.sh†L63-L96】
- **ENV reference**: `docs/environment.md` is now the single source of truth for ENV variables, validations, and defaults. 【F:docs/environment.md†L1-L240】【F:server_manager/lib/config.sh†L352-L444】

---

## 6) Summary

Since v1.2.1, the project has evolved from a one-shot startup script to a **full-featured, configurable server manager**. Updates, backups, health checks, cron scheduling, log streaming, and granular ENV-based configuration make deployments more stable, reproducible, and maintainable. CI workflows are more secure and resilient against fork-PR limitations. 【F:server_manager/manager.sh†L21-L208】【F:server_manager/lib/update.sh†L1-L160】【F:server_manager/lib/backup.sh†L1-L113】【F:.github/workflows/dev.yml†L14-L152】
