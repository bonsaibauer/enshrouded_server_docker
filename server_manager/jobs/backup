#!/usr/bin/env bash

SCRIPT_DIR="$(cd -P "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" >/dev/null 2>&1 && pwd)"
# shellcheck source=server_manager/jobs/profile
. "${SCRIPT_DIR}/profile"

enshrouded_config_file="${install_path}/enshrouded_server.json"
enshrouded_backup_pidfile="${ENSHROUDED_BACKUP_PIDFILE:-/var/run/enshrouded/backup.pid}"

enshrouded_get_text() {
  local path
  path="$1"
  if [[ ! -f "$enshrouded_config_file" ]]; then
    echo ""
    return 0
  fi
  jq -r "$path | if . == null then empty else tostring end" "$enshrouded_config_file" 2>/dev/null || true
}


load_runtime_values() {
  require_cmd jq
  require_cmd zip
  require_cmd tar

  SAVEFILE_NAME="$(resolve_from_env_or_manager "SAVEFILE_NAME" ".savefileName" "savegame")"
  BACKUP_DIR="$(resolve_from_env_or_manager "BACKUP_DIR" ".backupDir" "backups")"
  BACKUP_MAX_COUNT="$(resolve_from_env_or_manager "BACKUP_MAX_COUNT" ".backupMaxCount" "0")"
  BACKUP_PRE_HOOK="$(resolve_from_env_or_manager "BACKUP_PRE_HOOK" ".backupPreHook" "")"
  BACKUP_POST_HOOK="$(resolve_from_env_or_manager "BACKUP_POST_HOOK" ".backupPostHook" "")"
  BACKUP_SCHEDULED_INCLUDE_ENSHROUDED_CONFIG="$(resolve_from_env_or_manager "BACKUP_SCHEDULED_INCLUDE_ENSHROUDED_CONFIG" ".backupScheduledIncludeEnshroudedConfig" "true")"
  BACKUP_SCHEDULED_INCLUDE_SERVER_MANAGER_CONFIG="$(resolve_from_env_or_manager "BACKUP_SCHEDULED_INCLUDE_SERVER_MANAGER_CONFIG" ".backupScheduledIncludeServerManagerConfig" "true")"

  ENSHROUDED_SAVE_DIR="${ENSHROUDED_SAVE_DIR:-$(enshrouded_get_text ".saveDirectory")}"
  if [[ -z "$ENSHROUDED_SAVE_DIR" ]]; then
    ENSHROUDED_SAVE_DIR="./savegame"
  fi
}

pidfile="$enshrouded_backup_pidfile"

mode="scheduled"
include_savegame=""
include_enshrouded_config=""
include_manager_config=""
run_cleanup=""
stage_dir=""
backup_file=""

to_bool() {
  case "$(echo "${1-}" | tr '[:upper:]' '[:lower:]' | xargs)" in
    "") echo "" ;;
    true|false) echo "$(echo "${1-}" | tr '[:upper:]' '[:lower:]' | xargs)" ;;
    *) echo "" ;;
  esac
}

normalize_bool_with_default() {
  local value default normalized
  value="${1-}"
  default="${2-}"
  normalized="$(to_bool "$value")"
  if [[ -n "$normalized" ]]; then
    echo "$normalized"
  else
    echo "$default"
  fi
}

cleanup_on_exit() {
  rm -f "$pidfile" 2>/dev/null || true
  [[ -n "$stage_dir" ]] && rm -rf "$stage_dir" 2>/dev/null || true
}

trap cleanup_on_exit EXIT
trap 'exit 1' SIGINT SIGTERM

usage() {
  cat <<'EOF'
Usage:
  backup [--mode scheduled|manual]
         [--savegame true|false]
         [--enshrouded-config true|false]
         [--manager-config true|false]
         [--cleanup true|false]
EOF
}

parse_args() {
  local parsed_bool
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --mode)
        mode="${2-}"
        [[ -n "$mode" ]] || fatal "Missing value for --mode"
        shift 2
        ;;
      --savegame)
        parsed_bool="$(to_bool "${2-}")"
        [[ -n "$parsed_bool" ]] || fatal "Invalid value for --savegame (expected true|false)"
        include_savegame="$parsed_bool"
        shift 2
        ;;
      --enshrouded-config)
        parsed_bool="$(to_bool "${2-}")"
        [[ -n "$parsed_bool" ]] || fatal "Invalid value for --enshrouded-config (expected true|false)"
        include_enshrouded_config="$parsed_bool"
        shift 2
        ;;
      --manager-config)
        parsed_bool="$(to_bool "${2-}")"
        [[ -n "$parsed_bool" ]] || fatal "Invalid value for --manager-config (expected true|false)"
        include_manager_config="$parsed_bool"
        shift 2
        ;;
      --cleanup)
        parsed_bool="$(to_bool "${2-}")"
        [[ -n "$parsed_bool" ]] || fatal "Invalid value for --cleanup (expected true|false)"
        run_cleanup="$parsed_bool"
        shift 2
        ;;
      --help|-h)
        usage
        exit 0
        ;;
      *)
        fatal "Unknown argument: $1"
        ;;
    esac
  done
}

acquire_lock() {
  local old_pid
  if [[ -f "$pidfile" ]]; then
    old_pid="$(cat "$pidfile" 2>/dev/null || true)"
    if [[ "$old_pid" =~ ^[0-9]+$ ]] && kill -0 "$old_pid" 2>/dev/null; then
      fatal "Backup process already running with PID $old_pid"
    fi
    warn "Removing stale backup PID file: $pidfile"
    rm -f "$pidfile" 2>/dev/null || true
  fi
  echo "$$" >"$pidfile" || fatal "Failed to create PID file: $pidfile"
}

save_dir_resolve() {
  local dir
  dir="${ENSHROUDED_SAVE_DIR:-./savegame}"
  if [[ "$dir" == /* ]]; then
    printf "%s" "$dir"
  else
    printf "%s/%s" "$install_path" "$dir"
  fi
}

copy_tree() {
  local src dst
  src="$1"
  dst="$2"
  mkdir -p "$dst" 2>/dev/null || true
  (cd "$src" && tar -cf - .) | (cd "$dst" && tar -xf -)
}

resolve_mode_defaults() {
  local mode_lc
  mode_lc="$(echo "$mode" | tr '[:upper:]' '[:lower:]' | xargs)"
  case "$mode_lc" in
    scheduled)
      mode="scheduled"
      include_savegame="${include_savegame:-true}"
      include_enshrouded_config="${include_enshrouded_config:-${BACKUP_SCHEDULED_INCLUDE_ENSHROUDED_CONFIG:-true}}"
      include_manager_config="${include_manager_config:-${BACKUP_SCHEDULED_INCLUDE_SERVER_MANAGER_CONFIG:-true}}"
      run_cleanup="${run_cleanup:-true}"
      ;;
    manual)
      mode="manual"
      include_savegame="${include_savegame:-true}"
      include_enshrouded_config="${include_enshrouded_config:-true}"
      include_manager_config="${include_manager_config:-true}"
      run_cleanup="${run_cleanup:-false}"
      ;;
    *)
      fatal "Unsupported backup mode: $mode"
      ;;
  esac

  include_savegame="$(normalize_bool_with_default "$include_savegame" "false")"
  include_enshrouded_config="$(normalize_bool_with_default "$include_enshrouded_config" "false")"
  include_manager_config="$(normalize_bool_with_default "$include_manager_config" "false")"
  run_cleanup="$(normalize_bool_with_default "$run_cleanup" "false")"
}

prepare_stage_content() {
  local save_dir config_dir ens_config manager_config
  local added_savegame added_enshrouded added_manager

  save_dir="$(save_dir_resolve)"
  ens_config="${install_path}/enshrouded_server.json"
  manager_config="$(manager_config_path)"
  config_dir="${stage_dir}/config"
  added_savegame="false"
  added_enshrouded="false"
  added_manager="false"

  if [[ "$include_savegame" == "true" ]]; then
    if [[ -d "$save_dir" ]]; then
      info "Including savegame directory: $save_dir"
      copy_tree "$save_dir" "${stage_dir}/savegame"
      added_savegame="true"
    else
      warn "Savegame directory not found, skipping: $save_dir"
    fi
  fi

  if [[ "$include_enshrouded_config" == "true" ]]; then
    if [[ -f "$ens_config" ]]; then
      mkdir -p "$config_dir" 2>/dev/null || true
      cp "$ens_config" "${config_dir}/enshrouded_server.json"
      added_enshrouded="true"
    else
      warn "Enshrouded config not found, skipping: $ens_config"
    fi
  fi

  if [[ "$include_manager_config" == "true" ]]; then
    if [[ -f "$manager_config" ]]; then
      mkdir -p "$config_dir" 2>/dev/null || true
      cp "$manager_config" "${config_dir}/server_manager.json"
      added_manager="true"
    else
      warn "Server Manager config not found, skipping: $manager_config"
    fi
  fi

  if [[ "$added_savegame" != "true" && "$added_enshrouded" != "true" && "$added_manager" != "true" ]]; then
    fatal "Nothing to backup (all selected sources missing)"
  fi

  jq -n \
    --arg mode "$mode" \
    --arg createdAt "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
    --arg saveDirectory "$save_dir" \
    --arg savefileName "$SAVEFILE_NAME" \
    --argjson includeSavegame "$added_savegame" \
    --argjson includeEnshroudedConfig "$added_enshrouded" \
    --argjson includeServerManagerConfig "$added_manager" \
    '{
      version: 1,
      mode: $mode,
      createdAt: $createdAt,
      saveDirectory: $saveDirectory,
      savefileName: $savefileName,
      includes: {
        savegame: $includeSavegame,
        enshroudedConfig: $includeEnshroudedConfig,
        serverManagerConfig: $includeServerManagerConfig
      }
    }' >"${stage_dir}/manifest.json" || fatal "Failed to write manifest.json"
}

create_zip() {
  local backup_root target_dir ts n
  backup_root="$(backup_dir_resolve)"
  target_dir="${backup_root}/${mode}"

  mkdir -p "$target_dir" 2>/dev/null || true
  chmod 700 "$backup_root" "$target_dir" 2>/dev/null || true
  chown enshrouded:enshrouded "$backup_root" "$target_dir" 2>/dev/null || true

  ts="$(date +%Y-%m-%d_%H-%M-%S)"
  backup_file="${target_dir}/${ts}-${mode}-backup.zip"
  if [[ -e "$backup_file" ]]; then
    n=1
    while [[ -e "${target_dir}/${ts}-${mode}-backup-${n}.zip" ]]; do
      n=$((n + 1))
    done
    backup_file="${target_dir}/${ts}-${mode}-backup-${n}.zip"
  fi

  info "Creating backup zip: $backup_file"
  (cd "$stage_dir" && zip -qr "$backup_file" .) || fatal "Failed to create zip archive"
  chmod 600 "$backup_file" 2>/dev/null || true
  chown enshrouded:enshrouded "$backup_file" 2>/dev/null || true
}

cleanup_old_scheduled_backups() {
  local keep target_dir to_delete
  if [[ "$mode" != "scheduled" || "$run_cleanup" != "true" ]]; then
    return 0
  fi

  keep="${BACKUP_MAX_COUNT:-0}"
  if ! [[ "$keep" =~ ^[0-9]+$ ]]; then
    warn "Invalid BACKUP_MAX_COUNT value: $keep (skipping cleanup)"
    return 0
  fi
  if [[ "$keep" -eq 0 ]]; then
    info "Skipping cleanup (BACKUP_MAX_COUNT=0)"
    return 0
  fi

  target_dir="$(backup_dir_resolve)/scheduled"
  to_delete="$(find "$target_dir" -maxdepth 1 -type f -name "*.zip" -printf '%T@\t%p\n' 2>/dev/null \
    | sort -n \
    | head -n "-$keep" \
    | cut -f2-)"

  if [[ -n "$to_delete" ]]; then
    info "Removing old scheduled backups (keep=$keep)"
    echo "$to_delete" | xargs -r rm -f --
  fi
}

main() {
  parse_args "$@"
  load_runtime_values
  resolve_mode_defaults
  info "Running backup job (mode=${mode}, savegame=${include_savegame}, enshrouded_config=${include_enshrouded_config}, manager_config=${include_manager_config}, cleanup=${run_cleanup})"
  acquire_lock

  export BACKUP_MODE="$mode"
  "${SCRIPT_DIR}/server" hook-run --name "backup pre" --command "${BACKUP_PRE_HOOK:-}"

  stage_dir="$(mktemp -d)"
  prepare_stage_content
  create_zip
  cleanup_old_scheduled_backups

  "${SCRIPT_DIR}/server" hook-run --name "backup post" --command "${BACKUP_POST_HOOK:-}"

  info "Backup job complete: $backup_file"
}

main "$@"
