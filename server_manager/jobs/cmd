#!/bin/bash

set -euo pipefail

SUPERVISORCTL_BIN="${SUPERVISORCTL_BIN:-supervisorctl}"

SCRIPT_DIR="$(cd -P "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" >/dev/null 2>&1 && pwd)"
# shellcheck source=server_manager/jobs/profile
. "${SCRIPT_DIR}/profile"

usage() {
  cat <<'EOF'
Usage:
  docker exec CONTAINER_NAME cmd <command> [args...]

Commands:
  hook-run       Internal: execute a named hook command
  status         Show supervisor program status
  menu           Start interactive Server Manager menu
  start          Start server
  stop           Stop server
  restart        Restart server
  update         Trigger updater
  backup         Trigger backup job (requires args, e.g. --mode manual --savegame true ...)
  restore-backup Trigger restore-backup job (requires args, e.g. --zip ... --restore ...)
  profile        Trigger profile job (requires args, e.g. --target ... --action ...)
  password-view  Show user group rights and passwords from enshrouded_server.json
  env-validation Run ENV validation job
  scheduled-restart
                 Trigger restart job
  force-update   Trigger updater in force mode
  bootstrap      Trigger bootstrap
  cron           Manage cron sync/service (e.g. --sync, --service restart)
  help           Show this help
EOF
}

run_supervisorctl() {
  "$SUPERVISORCTL_BIN" "$@"
}

run_job_script() {
  local script
  script="$1"
  shift || true
  "${SCRIPT_DIR}/${script}" "$@"
}

run_job_or_supervisor_start() {
  local script program
  script="$1"
  program="$2"
  shift 2
  if [[ "$#" -gt 0 ]]; then
    run_job_script "$script" "$@"
  else
    run_supervisorctl start "$program"
  fi
}

require_no_args() {
  local cmd_name
  cmd_name="$1"
  shift || true
  if [[ "$#" -gt 0 ]]; then
    echo "$cmd_name does not accept arguments" >&2
    exit 1
  fi
}

run_hook() {
  local hook_name hook_cmd
  hook_name="$1"
  hook_cmd="$2"
  if [[ -z "$hook_cmd" ]]; then
    return 0
  fi
  echo "INFO - Running ${hook_name} hook: $hook_cmd"
  eval "$hook_cmd"
}

run_hook_command() {
  local hook_name hook_cmd
  hook_name=""
  hook_cmd=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --name)
        hook_name="${2-}"
        [[ -n "$hook_name" ]] || { echo "Missing value for --name" >&2; exit 1; }
        shift 2
        ;;
      --command)
        hook_cmd="${2-}"
        shift 2
        ;;
      *)
        echo "Unknown argument for hook-run: $1" >&2
        exit 1
        ;;
    esac
  done
  [[ -n "$hook_name" ]] || { echo "Missing --name" >&2; exit 1; }
  run_hook "$hook_name" "$hook_cmd"
}

load_cmd_hooks() {
  CMD_PRE_HOOK="$(resolve_from_env_or_manager "CMD_PRE_HOOK" ".cmdPreHook" "")"
  CMD_POST_HOOK="$(resolve_from_env_or_manager "CMD_POST_HOOK" ".cmdPostHook" "")"
}

run_cmd_command() {
  local cmd
  cmd="$1"
  shift || true
  case "$cmd" in
    hook-run)
      run_hook_command "$@"
      ;;
    status)
      require_no_args "$cmd" "$@"
      run_supervisorctl status
      ;;
    menu)
      run_job_script "menu" "$@"
      ;;
    start)
      require_no_args "$cmd" "$@"
      run_supervisorctl start server
      ;;
    stop)
      require_no_args "$cmd" "$@"
      run_supervisorctl stop server
      ;;
    restart)
      if [[ "$#" -gt 0 ]]; then
        run_job_script "restart" "$@"
      else
        run_supervisorctl restart server
      fi
      ;;
    update)
      run_job_or_supervisor_start "updater" "updater" "$@"
      ;;
    backup)
      if [[ "$#" -eq 0 ]]; then
        echo "backup requires args (example: cmd backup --mode manual --savegame true --enshrouded-config true --manager-config true --cleanup false)" >&2
        exit 1
      fi
      run_job_script "backup" "$@"
      ;;
    restore-backup)
      if [[ "$#" -eq 0 ]]; then
        echo "restore-backup requires args (example: cmd restore-backup --zip <path> --restore all --safety-backup false)" >&2
        exit 1
      fi
      run_job_script "restore-backup" "$@"
      ;;
    profile)
      if [[ "$#" -eq 0 ]]; then
        echo "profile requires args (example: cmd profile --target manager --action reset --create-backup true)" >&2
        exit 1
      fi
      run_job_script "profile" "$@"
      ;;
    password-view)
      run_job_script "password-view" "$@"
      ;;
    env-validation)
      run_job_or_supervisor_start "env-validation" "env-validation" "$@"
      ;;
    scheduled-restart)
      run_job_or_supervisor_start "restart" "restart" "$@"
      ;;
    force-update)
      run_job_script "updater" --force "$@"
      ;;
    bootstrap)
      run_job_or_supervisor_start "bootstrap" "bootstrap" "$@"
      ;;
    cron)
      run_job_script "cron" "$@"
      ;;
    help|--help|-h)
      usage
      ;;
    *)
      echo "Unknown command: $cmd" >&2
      usage >&2
      exit 1
      ;;
  esac
}

main() {
  local cmd
  cmd="${1:-help}"
  shift || true

  if [[ "$cmd" == "help" || "$cmd" == "--help" || "$cmd" == "-h" || "$cmd" == "hook-run" ]]; then
    run_cmd_command "$cmd" "$@"
    return 0
  fi

  load_cmd_hooks
  run_hook "cmd pre" "${CMD_PRE_HOOK:-}"
  run_cmd_command "$cmd" "$@"
  run_hook "cmd post" "${CMD_POST_HOOK:-}"
}

main "$@"
