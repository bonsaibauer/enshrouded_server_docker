#!/bin/bash
SCRIPT_DIR="$(cd -P "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" >/dev/null 2>&1 && pwd)"
# shellcheck source=server_manager/jobs/env-validation
. "${SCRIPT_DIR}/env-validation"

enshrouded_server_pid=-1
timeout=60
kill_signal=INT
WAIT_FOR_DOWNLOAD="true"
enshrouded_server=""
SERVER_ACTION="run"
CHECK_PLAYERS="true"
SERVER_QUERY_PORT=""

usage() {
  cat <<'EOF'
Usage:
  server [--wait-download|--no-wait-download]
  server --stop-safe [--shutdown-timeout <seconds>]
  server --players-check [--check-players true|false] [--query-port <port>]
EOF
}

parse_args() {
  local parsed_bool
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --wait-download)
        WAIT_FOR_DOWNLOAD="true"
        shift
        ;;
      --no-wait-download)
        WAIT_FOR_DOWNLOAD="false"
        shift
        ;;
      --shutdown-timeout)
        timeout="${2-}"
        if [[ -z "$timeout" || ! "$timeout" =~ ^[0-9]+$ || "$timeout" -le 0 ]]; then
          fatal "Invalid --shutdown-timeout value: ${2-}"
        fi
        shift 2
        ;;
      --stop-safe)
        SERVER_ACTION="stop-safe"
        shift
        ;;
      --players-check)
        SERVER_ACTION="players-check"
        shift
        ;;
      --check-players)
        parsed_bool="$(parse_bool_arg "${2-}")"
        [[ -n "$parsed_bool" ]] || fatal "Invalid value for --check-players (expected true|false)"
        CHECK_PLAYERS="$parsed_bool"
        shift 2
        ;;
      --query-port)
        SERVER_QUERY_PORT="${2-}"
        if [[ -z "$SERVER_QUERY_PORT" || ! "$SERVER_QUERY_PORT" =~ ^[0-9]+$ || "$SERVER_QUERY_PORT" -le 0 ]]; then
          fatal "Invalid --query-port value: ${2-}"
        fi
        shift 2
        ;;
      --help|-h)
        usage
        exit 0
        ;;
      *)
        fatal "Unknown argument: $1"
        ;;
    esac
  done
}

wait_for_server_download() {
  while :; do
    if [ -f "$enshrouded_server" ]; then
      break
    else
      debug "enshrouded Server is not yet downloaded - waiting"
      sleep 7
    fi
  done
}

run_server_process() {
  info "Running server"
  debug "Server config ServerName:${ENSHROUDED_NAME} - ServerQueryPort:${ENSHROUDED_QUERY_PORT}"

  export WINEDEBUG=$WINEDEBUG
  export STEAM_COMPAT_CLIENT_INSTALL_PATH="/home/enshrouded/.steam/steam"
  export STEAM_COMPAT_DATA_PATH="$install_path/steamapps/compatdata/$steam_app_id"
  export WINEPREFIX="${STEAM_COMPAT_DATA_PATH}/pfx"
  export WINETRICKS="/usr/local/bin/winetricks"

  chmod +x "$enshrouded_server"
  proton runinprefix "$enshrouded_server" &
  enshrouded_server_pid=$!
  echo $enshrouded_server_pid >"$enshrouded_server_pidfile"

  wait $enshrouded_server_pid
  debug "server with PID $enshrouded_server_pid stopped"

  cleanup_wine
  "${SCRIPT_DIR}/cmd" hook-run --name "server post" --command "${SERVER_POST_HOOK:-}"
  info "Shutdown complete"
  exit 0
}

cleanup_wine() {
  debug "cleanup wineserver"
  WINEPREFIX="$install_path/steamapps/compatdata/$steam_app_id/pfx/" /usr/local/bin/files/bin/wineserver -k
  clearLock "$enshrouded_server_pidfile"
}

shutdown() {
  debug "Received signal to shut down server"
  if [ $enshrouded_server_pid -eq -1 ]; then
    debug "enshrouded server is not running yet - aborting startup"
    exit
  fi
  info "Shutting down enshrouded server with PID $enshrouded_server_pid"
  kill -$kill_signal $(ps axww | grep '\\[e]nshrouded_server' | awk '{print $1}')
  shutdown_timeout=$(($(date +%s) + timeout))
  while [ -d "/proc/$enshrouded_server_pid" ]; do
    if [ "$(date +%s)" -gt $shutdown_timeout ]; then
      shutdown_timeout=$(($(date +%s) + timeout))
      warn "Timeout while waiting for server to shut down - sending SIG$kill_signal to PID $enshrouded_server_pid"
      kill -$kill_signal $enshrouded_server_pid
      case "$kill_signal" in
      INT)
        kill_signal=TERM
        ;;
      *)
        kill_signal=KILL
        ;;
      esac
    fi
    debug "Waiting for enshrouded Server with PID $enshrouded_server_pid to shut down"
    sleep 6
  done
}

server_stop_safe() {
  local deadline now
  if ! is_supervisor_running "server"; then
    return 0
  fi

  info "Stopping server"
  supervisorctl stop server >/dev/null 2>&1 || true

  deadline=$(( $(date +%s) + timeout ))
  while is_supervisor_running "server"; do
    now="$(date +%s)"
    if [[ "$now" -ge "$deadline" ]]; then
      fatal "Timeout while stopping server"
    fi
    sleep 1
  done
}

server_players_check() {
  local port connected_players
  if [[ "$CHECK_PLAYERS" == "false" ]]; then
    return 0
  fi

  port="${SERVER_QUERY_PORT:-${ENSHROUDED_QUERY_PORT:-15637}}"
  if [[ -z "$port" || ! "$port" =~ ^[0-9]+$ || "$port" -le 0 ]]; then
    fatal "Invalid query port: ${port:-<empty>}"
  fi

  connected_players="$(python3 -c "
try:
    import a2s
    print(len(a2s.players(('127.0.0.1',$port))))
except Exception:
    print('null')
")"

  debug "[players-check] connected_players: $connected_players"
  if [[ -n "$connected_players" && "$connected_players" != "null" && "$connected_players" -gt 0 ]]; then
    return 1
  fi
  return 0
}

main() {
  parse_args "$@"

  case "$SERVER_ACTION" in
    stop-safe)
      server_stop_safe
      return 0
      ;;
    players-check)
      server_players_check
      return $?
      ;;
  esac

  init_runtime_env
  cd "$install_path" || fatal "Could not cd $install_path"
  enshrouded_server="$install_path/$enshrouded_binary_path"
  "${SCRIPT_DIR}/cmd" hook-run --name "server pre" --command "${SERVER_PRE_HOOK:-}"
  if [[ "$WAIT_FOR_DOWNLOAD" == "true" ]]; then
    wait_for_server_download
  elif [[ ! -f "$enshrouded_server" ]]; then
    fatal "Server binary not found: $enshrouded_server (use --wait-download)"
  fi
  run_server_process
}

trap shutdown SIGINT SIGTERM
main "$@"


