#!/bin/bash
resolve_script_dir() {
  local src dir
  src="${BASH_SOURCE[0]}"
  while [[ -h "$src" ]]; do
    dir="$(cd -P "$(dirname "$src")" >/dev/null 2>&1 && pwd)"
    src="$(readlink "$src")"
    [[ "$src" != /* ]] && src="$dir/$src"
  done
  cd -P "$(dirname "$src")" >/dev/null 2>&1 && pwd
}

SCRIPT_DIR="$(resolve_script_dir)"
# shellcheck source=server_manager/jobs/env-validation
. "${SCRIPT_DIR}/env-validation"

init_runtime_env

enshrouded_server_pid=-1
timeout=60
kill_signal=INT

cd "$install_path" || fatal "Could not cd $install_path"
enshrouded_server="$install_path/$enshrouded_binary_path"

run_server_hook() {
  local hook_name hook_cmd
  hook_name="$1"
  hook_cmd="$2"
  if [[ -z "$hook_cmd" ]]; then
    return 0
  fi
  info "Running ${hook_name} hook: $hook_cmd"
  eval "$hook_cmd"
}

main() {
  run_server_hook "server pre" "${SERVER_PRE_HOOK:-}"
  waitForServerDownload
  runServer
}

waitForServerDownload() {
  while :; do
    if [ -f "$enshrouded_server" ]; then
      break
    else
      debug "enshrouded Server is not yet downloaded - waiting"
      sleep 7
    fi
  done
}

runServer() {
  info "Running server"
  debug "Server config ServerName:${ENSHROUDED_NAME} - ServerQueryPort:${ENSHROUDED_QUERY_PORT}"

  export WINEDEBUG=$WINEDEBUG
  export STEAM_COMPAT_CLIENT_INSTALL_PATH="/home/enshrouded/.steam/steam"
  export STEAM_COMPAT_DATA_PATH="$install_path/steamapps/compatdata/$steam_app_id"
  export WINEPREFIX="${STEAM_COMPAT_DATA_PATH}/pfx"
  export WINETRICKS="/usr/local/bin/winetricks"

  chmod +x "$enshrouded_server"
  proton runinprefix "$enshrouded_server" &
  enshrouded_server_pid=$!
  echo $enshrouded_server_pid >"$enshrouded_server_pidfile"

  wait $enshrouded_server_pid
  debug "server with PID $enshrouded_server_pid stopped"

  cleanup
  run_server_hook "server post" "${SERVER_POST_HOOK:-}"
  info "Shutdown complete"
  exit 0
}

cleanup() {
  debug "cleanup wineserver"
  WINEPREFIX="$install_path/steamapps/compatdata/$steam_app_id/pfx/" /usr/local/bin/files/bin/wineserver -k
  clearLock "$enshrouded_server_pidfile"
}

shutdown() {
  debug "Received signal to shut down server"
  if [ $enshrouded_server_pid -eq -1 ]; then
    debug "enshrouded server is not running yet - aborting startup"
    exit
  fi
  info "Shutting down enshrouded server with PID $enshrouded_server_pid"
  kill -$kill_signal $(ps axww | grep '\\[e]nshrouded_server' | awk '{print $1}')
  shutdown_timeout=$(($(date +%s) + timeout))
  while [ -d "/proc/$enshrouded_server_pid" ]; do
    if [ "$(date +%s)" -gt $shutdown_timeout ]; then
      shutdown_timeout=$(($(date +%s) + timeout))
      warn "Timeout while waiting for server to shut down - sending SIG$kill_signal to PID $enshrouded_server_pid"
      kill -$kill_signal $enshrouded_server_pid
      case "$kill_signal" in
      INT)
        kill_signal=TERM
        ;;
      *)
        kill_signal=KILL
        ;;
      esac
    fi
    debug "Waiting for enshrouded Server with PID $enshrouded_server_pid to shut down"
    sleep 6
  done
}

trap shutdown SIGINT SIGTERM
main "$@"


