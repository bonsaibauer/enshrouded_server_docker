#!/bin/bash
. "$(dirname "$0")/../shared/common"
. "$(dirname "$0")/../shared/profile"
. "$(dirname "$0")/../shared/env"
init_runtime_env

main() {
  local profile source_profile config_file
  local old_enshrouded old_env_manager old_env_enshrouded

  info "Stopping enshrouded server"
  supervisorctl stop enshrouded-server || true

  profile="$(manager_profile_resolve)"
  source_profile="$(manager_profile_path "$profile")"
  config_file="$(manager_config_path)"

  # Preserve persisted profile selectors across a full config replacement.
  old_enshrouded="$(profiles_config_get "enshrouded")"
  old_env_manager="$(profiles_env_get "MANAGER_PROFILE")"
  old_env_enshrouded="$(profiles_env_get "EN_PROFILE")"

  if [[ ! -f "$source_profile" ]]; then
    fatal "Server Manager profile not found: $source_profile"
  fi
  if ! jq -e '.' "$source_profile" >/dev/null 2>&1; then
    fatal "Invalid JSON in server manager profile: $source_profile"
  fi

  backup_config_file "$config_file" "server_manager" || true
  cp "$source_profile" "$config_file"
  chmod 600 "$config_file" 2>/dev/null || true
  info "Server Manager config reset from profile: $profile"

  # Ensure profile selection keys exist (and migrate legacy schema if needed).
  profiles_ensure_schema || true

  # Restore selectors into the new config file (single source of truth: server_manager.json).
  profiles_config_set "manager" "$profile" || true
  if [[ -n "$old_enshrouded" ]]; then
    profiles_config_set "enshrouded" "$old_enshrouded" || true
  else
    profiles_config_set "enshrouded" "$(enshrouded_profile_resolve)" || true
  fi
  profiles_env_set_if_missing "MANAGER_PROFILE" "$old_env_manager" || true
  profiles_env_set_if_missing "EN_PROFILE" "$old_env_enshrouded" || true

  info "Stop container for a clean start"
  kill -INT "$(cat /var/run/supervisord.pid)"
}

main
