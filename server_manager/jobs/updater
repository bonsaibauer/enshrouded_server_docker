#!/bin/bash
SCRIPT_DIR="$(cd -P "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" >/dev/null 2>&1 && pwd)"
# shellcheck source=server_manager/jobs/env-validation
. "${SCRIPT_DIR}/env-validation"

pidfile="$enshrouded_updater_pidfile"
latest_version="-1"
FORCE_UPDATE="false"
CHECK_ONLY="false"
NO_PLAYER_CHECK="false"

debug() { [[ "${LOG_LEVEL:-40}" -ge 50 ]] && echo "DEBUG - $*" || true; }

checkRunning() {
  is_supervisor_running "$1"
}

checkLock() {
  local lock_file pid
  lock_file="$1"
  [[ -n "$lock_file" ]] || return 0
  [[ -f "$lock_file" ]] || return 0
  pid="$(cat "$lock_file" 2>/dev/null || true)"
  if [[ -n "$pid" ]] && [[ "$pid" =~ ^[0-9]+$ ]] && [[ -d "/proc/$pid" ]]; then
    fatal "Lock active: $lock_file (pid=$pid)"
  fi
  rm -f "$lock_file" 2>/dev/null || true
  return 0
}

clearLock() {
  local lock_file
  lock_file="$1"
  [[ -n "$lock_file" ]] || return 0
  rm -f "$lock_file" 2>/dev/null || true
  return 0
}

usage() {
  cat <<'EOF'
Usage:
  updater [--force] [--check-only] [--no-player-check]
EOF
}

parse_args() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --force)
        FORCE_UPDATE="true"
        shift
        ;;
      --check-only)
        CHECK_ONLY="true"
        shift
        ;;
      --no-player-check)
        NO_PLAYER_CHECK="true"
        shift
        ;;
      --help|-h)
        usage
        exit 0
        ;;
      *)
        fatal "Unknown argument: $1"
        ;;
    esac
  done
}

update() {
  local players_check_rc
  if [[ -f "$pidfile" ]]; then
    info "Found existing PID file - checking process"
    checkLock "$pidfile"
  fi

  trap shutdown SIGINT SIGTERM

  if ! check_for_updates; then
    if ! checkRunning "server"; then
      info "Enshrouded server is not running - starting"
      "${SCRIPT_DIR}/server" start
    fi
    return 0
  fi

  "${SCRIPT_DIR}/server" guard-run core_ready -- "${SCRIPT_DIR}/server" --players-check --check-players "${UPDATE_CHECK_PLAYERS:-true}" --query-port "${ENSHROUDED_QUERY_PORT:-15637}"
  players_check_rc=$?
  case "$players_check_rc" in
    0)
      ;;
    10)
      warn "Enshrouded server is not empty - update will not be performed"
      return 0
      ;;
    *)
      fatal "players-check failed (rc=$players_check_rc)"
      ;;
  esac

  run_update_flow &
  enshrouded_updater_pid=$!
  echo "$enshrouded_updater_pid" >"$pidfile"
  wait "$enshrouded_updater_pid"
}

run_update_flow() {
  "${SCRIPT_DIR}/server" hook-run --name "update pre" --command "${UPDATE_PRE_HOOK:-}"
  if checkRunning "server"; then
    "${SCRIPT_DIR}/server" stop
  fi

  verify_cpu_mhz
  if ! download_enshrouded; then
    warn "Download of Enshrouded server failed - retry"
    debug "Removing $install_path/$steamapp_path"
    rm -rf "$install_path/$steamapp_path"

    if ! download_enshrouded; then
      warn "Download of Enshrouded server failed - aborting update"
      "${SCRIPT_DIR}/server" start
      clearLock "$pidfile"
      return 1
    fi
  fi

  set_current_version
  "${SCRIPT_DIR}/server" start
  "${SCRIPT_DIR}/server" hook-run --name "update post" --command "${UPDATE_POST_HOOK:-}"
  clearLock "$pidfile"
}

# This works around the `Unable to determine CPU Frequency. Try defining CPU_MHZ.` steamcmd issue.
verify_cpu_mhz() {
  local float_regex cpu_mhz
  float_regex="^([0-9]+\\.?[0-9]*)\$"
  cpu_mhz="$(grep "^cpu MHz" /proc/cpuinfo | head -1 | cut -d : -f 2 | xargs)"
  if [[ -n "$cpu_mhz" && "$cpu_mhz" =~ $float_regex && "${cpu_mhz%.*}" -gt 0 ]]; then
    debug "Found CPU with $cpu_mhz MHz"
    unset CPU_MHZ
  else
    debug "Unable to determine CPU Frequency - setting a default of 1.5 GHz so steamcmd won't complain"
    export CPU_MHZ="1500.000"
  fi
}

set_current_version() {
  if [[ "$latest_version" == "null" || "$latest_version" == "-1" ]]; then
    warn "Unable to set current version - latest version is unknown"
    warn "Next update check will restart the server until version can be determined"
    return 1
  fi
  debug "[set_current_version]: $latest_version"
  echo "$latest_version" >"$version_file_path"
}

shutdown() {
  debug "Received signal to shut down updater"
  clearLock "$pidfile"
}

download_enshrouded() {
  debug "Downloading Enshrouded server"
  mkdir -p "$install_path/steamapps/compatdata/$steam_app_id"
  export WINETRICKS="/usr/local/bin/winetricks"
  export STEAM_COMPAT_CLIENT_INSTALL_PATH="/home/enshrouded/.steam/steam"
  export STEAM_COMPAT_DATA_PATH="$install_path/steamapps/compatdata/$steam_app_id"
  export STEAM_DIR="/home/enshrouded/.steam/steam/"

  "$steamcmd_path" +@sSteamCmdForcePlatformType windows +force_install_dir "$install_path" +login anonymous +app_update "$steam_app_id" "$GAME_BRANCH $STEAMCMD_ARGS" +quit
}

check_for_updates() {
  local current_version

  if [[ "$FORCE_UPDATE" == "true" ]]; then
    info "Force update requested"
    rm -f "$version_file_path"
    debug "Removing $install_path/$steamapp_path"
    rm -rf "$install_path/$steamapp_path"
    latest_version="$(curl -sX GET "https://api.steamcmd.net/v1/info/$steam_app_id" | jq -r ".data.\"$steam_app_id\".depots.branches.$GAME_BRANCH.buildid")"
    return 0
  fi

  if check_proton_files_available; then
    return 0
  fi

  if [[ -f "$version_file_path" ]]; then
    current_version="$(cat "$version_file_path")"
  else
    current_version="0"
  fi

  latest_version="$(curl -sX GET "https://api.steamcmd.net/v1/info/$steam_app_id" | jq -r ".data.\"$steam_app_id\".depots.branches.$GAME_BRANCH.buildid")"
  if [[ "$latest_version" == "null" || "$latest_version" == "-1" ]]; then
    if [[ "$current_version" == "0" ]]; then
      warn "Unable to determine latest version of enshrouded server! No version currently installed, update server anyways"
      return 0
    fi
    warn "Unable to determine latest version of enshrouded server! No update will be performed"
    return 1
  fi

  if [[ "$current_version" != "$latest_version" ]]; then
    info "Enshrouded server needs to be updated"
    return 0
  fi

  info "Enshrouded server is already the latest version"
  return 1
}

check_proton_files_available() {
  if [[ ! -d "$install_path/steamapps/compatdata/$steam_app_id" ]]; then
    warn "Proton files are not available! Performing Enshrouded update to generate proton files"
    return 0
  fi
  return 1
}

main() {
  parse_args "$@"
  init_runtime_env

  if [[ "$NO_PLAYER_CHECK" == "true" ]]; then
    UPDATE_CHECK_PLAYERS="false"
  fi

  if [[ "$CHECK_ONLY" == "true" ]]; then
    if check_for_updates; then
      info "Update check: update available"
    else
      info "Update check: no update required"
    fi
    return 0
  fi

  info "Running updater"
  update
  info "updater complete"
}

main "$@"
