#!/bin/bash
. "$(dirname "$0")/../shared/common"
. "$(dirname "$0")/../shared/profile"
. "$(dirname "$0")/../shared/env"
init_runtime_env

request_dir="${MANAGER_DATA_DIR}/requests"
request_file="${request_dir}/manager_profile_apply.json"
run_file=""
fail_file=""

stop_server_now() {
  if ! checkRunning "enshrouded-server"; then
    return 0
  fi

  info "Stopping enshrouded-server"
  supervisorctl stop enshrouded-server >/dev/null 2>&1 || true

  local deadline now
  deadline=$(( $(date +%s) + 90 ))
  while checkRunning "enshrouded-server"; do
    now="$(date +%s)"
    if [[ "$now" -ge "$deadline" ]]; then
      fatal "Timeout while stopping enshrouded-server"
    fi
    sleep 1
  done
  info "enshrouded-server stopped"
}

main() {
  local profile config_file config_dir tmp ts
  local old_enshrouded old_env_manager old_env_enshrouded

  mkdir -p "$request_dir" 2>/dev/null || true

  if [[ ! -f "$request_file" ]]; then
    fatal "Missing request file: $request_file"
  fi
  if ! jq -e 'type == "object"' "$request_file" >/dev/null 2>&1; then
    fatal "Invalid request JSON: $request_file"
  fi

  ts="$(date +%Y-%m-%d_%H-%M-%S)"
  run_file="${request_dir}/.manager_profile_apply.${ts}.$$"
  if ! mv -f "$request_file" "$run_file" 2>/dev/null; then
    fatal "Failed to claim request file: $request_file"
  fi

  fail_file="${request_dir}/failed_manager_profile_apply.${ts}.$$.json"
  trap 'mv -f "$run_file" "$fail_file" 2>/dev/null || true' EXIT

  profile="$(jq -r '.profile // empty' "$run_file" 2>/dev/null || true)"
  if [[ -z "$profile" ]]; then
    fatal "Request file missing .profile: $run_file"
  fi

  # Preserve persisted profile selectors across a full config replacement.
  old_enshrouded="$(profiles_config_get "enshrouded")"
  old_env_manager="$(profiles_env_get "MANAGER_PROFILE")"
  old_env_enshrouded="$(profiles_env_get "EN_PROFILE")"

  ensure_manager_paths
  if ! ensure_manager_profile_file "$profile"; then
    fatal "Server Manager profile template not found: $profile"
  fi

  # Keep the persisted profile store editable for the enshrouded user.
  chown -R enshrouded:enshrouded "$(dirname "$(manager_profile_path "$profile")")" 2>/dev/null || true

  stop_server_now

  config_file="$(manager_config_path)"
  config_dir="$(dirname "$config_file")"
  mkdir -p "$config_dir" 2>/dev/null || true

  tmp="$(mktemp "${config_dir}/.server_manager.json.apply.XXXXXX")"
  if ! cp "$(manager_profile_path "$profile")" "$tmp"; then
    rm -f "$tmp" 2>/dev/null || true
    fatal "Failed to copy Server Manager profile into place"
  fi

  backup_config_file "$config_file" "server_manager" || true
  mv -f "$tmp" "$config_file"
  chmod 600 "$config_file" 2>/dev/null || true
  chown enshrouded:enshrouded "$config_file" 2>/dev/null || true

  # Ensure profile selection keys exist (and drop legacy .profiles if present).
  profiles_ensure_schema || true

  # Set the selected manager profile and restore other selectors.
  profiles_config_set "manager" "$profile" || true
  if [[ -n "$old_enshrouded" ]]; then
    profiles_config_set "enshrouded" "$old_enshrouded" || true
  else
    profiles_config_set "enshrouded" "$(enshrouded_profile_resolve)" || true
  fi
  profiles_env_set_if_missing "MANAGER_PROFILE" "$old_env_manager" || true
  profiles_env_set_if_missing "EN_PROFILE" "$old_env_enshrouded" || true

  info "Server Manager profile applied: $profile"

  rm -f "$run_file" 2>/dev/null || true
  trap - EXIT
}

main "$@"

