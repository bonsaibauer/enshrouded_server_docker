#!/bin/bash
. "$(dirname "$0")/../shared/common"

main() {
  local config_file
  config_file="${install_path}/enshrouded_server.json"

  if ! command -v jq >/dev/null 2>&1; then
    fatal "jq not found"
  fi

  if [[ ! -f "$config_file" ]]; then
    fatal "Missing enshrouded_server.json at $config_file"
  fi

  if ! jq -e 'type == "object"' "$config_file" >/dev/null 2>&1; then
    fatal "Invalid JSON: $config_file"
  fi

  echo "Config: $config_file"
  echo "Server: $(jq -r '.name // "<unknown>"' "$config_file")"
  echo

  # Human output
  jq -r '
    def pw:
      (.password // "" | if . == "" then "<empty>" else . end);

    def b($v): if ($v == true) then "true" else "false" end;

    if (.userGroups // [] | type) != "array" then
      "userGroups: <missing or invalid>"
    else
      (.userGroups | to_entries[]? | . as $g
      | "Group \($g.key): \($g.value.name // \"<unnamed>\")\n"
        + "  password: \($g.value | pw)\n"
        + "  reservedSlots: \($g.value.reservedSlots // 0)\n"
        + "  canKickBan: \(b($g.value.canKickBan // false))\n"
        + "  canAccessInventories: \(b($g.value.canAccessInventories // false))\n"
        + "  canEditWorld: \(b($g.value.canEditWorld // false))\n"
        + "  canEditBase: \(b($g.value.canEditBase // false))\n"
        + "  canExtendBase: \(b($g.value.canExtendBase // false))\n"
      )
    end
  ' "$config_file"
}

main "$@"
