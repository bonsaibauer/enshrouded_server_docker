#!/usr/bin/env bash

SCRIPT_DIR="$(cd -P "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" >/dev/null 2>&1 && pwd)"
# shellcheck source=server_manager/jobs/profile
. "${SCRIPT_DIR}/profile"

enshrouded_config_file="${install_path}/enshrouded_server.json"

RESTART_FORCE="false"
RESTART_CHECK_PLAYERS_OVERRIDE=""

debug() { [[ "$log_level" -ge 50 ]] && echo "DEBUG - $*" || true; }

enshrouded_get_text() {
  local path
  path="$1"
  if [[ ! -f "$enshrouded_config_file" ]]; then
    echo ""
    return 0
  fi
  jq -r "$path | if . == null then empty else tostring end" "$enshrouded_config_file" 2>/dev/null || true
}

load_runtime_values() {
  require_cmd jq

  RESTART_CHECK_PLAYERS="${RESTART_CHECK_PLAYERS:-$(manager_get_text ".restartCheckPlayers")}"
  [[ -n "$RESTART_CHECK_PLAYERS" ]] || RESTART_CHECK_PLAYERS="true"

  RESTART_PRE_HOOK="${RESTART_PRE_HOOK:-$(manager_get_text ".restartPreHook")}"
  RESTART_POST_HOOK="${RESTART_POST_HOOK:-$(manager_get_text ".restartPostHook")}"

  ENSHROUDED_QUERY_PORT="${ENSHROUDED_QUERY_PORT:-$(enshrouded_get_text ".queryPort")}"
  [[ -n "$ENSHROUDED_QUERY_PORT" ]] || ENSHROUDED_QUERY_PORT="15637"
}

run_restart() {
  local players_check_rc
  "${SCRIPT_DIR}/server" hook-run --name "restart pre" --command "${RESTART_PRE_HOOK:-}"

  if [[ "$RESTART_FORCE" != "true" ]]; then
    "${SCRIPT_DIR}/server" guard-run core_ready -- "${SCRIPT_DIR}/server" --players-check --check-players "$RESTART_CHECK_PLAYERS" --query-port "$ENSHROUDED_QUERY_PORT"
    players_check_rc=$?
    case "$players_check_rc" in
      0)
        ;;
      10)
        warn "Enshrouded server is not empty - restart will not be performed"
        return
        ;;
      *)
        fatal "players-check failed (rc=$players_check_rc)"
        ;;
    esac
  fi

  info "Restarting Enshrouded server"
  "${SCRIPT_DIR}/server" restart >/dev/null 2>&1

  "${SCRIPT_DIR}/server" hook-run --name "restart post" --command "${RESTART_POST_HOOK:-}"
}

usage() {
  cat <<'EOF'
Usage:
  restart [--check-players|--no-check-players] [--force]
EOF
}

parse_args() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --check-players)
        RESTART_CHECK_PLAYERS_OVERRIDE="true"
        shift
        ;;
      --no-check-players)
        RESTART_CHECK_PLAYERS_OVERRIDE="false"
        shift
        ;;
      --force)
        RESTART_FORCE="true"
        shift
        ;;
      --help|-h)
        usage
        exit 0
        ;;
      *)
        fatal "Unknown argument: $1"
        ;;
    esac
  done
}

main() {
  parse_args "$@"
  load_runtime_values
  if [[ -n "$RESTART_CHECK_PLAYERS_OVERRIDE" ]]; then
    RESTART_CHECK_PLAYERS="$RESTART_CHECK_PLAYERS_OVERRIDE"
  fi
  info "Running restart job (force=${RESTART_FORCE}, check_players=${RESTART_CHECK_PLAYERS}, query_port=${ENSHROUDED_QUERY_PORT})"
  run_restart
  info "Restart job complete"
}

main "$@"
