#!/usr/bin/env bash

install_path="${INSTALL_PATH:-/home/enshrouded/server}"
manager_config_file="${MANAGER_DATA_DIR:-${install_path}/server_manager}/server_manager.json"
output_format="text"

fatal() { echo "FATAL - $*" >&2; exit 1; }

manager_get_text() {
  local path
  path="$1"
  if [[ ! -f "$manager_config_file" ]]; then
    echo ""
    return 0
  fi
  jq -r "$path | if . == null then empty else tostring end" "$manager_config_file" 2>/dev/null || true
}

resolve_from_env_or_manager() {
  local var_name path default_value env_value cfg_value
  var_name="$1"
  path="$2"
  default_value="$3"

  env_value="${!var_name-}"
  if [[ -n "$env_value" ]]; then
    printf "%s" "$env_value"
    return 0
  fi

  cfg_value="$(manager_get_text "$path")"
  if [[ -n "$cfg_value" ]]; then
    printf "%s" "$cfg_value"
    return 0
  fi

  printf "%s" "$default_value"
}

run_password_view_hook() {
  local hook_name hook_cmd
  hook_name="$1"
  hook_cmd="$2"

  if [[ -z "$hook_cmd" ]]; then
    return 0
  fi

  echo "INFO - Running ${hook_name} hook: $hook_cmd"
  eval "$hook_cmd"
}

usage() {
  cat <<'EOF'
Usage:
  password-view [--format text|json]
EOF
}

parse_args() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --format)
        output_format="${2-}"
        [[ $# -ge 2 ]] || fatal "Missing value for --format"
        shift 2
        ;;
      --help|-h)
        usage
        exit 0
        ;;
      *)
        fatal "Unknown argument: $1"
        ;;
    esac
  done

  case "$output_format" in
    text|json) ;;
    *)
      fatal "Invalid --format value: $output_format (expected: text|json)"
      ;;
  esac
}

main() {
  local config_file
  parse_args "$@"
  config_file="${install_path}/enshrouded_server.json"

  if ! command -v jq >/dev/null 2>&1; then
    fatal "jq not found"
  fi

  if [[ ! -f "$config_file" ]]; then
    fatal "Missing enshrouded_server.json at $config_file"
  fi

  if ! jq -e 'type == "object"' "$config_file" >/dev/null 2>&1; then
    fatal "Invalid JSON: $config_file"
  fi

  PASSWORD_VIEW_PRE_HOOK="$(resolve_from_env_or_manager "PASSWORD_VIEW_PRE_HOOK" ".passwordViewPreHook" "")"
  PASSWORD_VIEW_POST_HOOK="$(resolve_from_env_or_manager "PASSWORD_VIEW_POST_HOOK" ".passwordViewPostHook" "")"
  run_password_view_hook "password-view pre" "${PASSWORD_VIEW_PRE_HOOK:-}"

  if [[ "$output_format" == "json" ]]; then
    jq -c '
      {
        config: input_filename,
        server: (.name // "<unknown>"),
        userGroups: (
          if (.userGroups // [] | type) != "array" then
            []
          else
            (.userGroups | to_entries | map({
              index: .key,
              name: (.value.name // "<unnamed>"),
              password: ((.value.password // "") | if . == "" then "<empty>" else . end),
              reservedSlots: (.value.reservedSlots // 0),
              canKickBan: (.value.canKickBan // false),
              canAccessInventories: (.value.canAccessInventories // false),
              canEditWorld: (.value.canEditWorld // false),
              canEditBase: (.value.canEditBase // false),
              canExtendBase: (.value.canExtendBase // false)
            }))
          end
        )
      }
    ' "$config_file"
  else
    echo "Config: $config_file"
    echo "Server: $(jq -r '.name // "<unknown>"' "$config_file")"
    echo

    jq -r '
      def pw:
        (.password // "" | if . == "" then "<empty>" else . end);

      def b($v): if ($v == true) then "true" else "false" end;

      if (.userGroups // [] | type) != "array" then
        "userGroups: <missing or invalid>"
      else
        (.userGroups | to_entries[]? | . as $g
        | "Group \($g.key): \($g.value.name // "<unnamed>")\n"
          + "  password: \($g.value | pw)\n"
          + "  reservedSlots: \($g.value.reservedSlots // 0)\n"
          + "  canKickBan: \(b($g.value.canKickBan // false))\n"
          + "  canAccessInventories: \(b($g.value.canAccessInventories // false))\n"
          + "  canEditWorld: \(b($g.value.canEditWorld // false))\n"
          + "  canEditBase: \(b($g.value.canEditBase // false))\n"
          + "  canExtendBase: \(b($g.value.canExtendBase // false))\n"
        )
      end
    ' "$config_file"
  fi

  run_password_view_hook "password-view post" "${PASSWORD_VIEW_POST_HOOK:-}"
}

main "$@"
