#!/bin/bash
SCRIPT_DIR="$(cd -P "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" >/dev/null 2>&1 && pwd)"
# shellcheck source=server_manager/jobs/env-validation
. "${SCRIPT_DIR}/env-validation"

mode="job"
skip_update="false"

usage() {
  cat <<'EOF'
Usage:
  bootstrap [--job] [--no-update]
  bootstrap --entrypoint
EOF
}

parse_args() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --entrypoint)
        mode="entrypoint"
        shift
        ;;
      --job)
        mode="job"
        shift
        ;;
      --no-update)
        skip_update="true"
        shift
        ;;
      --help|-h)
        usage
        exit 0
        ;;
      *)
        fatal "Unknown argument: $1"
        ;;
    esac
  done
}

server_run() {
  "${SCRIPT_DIR}/server" "$@"
}

prepare_enshrouded_app_folders() {
  mkdir -p "$install_path"
}

prepare_steam_a2s_python_library() {
  pip3 install python-a2s==1.3.0 --break-system-packages
}

enshrouded_bootstrap_apply_top_level_env_to_config() {
  local file
  file="$1"
  if ! apply_env_to_json --file "$file" --meta-field "enshroudedMenuJsonPath"; then
    warn "Failed to apply some top-level ENV values to enshrouded_server.json (jq error)"
  fi
}

generate_password() {
  if [[ -r /dev/urandom ]]; then
    local out=""
    while [[ "${#out}" -lt 12 ]]; do
      out="${out}$(dd if=/dev/urandom bs=64 count=1 2>/dev/null | LC_ALL=C tr -dc 'A-Za-z0-9')"
    done
    printf '%s' "${out:0:12}"
    return 0
  fi
  date +%s%N | sha256sum | cut -c1-12
}

ensure_user_group_passwords() {
  local count idx env_var current_password new_password cfg
  cfg="${install_path}/enshrouded_server.json"

  if ! jq -e '.userGroups' "$cfg" >/dev/null 2>&1; then
    return 0
  fi

  count="$(jq -r '.userGroups | length' "$cfg" 2>/dev/null || echo 0)"
  if ! [[ "$count" =~ ^[0-9]+$ ]] || [[ "$count" -le 0 ]]; then
    return 0
  fi

  for idx in $(seq 0 $((count - 1))); do
    env_var="ENSHROUDED_ROLE_${idx}_PASSWORD"
    if [[ -n "${!env_var-}" ]]; then
      continue
    fi
    current_password="$(jq -r ".userGroups[$idx].password // empty" "$cfg" 2>/dev/null || echo "")"
    if [[ -n "$current_password" ]]; then
      continue
    fi
    new_password="$(generate_password)"
    [[ -n "$new_password" ]] || continue
    spec_apply__jq_set "$cfg" --argjson group_index "$idx" --arg password "$new_password" '.userGroups[$group_index].password = $password' || warn "Failed to set generated password for group index $idx"
  done
}

update_user_group_config() {
  local config_file
  config_file="${install_path}/enshrouded_server.json"
  if ! apply_env_template_to_json_array \
    --file "$config_file" \
    --template "ENSHROUDED_ROLE" \
    --env-prefix "ENSHROUDED_ROLE" \
    --array-path ".userGroups"; then
    warn "Failed to apply some role ENV values to enshrouded_server.json (jq error)"
  fi
  ensure_user_group_passwords
}

update_game_settings_config() {
  local config_file
  config_file="${install_path}/enshrouded_server.json"
  if ! apply_env_to_json --file "$config_file" --meta-field "enshroudedJsonPath" --filter-prefix ".gameSettings."; then
    warn "Failed to apply some game settings ENV values to enshrouded_server.json (jq error)"
  fi
}

update_or_create_enshrouded_server_config() {
  local config_file
  ensure_enshrouded_config_from_profile || fatal "Failed to initialize enshrouded_server.json from profile"
  config_file="${install_path}/enshrouded_server.json"
  [[ -e "$config_file" ]] || fatal "Missing enshrouded_server.json at $config_file"
  enshrouded_bootstrap_apply_top_level_env_to_config "$config_file"
  update_user_group_config
  update_game_settings_config
}

create_folders() {
  info "Creating server folders (save, logs, backup)"
  mkdir -p "$MANAGER_DATA_DIR" "$MANAGER_PROFILE_ROOT"

  if [[ -n "$ENSHROUDED_SAVE_DIR" ]]; then
    if [[ "$ENSHROUDED_SAVE_DIR" == /* ]]; then
      mkdir -p "$ENSHROUDED_SAVE_DIR"
    else
      mkdir -p "$install_path/$ENSHROUDED_SAVE_DIR"
    fi
  fi
  if [[ -n "$ENSHROUDED_LOG_DIR" ]]; then
    if [[ "$ENSHROUDED_LOG_DIR" == /* ]]; then
      mkdir -p "$ENSHROUDED_LOG_DIR"
    else
      mkdir -p "$install_path/$ENSHROUDED_LOG_DIR"
    fi
  fi
  if [[ -n "$BACKUP_DIR" ]]; then
    if [[ "$BACKUP_DIR" == /* ]]; then
      mkdir -p "$BACKUP_DIR"
    else
      mkdir -p "$install_path/$BACKUP_DIR"
    fi
  fi
}

apply_permissions() {
  info "Setting uid:gid of enshrouded to $PUID:$PGID"
  groupmod -g "${PGID}" -o enshrouded
  usermod -u "${PUID}" -o enshrouded
  sed -i -E "s/^(enshrouded:x):[0-9]+:[0-9]+:(.*)/\\1:$PUID:$PGID:\\2/" /etc/passwd

  chown -R enshrouded:enshrouded /home/enshrouded /var/run/enshrouded
  [[ -n "${MANAGER_DATA_DIR:-}" && "$MANAGER_DATA_DIR" == /* ]] && chown -R enshrouded:enshrouded "$MANAGER_DATA_DIR"
  [[ -n "${MANAGER_PROFILE_ROOT:-}" && "$MANAGER_PROFILE_ROOT" == /* ]] && chown -R enshrouded:enshrouded "$MANAGER_PROFILE_ROOT"
  [[ "$ENSHROUDED_SAVE_DIR" == /* ]] && chown -R enshrouded:enshrouded "$ENSHROUDED_SAVE_DIR"
  [[ "$ENSHROUDED_LOG_DIR" == /* ]] && chown -R enshrouded:enshrouded "$ENSHROUDED_LOG_DIR"
  [[ "$BACKUP_DIR" == /* ]] && chown -R enshrouded:enshrouded "$BACKUP_DIR"

  chgrp enshrouded /etc/supervisor/supervisord.conf
}

setup_syslog() {
  local rsyslog_conf_path supervisor_syslog_conf_path
  rsyslog_conf_path="${rsyslog_conf:-/etc/rsyslog.d/stdout.conf}"
  supervisor_syslog_conf_path="${supervisor_syslog_conf:-/usr/local/etc/supervisor/conf.d/syslog.conf}"

  mkdir -p "$(dirname "$rsyslog_conf_path")" "$(dirname "$supervisor_syslog_conf_path")"

  info "Setting up syslogd - logging to stdout"
  cat >"$rsyslog_conf_path" <<EOF
\$FileOwner root
\$FileGroup root
\$PrivDropToUser root
\$PrivDropToGroup root

\$template custom,"%timegenerated:1:10:date-rfc3339% %timegenerated:12:23:date-rfc3339% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n"
\$ActionFileDefaultTemplate custom

:msg, contains, "[session] Pending packets list is full" stop
*.*;cron,auth,authpriv.none /proc/self/fd/1
EOF

  cat >"$supervisor_syslog_conf_path" <<EOF
[program:rsyslogd]
user=root
environment=HOME="/root",USER="root",LANG="en_US.UTF-8",PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
command=/usr/sbin/rsyslogd -n
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
autostart=true
autorestart=true
priority=10
EOF
}

run_entrypoint_mode() {
  verify_variables
  create_folders
  apply_permissions
  setup_syslog
  exec /usr/bin/supervisord -c /etc/supervisor/supervisord.conf
}

run_job_mode() {
  local bootstrap_pre_hook
  server_run guard-require core_ready -- "${SCRIPT_DIR}/server" --startup-ui
  info "Running bootstrap job"
  verify_variables
  prepare_enshrouded_app_folders
  update_or_create_enshrouded_server_config
  prepare_steam_a2s_python_library
  server_run cron --sync --update-cron "${UPDATE_CRON:-}" --backup-cron "${BACKUP_CRON:-}" --restart-cron "${RESTART_CRON:-}"
  bootstrap_pre_hook="${BOOTSTRAP_PRE_HOOK:-${BOOTSTRAP_HOOK:-}}"
  server_run hook-run --name "bootstrap pre" --command "$bootstrap_pre_hook"
  if [[ "$skip_update" == "true" ]]; then
    info "Skipping updater start (--no-update)"
  else
    server_run update
  fi
  server_run hook-run --name "bootstrap post" --command "${BOOTSTRAP_POST_HOOK:-}"
  info "Bootstrap complete"
}

main() {
  parse_args "$@"
  init_runtime_env
  if [[ "$mode" == "entrypoint" ]]; then
    run_entrypoint_mode
  else
    run_job_mode
  fi
}

main "$@"
