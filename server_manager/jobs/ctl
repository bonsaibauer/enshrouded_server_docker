#!/bin/bash

set -euo pipefail

SUPERVISORCTL_BIN="${SUPERVISORCTL_BIN:-supervisorctl}"
MANAGER_DATA_DIR="${MANAGER_DATA_DIR:-/home/enshrouded/server/server_manager}"
manager_config_file="${MANAGER_DATA_DIR}/server_manager.json"

# Resolve this script's directory even when invoked through a symlink under
# /usr/local/bin (e.g. the `menu` alias). We need the real location so relative
# paths to sibling jobs work reliably.
resolve_script_dir() {
  local src dir
  src="${BASH_SOURCE[0]}"

  # Follow symlinks (readlink without -f is available on busybox + coreutils).
  while [[ -h "$src" ]]; do
    dir="$(cd -P "$(dirname "$src")" >/dev/null 2>&1 && pwd)"
    src="$(readlink "$src")"
    [[ "$src" != /* ]] && src="$dir/$src"
  done

  cd -P "$(dirname "$src")" >/dev/null 2>&1 && pwd
}

SCRIPT_DIR="$(resolve_script_dir)"

usage() {
  cat <<'EOF'
Usage:
  docker exec CONTAINER_NAME <command>
  docker exec CONTAINER_NAME ctl <command>

Commands:
  status         Show supervisor program status
  menu           Start interactive Server Manager menu
  start          Start server
  stop           Stop server
  restart        Restart server
  update         Trigger updater
  backup         Trigger manual full backup (BACKUP_DIR/manual/*.zip)
  backup-config  Trigger config-only backup zip (BACKUP_DIR/manual/*.zip)
  restore-backup Trigger restore-backup job (expects request file in server_manager/requests)
  profile        Trigger profile job (expects request file in server_manager/requests)
  password-view  Show user group rights and passwords from enshrouded_server.json
  env-validation Run ENV validation job
  scheduled-restart
                 Trigger restart job
  force-update   Trigger updater in force mode
  bootstrap      Trigger bootstrap
  cron-start     Start crond
  cron-stop      Stop crond
  cron-restart   Restart crond
  help           Show this help
EOF
}

run_supervisorctl() {
  "$SUPERVISORCTL_BIN" "$@"
}

manager_get() {
  local path
  path="$1"
  if [[ ! -f "$manager_config_file" ]]; then
    echo ""
    return 0
  fi
  jq -r "$path | if . == null then empty else tostring end" "$manager_config_file" 2>/dev/null || true
}

resolve_from_env_or_manager() {
  local var_name path default_value env_value cfg_value
  var_name="$1"
  path="$2"
  default_value="$3"

  env_value="${!var_name-}"
  if [[ -n "$env_value" ]]; then
    printf "%s" "$env_value"
    return 0
  fi

  cfg_value="$(manager_get "$path")"
  if [[ -n "$cfg_value" ]]; then
    printf "%s" "$cfg_value"
    return 0
  fi

  printf "%s" "$default_value"
}

run_ctl_hook() {
  local hook_name hook_cmd
  hook_name="$1"
  hook_cmd="$2"

  if [[ -z "$hook_cmd" ]]; then
    return 0
  fi

  echo "INFO - Running ${hook_name} hook: $hook_cmd"
  eval "$hook_cmd"
}

load_ctl_hooks() {
  CTL_PRE_HOOK="$(resolve_from_env_or_manager "CTL_PRE_HOOK" ".ctlPreHook" "")"
  CTL_POST_HOOK="$(resolve_from_env_or_manager "CTL_POST_HOOK" ".ctlPostHook" "")"
}

write_backup_request() {
  local mode include_savegame include_enshrouded include_manager cleanup
  local requests_dir request_file tmp_file
  mode="$1"
  include_savegame="$2"
  include_enshrouded="$3"
  include_manager="$4"
  cleanup="${5:-false}"

  requests_dir="${MANAGER_DATA_DIR}/requests"
  request_file="${requests_dir}/backup.json"
  mkdir -p "$requests_dir" 2>/dev/null || true
  tmp_file="$(mktemp "${requests_dir}/.backup.json.XXXXXX")"

  if ! jq -n \
    --arg mode "$mode" \
    --argjson includeSavegame "$include_savegame" \
    --argjson includeEnshroudedConfig "$include_enshrouded" \
    --argjson includeManagerConfig "$include_manager" \
    --argjson cleanup "$cleanup" \
    '{mode: $mode, includeSavegame: $includeSavegame, includeEnshroudedConfig: $includeEnshroudedConfig, includeManagerConfig: $includeManagerConfig, cleanup: $cleanup}' >"$tmp_file"; then
    rm -f "$tmp_file" 2>/dev/null || true
    return 1
  fi

  mv -f "$tmp_file" "$request_file"
  chmod 600 "$request_file" 2>/dev/null || true
  chown enshrouded:enshrouded "$request_file" 2>/dev/null || true
  return 0
}

trigger_backup() {
  local mode include_savegame include_enshrouded include_manager cleanup
  mode="$1"
  include_savegame="$2"
  include_enshrouded="$3"
  include_manager="$4"
  cleanup="${5:-false}"

  if ! write_backup_request "$mode" "$include_savegame" "$include_enshrouded" "$include_manager" "$cleanup"; then
    echo "Failed to write backup request file." >&2
    exit 1
  fi
  run_supervisorctl start backup
}

run_ctl_command() {
  local cmd
  cmd="$1"
  shift || true
  case "$cmd" in
    status)
      run_supervisorctl status
      ;;
    menu)
      "${SCRIPT_DIR}/menu" "$@"
      ;;
    start)
      run_supervisorctl start server
      ;;
    stop)
      run_supervisorctl stop server
      ;;
    restart)
      run_supervisorctl restart server
      ;;
    update)
      run_supervisorctl start updater
      ;;
    backup)
      trigger_backup "manual" "true" "true" "true" "false"
      ;;
    backup-config)
      trigger_backup "manual" "false" "true" "true" "false"
      ;;
    restore-backup)
      run_supervisorctl start restore-backup
      ;;
    profile)
      run_supervisorctl start profile
      ;;
    password-view)
      "${SCRIPT_DIR}/password-view" "$@"
      ;;
    env-validation)
      run_supervisorctl start env-validation
      ;;
    scheduled-restart)
      run_supervisorctl start restart
      ;;
    force-update)
      run_supervisorctl start force-update
      ;;
    bootstrap)
      run_supervisorctl start bootstrap
      ;;
    cron-start)
      run_supervisorctl start crond
      ;;
    cron-stop)
      run_supervisorctl stop crond
      ;;
    cron-restart)
      run_supervisorctl restart crond
      ;;
    help|--help|-h)
      usage
      ;;
    *)
      echo "Unknown command: $cmd" >&2
      usage >&2
      exit 1
      ;;
  esac
}

main() {
  local invoked_name cmd
  invoked_name="$(basename "$0")"

  if [[ "$invoked_name" != "ctl" ]]; then
    cmd="$invoked_name"
  else
    cmd="${1:-help}"
    shift || true
  fi

  load_ctl_hooks
  if [[ "$cmd" != "help" && "$cmd" != "--help" && "$cmd" != "-h" ]]; then
    run_ctl_hook "ctl pre" "${CTL_PRE_HOOK:-}"
    run_ctl_command "$cmd" "$@"
    run_ctl_hook "ctl post" "${CTL_POST_HOOK:-}"
    return 0
  fi

  run_ctl_command "$cmd" "$@"
}

main "$@"
