#!/bin/bash

set -euo pipefail

SUPERVISORCTL_BIN="${SUPERVISORCTL_BIN:-supervisorctl}"

# Resolve this script's directory even when invoked through a symlink under
# /usr/local/bin (e.g. the `menu` alias). We need the real location so relative
# paths to ../menu and ../jobs work reliably.
resolve_script_dir() {
  local src dir
  src="${BASH_SOURCE[0]}"

  # Follow symlinks (readlink without -f is available on busybox + coreutils).
  while [[ -h "$src" ]]; do
    dir="$(cd -P "$(dirname "$src")" >/dev/null 2>&1 && pwd)"
    src="$(readlink "$src")"
    [[ "$src" != /* ]] && src="$dir/$src"
  done

  cd -P "$(dirname "$src")" >/dev/null 2>&1 && pwd
}

SCRIPT_DIR="$(resolve_script_dir)"

usage() {
  cat <<'EOF'
Usage:
  docker exec CONTAINER_NAME <command>
  docker exec CONTAINER_NAME ctl <command>

Commands:
  status         Show supervisor program status
  menu           Start interactive Server Manager menu
  start          Start enshrouded-server
  stop           Stop enshrouded-server
  restart        Restart enshrouded-server
  update         Trigger enshrouded-updater
  backup         Trigger enshrouded-backup
  server-manager-profil-apply
                 Apply the selected Server Manager profile (menu writes a request file)
  enshrouded-profile-apply
                 Apply the selected Enshrouded profile (menu writes a request file)
  enshrouded-config-restore
                 Restore enshrouded_server.json from a selected backup (menu writes a request file)
  server-manager-config-restore
                 Restore server_manager.json from a selected backup (menu writes a request file)
  enshrouded-backup-restore
                 Restore the savegame from a selected .zip backup (menu writes a request file)
  password-view  Show user group rights and passwords from enshrouded_server.json
  scheduled-restart
                 Trigger enshrouded-restart job
  force-update   Trigger enshrouded-force-update
  server-manager-profil-reset
                 Trigger server-manager-profil-reset
  enshrouded-profile-reset
                 Trigger enshrouded-profile-reset
  bootstrap      Trigger enshrouded-bootstrap
  cron-start     Start crond
  cron-stop      Stop crond
  cron-restart   Restart crond
  help           Show this help
EOF
}

run_supervisorctl() {
  "$SUPERVISORCTL_BIN" "$@"
}

main() {
  local invoked_name cmd
  invoked_name="$(basename "$0")"

  if [[ "$invoked_name" != "ctl" ]]; then
    cmd="$invoked_name"
  else
    cmd="${1:-help}"
    shift || true
  fi

  case "$cmd" in
    status)
      run_supervisorctl status
      ;;
    menu)
      "${SCRIPT_DIR}/../menu/menu" "$@"
      ;;
    start)
      run_supervisorctl start enshrouded-server
      ;;
    stop)
      run_supervisorctl stop enshrouded-server
      ;;
    restart)
      run_supervisorctl restart enshrouded-server
      ;;
    update)
      run_supervisorctl start enshrouded-updater
      ;;
    backup)
      run_supervisorctl start enshrouded-backup
      ;;
    server-manager-profil-apply)
      run_supervisorctl start server-manager-profil-apply
      ;;
    enshrouded-profile-apply)
      run_supervisorctl start enshrouded-profile-apply
      ;;
    enshrouded-config-restore)
      run_supervisorctl start enshrouded-config-restore
      ;;
    server-manager-config-restore)
      run_supervisorctl start server-manager-config-restore
      ;;
    enshrouded-backup-restore)
      run_supervisorctl start enshrouded-backup-restore
      ;;
    password-view)
      "${SCRIPT_DIR}/../jobs/enshrouded-password-view" "$@"
      ;;
    scheduled-restart)
      run_supervisorctl start enshrouded-restart
      ;;
    force-update)
      run_supervisorctl start enshrouded-force-update
      ;;
    server-manager-profil-reset)
      run_supervisorctl start server-manager-profil-reset
      ;;
    enshrouded-profile-reset)
      run_supervisorctl start enshrouded-profile-reset
      ;;
    bootstrap)
      run_supervisorctl start enshrouded-bootstrap
      ;;
    cron-start)
      run_supervisorctl start crond
      ;;
    cron-stop)
      run_supervisorctl stop crond
      ;;
    cron-restart)
      run_supervisorctl restart crond
      ;;
    help|--help|-h)
      usage
      ;;
    *)
      echo "Unknown command: $cmd" >&2
      usage >&2
      exit 1
      ;;
  esac
}

main "$@"
