#!/bin/bash

set -euo pipefail

SUPERVISORCTL_BIN="${SUPERVISORCTL_BIN:-supervisorctl}"
MANAGER_DATA_DIR="${MANAGER_DATA_DIR:-/home/enshrouded/server/server_manager}"

# Resolve this script's directory even when invoked through a symlink under
# /usr/local/bin (e.g. the `menu` alias). We need the real location so relative
# paths to ../menu and ../jobs work reliably.
resolve_script_dir() {
  local src dir
  src="${BASH_SOURCE[0]}"

  # Follow symlinks (readlink without -f is available on busybox + coreutils).
  while [[ -h "$src" ]]; do
    dir="$(cd -P "$(dirname "$src")" >/dev/null 2>&1 && pwd)"
    src="$(readlink "$src")"
    [[ "$src" != /* ]] && src="$dir/$src"
  done

  cd -P "$(dirname "$src")" >/dev/null 2>&1 && pwd
}

SCRIPT_DIR="$(resolve_script_dir)"

usage() {
  cat <<'EOF'
Usage:
  docker exec CONTAINER_NAME <command>
  docker exec CONTAINER_NAME ctl <command>

Commands:
  status         Show supervisor program status
  menu           Start interactive Server Manager menu
  start          Start enshrouded-server
  stop           Stop enshrouded-server
  restart        Restart enshrouded-server
  update         Trigger enshrouded-updater
  backup         Trigger manual full backup (BACKUP_DIR/manual/*.zip)
  backup-config  Trigger config-only backup zip (BACKUP_DIR/manual/*.zip)
  restore-backup Trigger restore-backup job (expects request file in server_manager/requests)
  profile        Trigger profile job (expects request file in server_manager/requests)
  password-view  Show user group rights and passwords from enshrouded_server.json
  scheduled-restart
                 Trigger enshrouded-restart job
  force-update   Trigger enshrouded-force-update
  bootstrap      Trigger enshrouded-bootstrap
  cron-start     Start crond
  cron-stop      Stop crond
  cron-restart   Restart crond
  help           Show this help
EOF
}

run_supervisorctl() {
  "$SUPERVISORCTL_BIN" "$@"
}

write_backup_request() {
  local mode include_savegame include_enshrouded include_manager cleanup
  local requests_dir request_file tmp_file
  mode="$1"
  include_savegame="$2"
  include_enshrouded="$3"
  include_manager="$4"
  cleanup="${5:-false}"

  requests_dir="${MANAGER_DATA_DIR}/requests"
  request_file="${requests_dir}/backup.json"
  mkdir -p "$requests_dir" 2>/dev/null || true
  tmp_file="$(mktemp "${requests_dir}/.backup.json.XXXXXX")"

  if ! jq -n \
    --arg mode "$mode" \
    --argjson includeSavegame "$include_savegame" \
    --argjson includeEnshroudedConfig "$include_enshrouded" \
    --argjson includeManagerConfig "$include_manager" \
    --argjson cleanup "$cleanup" \
    '{mode: $mode, includeSavegame: $includeSavegame, includeEnshroudedConfig: $includeEnshroudedConfig, includeManagerConfig: $includeManagerConfig, cleanup: $cleanup}' >"$tmp_file"; then
    rm -f "$tmp_file" 2>/dev/null || true
    return 1
  fi

  mv -f "$tmp_file" "$request_file"
  chmod 600 "$request_file" 2>/dev/null || true
  chown enshrouded:enshrouded "$request_file" 2>/dev/null || true
  return 0
}

trigger_backup() {
  local mode include_savegame include_enshrouded include_manager cleanup
  mode="$1"
  include_savegame="$2"
  include_enshrouded="$3"
  include_manager="$4"
  cleanup="${5:-false}"

  if ! write_backup_request "$mode" "$include_savegame" "$include_enshrouded" "$include_manager" "$cleanup"; then
    echo "Failed to write backup request file." >&2
    exit 1
  fi
  run_supervisorctl start backup
}

main() {
  local invoked_name cmd
  invoked_name="$(basename "$0")"

  if [[ "$invoked_name" != "ctl" ]]; then
    cmd="$invoked_name"
  else
    cmd="${1:-help}"
    shift || true
  fi

  case "$cmd" in
    status)
      run_supervisorctl status
      ;;
    menu)
      "${SCRIPT_DIR}/../menu/menu" "$@"
      ;;
    start)
      run_supervisorctl start enshrouded-server
      ;;
    stop)
      run_supervisorctl stop enshrouded-server
      ;;
    restart)
      run_supervisorctl restart enshrouded-server
      ;;
    update)
      run_supervisorctl start enshrouded-updater
      ;;
    backup)
      trigger_backup "manual" "true" "true" "true" "false"
      ;;
    backup-config)
      trigger_backup "manual" "false" "true" "true" "false"
      ;;
    restore-backup)
      run_supervisorctl start restore-backup
      ;;
    profile)
      run_supervisorctl start profile
      ;;
    password-view)
      "${SCRIPT_DIR}/../jobs/enshrouded-password-view" "$@"
      ;;
    scheduled-restart)
      run_supervisorctl start enshrouded-restart
      ;;
    force-update)
      run_supervisorctl start enshrouded-force-update
      ;;
    bootstrap)
      run_supervisorctl start enshrouded-bootstrap
      ;;
    cron-start)
      run_supervisorctl start crond
      ;;
    cron-stop)
      run_supervisorctl stop crond
      ;;
    cron-restart)
      run_supervisorctl restart crond
      ;;
    help|--help|-h)
      usage
      ;;
    *)
      echo "Unknown command: $cmd" >&2
      usage >&2
      exit 1
      ;;
  esac
}

main "$@"
