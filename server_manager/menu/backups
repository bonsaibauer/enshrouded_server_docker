#!/usr/bin/env bash

menu_save_dir_resolve() {
  local dir
  dir="${ENSHROUDED_SAVE_DIR:-./savegame}"
  if [[ "$dir" == /* ]]; then
    printf "%s" "$dir"
  else
    printf "%s/%s" "$install_path" "$dir"
  fi
}

menu_backup_kind_from_path() {
  local backup_root rel
  backup_root="$(backup_dir_resolve)"
  rel="${1#$backup_root/}"
  case "$rel" in
    scheduled/*) echo "scheduled" ;;
    manual/*) echo "manual" ;;
    *) echo "manual" ;;
  esac
}

menu_backup_list_files() {
  local backup_root
  backup_root="$(backup_dir_resolve)"

  {
    find "${backup_root}/manual" -maxdepth 1 -type f -name "*.zip" -printf '%T@\t%p\n' 2>/dev/null || true
    find "${backup_root}/scheduled" -maxdepth 1 -type f -name "*.zip" -printf '%T@\t%p\n' 2>/dev/null || true
  } | sort -rn | cut -f2-
}

menu_backup_zip_entries() {
  local zip_file
  zip_file="$1"

  python3 - "$zip_file" <<'PY'
import pathlib
import sys
import zipfile

zip_path = pathlib.Path(sys.argv[1])
try:
    with zipfile.ZipFile(zip_path, "r") as zf:
        for name in zf.namelist():
            print(name)
except Exception:
    pass
PY
}

menu_backup_detect_components() {
  local zip_file entries has_savegame has_enshrouded has_manager
  zip_file="$1"
  entries="$(menu_backup_zip_entries "$zip_file")"
  has_savegame="false"
  has_enshrouded="false"
  has_manager="false"

  if printf '%s\n' "$entries" | grep -q '^savegame/'; then
    has_savegame="true"
  fi

  if printf '%s\n' "$entries" | grep -Fxq "config/enshrouded_server.json"; then
    has_enshrouded="true"
  fi

  if printf '%s\n' "$entries" | grep -Fxq "config/server_manager.json"; then
    has_manager="true"
  fi

  printf "%s %s %s" "$has_savegame" "$has_enshrouded" "$has_manager"
}

menu_run_savegame_backup() {
  local backup_dir save_dir
  backup_dir="$(backup_dir_resolve)"
  save_dir="$(menu_save_dir_resolve)"

  ui_header "Create Manual Backup"
  ui_note "Manual backups are stored under BACKUP_DIR/manual and are never pruned by backupMaxCount."
  echo
  ui_kv "Save Directory" "$save_dir"
  ui_kv "Backup Root" "$backup_dir"
  ui_kv "Target Folder" "${backup_dir}/manual"
  echo

  if ! ui_confirm_yes_no "Create manual full backup now?"; then
    ui_note "Cancelled."
    ui_pause
    return 0
  fi

  if menu_run_backup_job "manual" 1200 "true" "true" "true" "false"; then
    ui_success "Manual backup created."
  else
    ui_warn_line "Backup failed or timed out."
  fi

  ui_pause
  return 0
}

menu_run_config_backup_now() {
  local choice include_ens include_mgr
  include_ens="true"
  include_mgr="true"

  while :; do
    ui_header "Create Config Backup"
    ui_note "Creates a config-only ZIP under BACKUP_DIR/manual."
    echo
    ui_opt 1 "Enshrouded config only"
    ui_opt 2 "Server Manager config only"
    ui_opt 3 "Both config files"
    echo
    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo

    choice="$(ui_prompt_choice "Choice")"
    choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$choice" in
      1)
        include_ens="true"
        include_mgr="false"
        ;;
      2)
        include_ens="false"
        include_mgr="true"
        ;;
      3)
        include_ens="true"
        include_mgr="true"
        ;;
      0)
        return 0
        ;;
      m)
        menu_nav_set "main"
        return 0
        ;;
      x|q)
        menu_nav_set "exit"
        return 0
        ;;
      *)
        ui_warn_line "Invalid selection."
        ui_pause
        continue
        ;;
    esac

    if menu_run_backup_job "manual" 120 "false" "$include_ens" "$include_mgr" "false"; then
      ui_success "Config backup created."
    else
      ui_warn_line "Config backup failed or timed out."
    fi
    ui_pause
    return 0
  done
}

menu_restore_backup() {
  local backup_root save_dir selected choice file
  backup_root="$(backup_dir_resolve)"
  save_dir="$(menu_save_dir_resolve)"

  while :; do
    local -a files
    mapfile -t files < <(menu_backup_list_files)

    ui_header "Restore Backup"
    ui_kv "Backup Root" "$backup_root"
    ui_kv "Target Save Directory" "$save_dir"
    ui_kv "Savefile Name" "$savefile_name"
    echo

    if [[ "${#files[@]}" -eq 0 ]]; then
      ui_warn_line "No backup ZIP files found."
      echo
      if ui_confirm_yes_no "Create a manual backup now?"; then
        menu_run_savegame_backup || true
        continue
      fi
      return 0
    fi

    ui_note "Backups (newest first):"
    echo
    local idx base kind
    idx=1
    for file in "${files[@]}"; do
      base="$(basename "$file")"
      kind="$(menu_backup_kind_from_path "$file")"
      printf "%s[%s]%s %-11s %s\n" "${C_MAGENTA}" "$idx" "${C_RESET}" "${kind}" "$base"
      idx=$((idx + 1))
    done
    echo
    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo

    choice="$(ui_prompt_choice "Backup")"
    choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$choice" in
      0)
        return 0
        ;;
      m)
        menu_nav_set "main"
        return 0
        ;;
      x|q)
        menu_nav_set "exit"
        return 0
        ;;
    esac

    if ! [[ "$choice" =~ ^[0-9]+$ ]] || [[ "$choice" -lt 1 || "$choice" -gt "${#files[@]}" ]]; then
      ui_warn_line "Invalid selection."
      ui_pause
      continue
    fi

    selected="${files[$((choice - 1))]}"

    local has_savegame has_enshrouded has_manager
    read -r has_savegame has_enshrouded has_manager <<<"$(menu_backup_detect_components "$selected")"
    if [[ "$has_savegame" != "true" && "$has_enshrouded" != "true" && "$has_manager" != "true" ]]; then
      ui_warn_line "No restorable components detected in this backup."
      ui_pause
      continue
    fi

    ui_header "Restore Backup"
    ui_warn_line "WARNING: Selected components will overwrite current data."
    ui_warn_line "The server will be stopped and players disconnected."
    echo
    ui_kv "Selected Backup" "$(basename "$selected")"
    ui_kv "Detected Components" "savegame=$has_savegame, enshrouded=$has_enshrouded, manager=$has_manager"
    echo

    if ! ui_confirm_yes_no "Continue to component selection?"; then
      ui_note "Cancelled."
      ui_pause
      continue
    fi

    local restore_savegame restore_enshrouded restore_manager safety
    restore_savegame="false"
    restore_enshrouded="false"
    restore_manager="false"
    safety="false"

    if [[ "$has_savegame" == "true" ]] && ui_confirm_yes_no "Restore savegame files?"; then
      restore_savegame="true"
    fi
    if [[ "$has_enshrouded" == "true" ]] && ui_confirm_yes_no "Restore enshrouded_server.json?"; then
      restore_enshrouded="true"
    fi
    if [[ "$has_manager" == "true" ]] && ui_confirm_yes_no "Restore server_manager.json?"; then
      restore_manager="true"
    fi

    if [[ "$restore_savegame" != "true" && "$restore_enshrouded" != "true" && "$restore_manager" != "true" ]]; then
      ui_warn_line "Nothing selected for restore."
      ui_pause
      continue
    fi

    if ui_confirm_yes_no "Create safety backup before restore?"; then
      safety="true"
    fi

    if ! menu_write_request_json "backup_restore.json" \
      --arg zipPath "$selected" \
      --argjson restoreSavegame "$restore_savegame" \
      --argjson restoreEnshroudedConfig "$restore_enshrouded" \
      --argjson restoreManagerConfig "$restore_manager" \
      --argjson createSafetyBackup "$safety" \
      '{zipPath: $zipPath, restoreSavegame: $restoreSavegame, restoreEnshroudedConfig: $restoreEnshroudedConfig, restoreManagerConfig: $restoreManagerConfig, createSafetyBackup: $createSafetyBackup}' >/dev/null; then
      ui_error "Failed to write restore request."
      ui_pause
      continue
    fi

    supervisorctl start restore-backup >/dev/null 2>&1 || true
    if ! menu_wait_for_program_exit "restore-backup" 1200; then
      ui_warn_line "Timeout while waiting for restore-backup."
      ui_note "Check: supervisorctl status restore-backup"
      ui_pause
      continue
    fi

    ui_success "Restore finished."
    echo
    menu_prompt_start_server "Start enshrouded-server now?"
    ui_pause
    return 0
  done
}

menu_backups_menu() {
  local choice
  while :; do
    if menu_nav_is_set; then
      return 0
    fi
    ui_header "Backups"

    ui_opt 1 "Restore from backup ZIP"
    ui_opt 2 "Create manual full backup now"
    ui_opt 3 "Create config backup now"
    echo
    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo

    choice="$(ui_prompt_choice "Choice")"
    choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$choice" in
      1) menu_restore_backup || true ;;
      2) menu_run_savegame_backup || true ;;
      3) menu_run_config_backup_now || true ;;
      0) return 0 ;;
      m)
        menu_nav_set "main"
        return 0
        ;;
      x|q)
        menu_nav_set "exit"
        return 0
        ;;
      *)
        ui_warn_line "Invalid selection."
        ui_pause
        ;;
    esac
  done
}
