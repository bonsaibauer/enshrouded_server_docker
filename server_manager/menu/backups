#!/usr/bin/env bash

menu_backups_list_files() {
  local label backup_dir
  label="$1"
  backup_dir="$(config_backups_dir)"

  local -a files
  shopt -s nullglob
  files=( "$backup_dir"/*_"$label"*.json )
  shopt -u nullglob

  # Sort newest first (timestamp prefix in filename).
  if [[ "${#files[@]}" -gt 1 ]]; then
    IFS=$'\n' files=( $(printf "%s\n" "${files[@]}" | sort -r) )
    unset IFS
  fi

  printf "%s\n" "${files[@]}"
}

menu_restore_from_backup_generic() {
  local title label config_file backup_dir selected choice file config_dir tmp
  title="$1"
  label="$2"
  config_file="$3"
  backup_dir="$(config_backups_dir)"

  while :; do
    local -a files
    mapfile -t files < <(menu_backups_list_files "$label")

    ui_header "Restore ${title} Settings"
    ui_kv "Backup Folder" "$backup_dir"
    ui_kv "Target File" "$config_file"
    echo

    if [[ "${#files[@]}" -eq 0 ]]; then
      ui_warn_line "No backups found."
      ui_pause
      return 0
    fi

    ui_note "Backups (newest first):"
    echo
    local idx base ts
    idx=1
    for file in "${files[@]}"; do
      base="$(basename "$file")"
      ts="${base:0:19}"
      printf "[%s] %-19s  %s\n" "$idx" "$ts" "$base"
      idx=$((idx + 1))
    done
    echo
    echo "[0] Back"
    echo

    choice="$(ui_prompt_number "Backup")"
    if [[ "$choice" -eq 0 ]]; then
      return 0
    fi
    if [[ "$choice" -lt 1 || "$choice" -gt "${#files[@]}" ]]; then
      ui_warn_line "Invalid selection."
      ui_pause
      continue
    fi

    selected="${files[$((choice - 1))]}"

    ui_header "Restore ${title} Settings"
    ui_warn_line "WARNING: This will replace the active config with the selected backup."
    ui_warn_line "All players will be disconnected (if the server is running)."
    echo
    ui_kv "Selected Backup" "$(basename "$selected")"
    ui_kv "Target File" "$config_file"
    echo

    if ! ui_confirm_yes_no "Stop server (if running) and restore this backup now?"; then
      ui_note "Cancelled."
      ui_pause
      continue
    fi

    if ! menu_stop_server_now; then
      ui_pause
      continue
    fi

    config_dir="$(dirname "$config_file")"
    mkdir -p "$config_dir" 2>/dev/null || true
    tmp="$(mktemp "${config_dir}/.${label}.restore.XXXXXX")"
    if ! cp "$selected" "$tmp"; then
      rm -f "$tmp" 2>/dev/null || true
      ui_error "Failed to restore backup."
      ui_pause
      continue
    fi

    mv -f "$tmp" "$config_file"
    chmod 600 "$config_file" 2>/dev/null || true
    chown enshrouded:enshrouded "$config_file" 2>/dev/null || true
    ui_success "Restored: $config_file"

    echo
    ui_note "Apply changes:"
    echo "[1] Start/restart Enshrouded server"
    echo "[2] Run bootstrap (recommended; does not start server)"
    echo "[0] Back to menu"
    echo

    case "$(ui_prompt_number "Action")" in
      1)
        supervisorctl restart enshrouded-server || true
        ui_success "Restart requested."
        ui_pause
        ;;
      2)
        supervisorctl start enshrouded-bootstrap || true
        ui_success "Bootstrap started."
        ui_note "Note: bootstrap does not start the server."
        if menu_wait_for_program_exit "enshrouded-bootstrap" 600; then
          echo
          menu_prompt_start_server "Start enshrouded-server now?"
        else
          ui_note "Start the server later once bootstrap has finished."
        fi
        ui_pause
        ;;
      0)
        ;;
      *)
        ;;
    esac

    return 0
  done
}

menu_restore_enshrouded_backup() {
  menu_restore_from_backup_generic "Enshrouded" "enshrouded_server" "${install_path}/enshrouded_server.json"
}

menu_restore_manager_backup() {
  menu_restore_from_backup_generic "Server Manager" "server_manager" "$(manager_config_path)"
}
