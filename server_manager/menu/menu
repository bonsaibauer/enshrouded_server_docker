#!/usr/bin/env bash

set -euo pipefail

MENU_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

. "$MENU_DIR/../shared/common"
. "$MENU_DIR/../shared/profile"
. "$MENU_DIR/../shared/env"

# Snapshot externally provided env vars (Docker/container env) BEFORE init_runtime_env exports config-derived vars.
# Used to disable editing of settings that are controlled by ENV and would be overwritten on bootstrap/container start.
declare -A MENU_EXTERNAL_ENV=()

menu_capture_external_env() {
  local var value line name

  while IFS= read -r var; do
    [[ -z "$var" ]] && continue
    value="$(printenv "$var" 2>/dev/null || true)"
    if [[ -n "$value" ]]; then
      MENU_EXTERNAL_ENV["$var"]="$value"
    fi
  done < <(validation_list_vars)

  # Pattern-based overrides (game settings + roles)
  while IFS= read -r line; do
    name="${line%%=*}"
    value="${line#*=}"
    case "$name" in
      ENSHROUDED_GS_*|ENSHROUDED_ROLE_*)
        if [[ -n "$value" ]]; then
          MENU_EXTERNAL_ENV["$name"]="$value"
        fi
        ;;
    esac
  done < <(env)
}

menu_capture_external_env
init_runtime_env

# Optional helpers we reuse when applying Enshrouded profiles (password generation, etc.)
. "$MENU_DIR/../shared/enshrouded-bootstrap-shared"

. "$MENU_DIR/ui"
. "$MENU_DIR/backups"
. "$MENU_DIR/editor_spec_json"
. "$MENU_DIR/editor_enshrouded_json"
. "$MENU_DIR/enshrouded"
. "$MENU_DIR/manager"

MENU_NAV=""

menu_run_ctl() {
  local cmd
  cmd="$1"
  ui_hr
  ui_note "Running: ctl $cmd"
  echo
  # Use the canonical entrypoint path to avoid PATH issues.
  /usr/local/etc/enshrouded/entrypoints/ctl "$cmd" || true
  echo
  ui_pause
}

menu_other_commands() {
  local choice
  while :; do
    if menu_nav_is_set; then
      return 0
    fi
    ui_header "Other ctl Commands"

    ui_opt 1 "Status"
    ui_opt 2 "Scheduled Restart"
    ui_opt 3 "Bootstrap"
    ui_opt 4 "Cron Start"
    ui_opt 5 "Cron Stop"
    ui_opt 6 "Cron Restart"
    echo
    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo
    choice="$(ui_prompt_choice "Choice")"
    choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$choice" in
      1) menu_run_ctl status ;;
      2) menu_run_ctl scheduled-restart ;;
      3) menu_run_ctl bootstrap ;;
      4) menu_run_ctl cron-start ;;
      5) menu_run_ctl cron-stop ;;
      6) menu_run_ctl cron-restart ;;
      0) return 0 ;;
      m)
        menu_nav_set "main"
        return 0
        ;;
      x|q)
        menu_nav_set "exit"
        return 0
        ;;
      *)
        ui_warn_line "Invalid selection."
        ui_pause
        ;;
    esac
  done
}

menu_main() {
  local choice

  while :; do
    if menu_nav_is_set; then
      case "$(menu_nav_value)" in
        main)
          menu_nav_clear
          ;;
        *)
          return 0
          ;;
      esac
    fi
    ui_header "Main Menu"

    ui_opt 1 "Enshrouded Server Settings"
    ui_opt 2 "Server Manager Settings"
    ui_opt 3 "Backup Menu"
    ui_opt 4 "Start Server"
    ui_opt 5 "Stop Server"
    ui_opt 6 "Restart Server"
    ui_opt 7 "Update Server"
    ui_opt 8 "Force Update Server"
    ui_opt 9 "View Passwords"
    ui_opt 10 "Create Savegame Backup (.zip)"
    ui_opt 11 "Other ctl Commands"
    echo

    ui_actions_bar "x Exit"
    echo
    choice="$(ui_prompt_choice "Choice")"
    choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$choice" in
      1)
        menu_enshrouded_settings
        ;;
      2)
        menu_manager_settings
        ;;
      3)
        menu_backups_menu
        ;;
      4)
        menu_run_ctl start
        ;;
      5)
        menu_run_ctl stop
        ;;
      6)
        menu_run_ctl restart
        ;;
      7)
        menu_run_ctl update
        ;;
      8)
        menu_run_ctl force-update
        ;;
      9)
        menu_run_ctl password-view
        ;;
      10)
        menu_run_savegame_backup
        ;;
      11)
        menu_other_commands
        ;;
      0|x|q)
        ui_clear
        menu_nav_set "exit"
        return 0
        ;;
      *)
        ui_warn_line "Invalid selection."
        ui_pause
        ;;
    esac
  done
}

menu_main

case "${MENU_NAV:-}" in
  exit)
    # On exit, offer to start the server if it is currently stopped.
    if ! checkRunning "enshrouded-server"; then
      ui_clear
      ui_banner
      ui_warn_line "The Enshrouded server is currently STOPPED."
      echo
      if ui_confirm_yes_no "Do you want me to start enshrouded-server before exiting?"; then
        ui_note "Starting enshrouded-server..."
        /usr/local/etc/enshrouded/entrypoints/ctl start >/dev/null 2>&1 || true
        ui_success "Start requested."
      else
        ui_note "Server remains stopped."
      fi
    fi
    ;;
esac
