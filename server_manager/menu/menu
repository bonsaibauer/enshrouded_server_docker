#!/usr/bin/env bash

set -euo pipefail

MENU_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

. "$MENU_DIR/../shared/common"
. "$MENU_DIR/../shared/profile"
. "$MENU_DIR/../shared/env"

# Snapshot externally provided env vars (Docker/container env) BEFORE init_runtime_env exports config-derived vars.
# Used to disable editing of settings that are controlled by ENV and would be overwritten on bootstrap/container start.
declare -A MENU_EXTERNAL_ENV=()

menu_capture_external_env() {
  local var value line name

  while IFS= read -r var; do
    [[ -z "$var" ]] && continue
    value="$(printenv "$var" 2>/dev/null || true)"
    if [[ -n "$value" ]]; then
      MENU_EXTERNAL_ENV["$var"]="$value"
    fi
  done < <(validation_list_vars)

  # Pattern-based overrides (game settings + roles)
  while IFS= read -r line; do
    name="${line%%=*}"
    value="${line#*=}"
    case "$name" in
      ENSHROUDED_GS_*|ENSHROUDED_ROLE_*)
        if [[ -n "$value" ]]; then
          MENU_EXTERNAL_ENV["$name"]="$value"
        fi
        ;;
    esac
  done < <(env)
}

menu_capture_external_env
init_runtime_env

# Optional helpers we reuse when applying Enshrouded profiles (password generation, etc.)
. "$MENU_DIR/../shared/enshrouded-bootstrap-shared"

. "$MENU_DIR/ui"
. "$MENU_DIR/backups"
. "$MENU_DIR/profiles"
. "$MENU_DIR/editor_manager_json"
. "$MENU_DIR/editor_enshrouded_json"
. "$MENU_DIR/commands"
. "$MENU_DIR/enshrouded"
. "$MENU_DIR/manager"
. "$MENU_DIR/main"

MENU_NAV=""
menu_main

case "${MENU_NAV:-}" in
  exit)
    # On exit, offer to start the server if it is currently stopped.
    if ! checkRunning "enshrouded-server"; then
      ui_clear
      ui_banner
      ui_warn_line "The Enshrouded server is currently STOPPED."
      echo
      if ui_confirm_yes_no "Do you want me to start enshrouded-server before exiting?"; then
        ui_note "Starting enshrouded-server..."
        /usr/local/etc/enshrouded/entrypoints/ctl start >/dev/null 2>&1 || true
        ui_success "Start requested."
      else
        ui_note "Server remains stopped."
      fi
    fi
    ;;
esac
