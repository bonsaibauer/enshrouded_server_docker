#!/usr/bin/env bash

enshrouded_config_path() {
  printf "%s/enshrouded_server.json" "$install_path"
}

# Enshrouded JSON editors for the interactive menu.
#
# Top-level + game settings + userGroups are spec-driven via `editor_spec_json`
# (`vars.json` vars + `templates.ENSHROUDED_ROLE`).

enshrouded_editor_jq_ok() {
  local file
  file="$1"
  jq -e 'type == "object"' "$file" >/dev/null 2>&1
}

enshrouded_editor_game_settings_menu() {
  local file
  file="$1"
  menu_edit_json_from_spec \
    --title "Edit Game Settings" \
    --file "$file" \
    --metaField "enshroudedJsonPath" \
    --labelMode "path" \
    --labelStripPrefix ".gameSettings." \
    --filterPrefix ".gameSettings." \
    --backupJob "enshrouded-backup-config" \
    --emptyAction "cancel" \
    --boolToggle "false" \
    --emptyLabel "<empty>"
}

enshrouded_editor_user_groups_menu() {
  local file
  file="$1"
  menu_edit_user_groups_from_spec \
    --file "$file" \
    --template "ENSHROUDED_ROLE" \
    --envPrefix "ENSHROUDED_ROLE" \
    --backupJob "enshrouded-backup-config" \
    --emptyLabel "<empty>"
}

editor_enshrouded_json() {
  local config_file backed_up
  config_file="$(enshrouded_config_path)"
  backed_up="false"

  if [[ ! -f "$config_file" ]]; then
    ui_warn_line "enshrouded_server.json is missing. Creating from profile..."
    ensure_enshrouded_config_from_profile || true
  fi

  if [[ ! -f "$config_file" ]] || ! enshrouded_editor_jq_ok "$config_file"; then
    ui_error "Invalid or missing config: $config_file"
    ui_pause
    return 1
  fi

  if ! menu_stop_server_for_config_change "edit Enshrouded settings"; then
    return 0
  fi

  menu_edit_json_from_spec \
    --title "Edit Enshrouded Settings" \
    --file "$config_file" \
    --metaField "enshroudedMenuJsonPath" \
    --labelMode "path" \
    --backupJob "enshrouded-backup-config" \
    --emptyAction "cancel" \
    --boolToggle "true" \
    --emptyLabel "<empty>" \
    --extra "__submenu_game_settings" "gameSettings (submenu)" "Game" "enshrouded_editor_game_settings_menu" \
    --extra "__submenu_user_groups" "userGroups (submenu)" "Access" "enshrouded_editor_user_groups_menu"
}

enshrouded_select_profile_flow() {
  local mode config_file profiles profile_count idx selected profile
  mode="${1:-select}"
  config_file="$(enshrouded_config_path)"

  if ! menu_warn_env_overrides_before_enshrouded_profile_selection; then
    return 1
  fi

  mapfile -t profiles < <(profiles_list_enshrouded | sort)
  profile_count="${#profiles[@]}"
  if [[ "$profile_count" -eq 0 ]]; then
    ui_error "No Enshrouded profiles found in: $EN_PROFILE_DIR"
    ui_pause
    return 1
  fi

  while :; do
    if menu_nav_is_set; then
      return 0
    fi
    ui_header "Select Enshrouded Profile"
    ui_kv "Profiles Folder" "$EN_PROFILE_DIR"
    echo
    idx=1
    for p in "${profiles[@]}"; do
      printf "%s[%s]%s %s%s%s\n" "${C_MAGENTA}" "$idx" "${C_RESET}" "${C_GREEN}" "$p" "${C_RESET}"
      idx=$((idx + 1))
    done
    echo
    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo

    selected="$(ui_prompt_choice "Profile")"
    selected="$(echo "$selected" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$selected" in
      0)
        return 0
        ;;
      m)
        menu_nav_set "main"
        return 0
        ;;
      x|q)
        menu_nav_set "exit"
        return 0
        ;;
    esac

    if ! [[ "$selected" =~ ^[0-9]+$ ]]; then
      ui_warn_line "Invalid selection."
      ui_pause
      continue
    fi
    if [[ "$selected" -lt 1 || "$selected" -gt "$profile_count" ]]; then
      ui_warn_line "Invalid selection."
      ui_pause
      continue
    fi

    profile="${profiles[$((selected - 1))]}"

    # Only ask for confirmation when we'd impact a running server or replace an existing config.
    if checkRunning "enshrouded-server" || [[ -f "$config_file" ]]; then
      ui_warn_line "This will replace the active Enshrouded config with the selected profile."
      if [[ "$mode" == "delete" ]]; then
        ui_warn_line "Your current config will be deleted (replaced)."
      fi
      ui_warn_line "All players will be disconnected."
      echo
      ui_kv "Selected Profile" "$profile"
      ui_kv "Target File" "$config_file"
      echo
      if ! ui_confirm_yes_no "Stop server (if running) and apply this profile now?"; then
        ui_note "Cancelled."
        ui_pause
        continue
      fi
    fi

    if ! menu_write_request_json "enshrouded_profile_apply.json" --arg profile "$profile" '{profile: $profile}' >/dev/null; then
      ui_error "Failed to create request for enshrouded-profile-apply."
      ui_pause
      continue
    fi

    supervisorctl start enshrouded-profile-apply >/dev/null 2>&1 || true
    if ! menu_wait_for_program_exit "enshrouded-profile-apply" 600; then
      ui_warn_line "Timeout while waiting for enshrouded-profile-apply."
      ui_note "Check: supervisorctl status enshrouded-profile-apply"
      ui_pause
      continue
    fi

    ui_success "Enshrouded profile applied: $profile"

    echo
    ui_note "Apply changes:"
    ui_opt 1 "Start/restart Enshrouded server"
    ui_opt 2 "Run bootstrap (recommended; does not start server)"
    ui_opt 0 "Back to menu"
    echo
    case "$(ui_prompt_number "Action")" in
      1)
        supervisorctl restart enshrouded-server || true
        ui_success "Restart requested."
        ui_pause
        ;;
      2)
        supervisorctl start enshrouded-bootstrap || true
        ui_success "Bootstrap started."
        ui_note "Note: bootstrap does not start the server."
        if menu_wait_for_program_exit "enshrouded-bootstrap" 600; then
          echo
          menu_prompt_start_server "Start enshrouded-server now?"
        else
          ui_note "Start the server later once bootstrap has finished."
        fi
        ui_pause
        ;;
      0)
        ;;
      *)
        ;;
    esac

    return 0
  done
}

menu_enshrouded_settings() {
  local choice
  while :; do
    if menu_nav_is_set; then
      return 0
    fi
    ui_header "Enshrouded Server Settings"

    ui_opt 1 "Edit current settings"
    ui_opt 2 "Delete current profile"
    ui_opt 3 "Select new profile"
    echo
    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo
    choice="$(ui_prompt_choice "Choice")"
    choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$choice" in
      1)
        editor_enshrouded_json
        ;;
      2)
        enshrouded_select_profile_flow "delete" || true
        ;;
      3)
        enshrouded_select_profile_flow "select" || true
        ;;
      0)
        return 0
        ;;
      m)
        menu_nav_set "main"
        return 0
        ;;
      x|q)
        menu_nav_set "exit"
        return 0
        ;;
      *)
        ui_warn_line "Invalid selection."
        ui_pause
        ;;
    esac
  done
}
