#!/usr/bin/env bash

editor_manager_json() {
  local config_file backed_up
  config_file="$(manager_config_path)"
  backed_up="false"

  if [[ ! -f "$config_file" ]] || ! jq -e 'type == "object"' "$config_file" >/dev/null 2>&1; then
    ui_warn_line "server_manager.json is missing or invalid. Initializing..."
    update_or_create_manager_config || true
  fi

  if [[ ! -f "$config_file" ]]; then
    ui_error "Could not find server_manager.json: $config_file"
    ui_pause
    return 1
  fi

  if ! menu_stop_server_for_config_change "edit Server Manager settings"; then
    return 0
  fi

  menu_edit_json_from_spec \
    --title "Edit Server Manager Settings" \
    --file "$config_file" \
    --metaField "managerJsonPath" \
    --labelMode "var" \
    --backupJob "manual:manager" \
    --emptyAction "null" \
    --boolToggle "false" \
    --emptyLabel "<null>"
}

manager_profile_actions_after_change() {
  echo
  ui_note "Apply changes:"
  ui_opt 1 "Start/restart Enshrouded server"
  ui_opt 2 "Run bootstrap (recommended; updates cron, does not start server)"
  ui_opt 0 "Back to menu"
  echo

  case "$(ui_prompt_number "Action")" in
    1)
      supervisorctl restart enshrouded-server || true
      ui_success "Restart requested."
      ui_pause
      ;;
    2)
      supervisorctl start enshrouded-bootstrap || true
      ui_success "Bootstrap started."
      ui_note "Note: bootstrap does not start the server."
      if menu_wait_for_program_exit "enshrouded-bootstrap" 600; then
        echo
        menu_prompt_start_server "Start enshrouded-server now?"
      else
        ui_note "Start the server later once bootstrap has finished."
      fi
      ui_pause
      ;;
    0)
      ;;
    *)
      ;;
  esac
}

manager_apply_profile_flow() {
  local config_file profiles profile_count idx selected profile
  config_file="$(manager_config_path)"

  if ! menu_warn_env_overrides_before_manager_profile_selection; then
    return 1
  fi

  mapfile -t profiles < <(profiles_list_manager | sort)
  profile_count="${#profiles[@]}"
  if [[ "$profile_count" -eq 0 ]]; then
    ui_error "No Server Manager profiles found in: $MANAGER_PROFILE_TEMPLATE_DIR"
    ui_pause
    return 1
  fi

  while :; do
    if menu_nav_is_set; then
      return 0
    fi
    ui_header "Select Server Manager Profile"
    ui_kv "Profiles Folder" "$MANAGER_PROFILE_TEMPLATE_DIR"
    echo
    idx=1
    for p in "${profiles[@]}"; do
      printf "%s[%s]%s %s%s%s\n" "${C_MAGENTA}" "$idx" "${C_RESET}" "${C_GREEN}" "$p" "${C_RESET}"
      idx=$((idx + 1))
    done
    echo
    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo

    selected="$(ui_prompt_choice "Profile")"
    selected="$(echo "$selected" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$selected" in
      0) return 0 ;;
      m) menu_nav_set "main"; return 0 ;;
      x|q) menu_nav_set "exit"; return 0 ;;
    esac

    if ! [[ "$selected" =~ ^[0-9]+$ ]] || [[ "$selected" -lt 1 || "$selected" -gt "$profile_count" ]]; then
      ui_warn_line "Invalid selection."
      ui_pause
      continue
    fi

    profile="${profiles[$((selected - 1))]}"

    if checkRunning "enshrouded-server" || [[ -f "$config_file" ]]; then
      ui_warn_line "This will replace the active Server Manager config with the selected profile."
      ui_warn_line "All players will be disconnected."
      echo
      ui_kv "Selected Profile" "$profile"
      ui_kv "Target File" "$config_file"
      echo
      if ! ui_confirm_yes_no "Stop server (if running) and apply this profile now?"; then
        ui_note "Cancelled."
        ui_pause
        continue
      fi
    fi

    if ! menu_write_request_json "profile.json" \
      --arg target "manager" \
      --arg action "apply" \
      --arg profile "$profile" \
      '{target: $target, action: $action, profile: $profile}' >/dev/null; then
      ui_error "Failed to create request for profile."
      ui_pause
      continue
    fi

    supervisorctl start profile >/dev/null 2>&1 || true
    if ! menu_wait_for_program_exit "profile" 600; then
      ui_warn_line "Timeout while waiting for profile."
      ui_note "Check: supervisorctl status profile"
      ui_pause
      continue
    fi

    ui_success "Server Manager profile applied: $profile"
    manager_profile_actions_after_change
    return 0
  done
}

manager_reset_profile_flow() {
  local profile config_file
  config_file="$(manager_config_path)"
  profile="$(manager_profile_resolve)"

  ui_header "Reset Server Manager Profile"
  ui_warn_line "This resets server_manager.json from the currently selected profile."
  ui_warn_line "All players will be disconnected."
  echo
  ui_kv "Profile" "$profile"
  ui_kv "Target File" "$config_file"
  echo

  if ! ui_confirm_yes_no "Stop server (if running) and reset now?"; then
    ui_note "Cancelled."
    ui_pause
    return 0
  fi

  if ! menu_write_request_json "profile.json" \
    --arg target "manager" \
    --arg action "reset" \
    --arg profile "$profile" \
    '{target: $target, action: $action, profile: $profile}' >/dev/null; then
    ui_error "Failed to create request for profile reset."
    ui_pause
    return 1
  fi

  supervisorctl start profile >/dev/null 2>&1 || true
  if ! menu_wait_for_program_exit "profile" 600; then
    ui_warn_line "Timeout while waiting for profile."
    ui_note "Check: supervisorctl status profile"
    ui_pause
    return 1
  fi

  ui_success "Server Manager profile reset completed: $profile"
  manager_profile_actions_after_change
  return 0
}

menu_manager_settings() {
  local choice
  while :; do
    if menu_nav_is_set; then
      return 0
    fi
    ui_header "Server Manager Settings"

    ui_opt 1 "Edit current settings"
    ui_opt 2 "Reset current profile"
    ui_opt 3 "Select and apply profile"
    echo
    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo
    choice="$(ui_prompt_choice "Choice")"
    choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$choice" in
      1) editor_manager_json ;;
      2) manager_reset_profile_flow || true ;;
      3) manager_apply_profile_flow || true ;;
      0) return 0 ;;
      m) menu_nav_set "main"; return 0 ;;
      x|q) menu_nav_set "exit"; return 0 ;;
      *)
        ui_warn_line "Invalid selection."
        ui_pause
        ;;
    esac
  done
}
