#!/usr/bin/env bash

enshrouded_editor_cfg() {
  printf "%s/enshrouded_server.json" "$install_path"
}

enshrouded_editor_jq_ok() {
  local file
  file="$1"
  jq -e 'type == "object"' "$file" >/dev/null 2>&1
}

enshrouded_editor_get_compact() {
  local file path
  file="$1"
  path="$2"
  jq -c "$path" "$file" 2>/dev/null || echo "null"
}

enshrouded_editor_get_raw() {
  local file path
  file="$1"
  path="$2"
  jq -r "$path // empty" "$file" 2>/dev/null || echo ""
}

enshrouded_editor_session_backup_if_needed() {
  # Create exactly one config backup per edit session (first write wins).
  # Uses dynamic scope: the calling editor sets `backed_up=false` locally.
  local file
  file="$1"

  if [[ "${backed_up:-false}" == "true" ]]; then
    return 0
  fi

  backup_config_file "$file" "enshrouded_server" || true
  backed_up="true"
  return 0
}

enshrouded_editor_set_jq() {
  local file tmp
  file="$1"
  shift
  enshrouded_editor_session_backup_if_needed "$file"
  tmp="$(mktemp)"
  if jq "$@" "$file" >"$tmp"; then
    mv "$tmp" "$file"
    chmod 600 "$file" 2>/dev/null || true
    chown enshrouded:enshrouded "$file" 2>/dev/null || true
    return 0
  fi
  rm -f "$tmp"
  return 1
}

enshrouded_validate_ipv4_soft() {
  local value
  value="$1"
  if [[ -z "$value" ]]; then
    ui_warn_line "IP must not be empty."
    return 1
  fi
  if ! [[ "$value" =~ ^([0-9]{1,3}\\.){3}[0-9]{1,3}$ ]]; then
    ui_warn_line "Invalid IPv4: $value"
    return 1
  fi
  return 0
}

enshrouded_validate_int_range_soft() {
  local name value min max
  name="$1"
  value="$2"
  min="$3"
  max="$4"
  if [[ -z "$value" ]] || ! [[ "$value" =~ ^[0-9]+$ ]]; then
    ui_warn_line "$name must be a number (actual: $value)"
    return 1
  fi
  if [[ "$value" -lt "$min" || "$value" -gt "$max" ]]; then
    ui_warn_line "$name must be between $min and $max (actual: $value)"
    return 1
  fi
  return 0
}

enshrouded_validate_bool_soft_local() {
  local name value normalized
  name="$1"
  value="$2"
  normalized="$(echo "$value" | tr '[:upper:]' '[:lower:]')"
  if [[ "$normalized" != "true" && "$normalized" != "false" ]]; then
    ui_warn_line "$name must be true or false (actual: $value)"
    return 1
  fi
  return 0
}

enshrouded_prompt_scalar() {
  local label current hint value normalized
  label="$1"
  current="$2"
  hint="$3"

  echo
  ui_kv "Field" "$label"
  ui_kv "Current" "${current:-<empty>}"
  if [[ -n "$hint" ]]; then
    ui_note "$hint"
  fi
  echo

  value="$(ui_read "New value (empty = cancel): ")"
  value="$(echo "$value" | xargs)"
  normalized="$(echo "$value" | tr '[:upper:]' '[:lower:]')"
  case "$normalized" in
    1|ja|j|y|yes) value="true" ;;
    0|nein|n|no) value="false" ;;
  esac
  printf "%s" "$value"
}

enshrouded_editor_block_if_env_locked() {
  # Returns 0 if editable, 1 if locked by external env override.
  local env_var env_value
  env_var="$1"

  if ! declare -F menu_env_override_is_set >/dev/null 2>&1; then
    return 0
  fi
  if ! menu_env_override_is_set "$env_var"; then
    return 0
  fi

  env_value="$(menu_env_override_value "$env_var")"
  ui_warn_line "This setting is controlled by an environment variable and cannot be edited here."
  ui_kv "ENV" "$env_var=$(menu_env_override_pretty_value "$env_var" "$env_value")"
  ui_note "Remove it from your docker-compose/container environment to edit this value."
  ui_pause
  return 1
}

enshrouded_editor_role_locked_badge() {
  local g env_var
  g="$1"

  if ! declare -F menu_env_override_is_set >/dev/null 2>&1; then
    return 0
  fi

  for env_var in \
    "ENSHROUDED_ROLE_${g}_NAME" \
    "ENSHROUDED_ROLE_${g}_PASSWORD" \
    "ENSHROUDED_ROLE_${g}_RESERVED_SLOTS" \
    "ENSHROUDED_ROLE_${g}_CAN_KICK_BAN" \
    "ENSHROUDED_ROLE_${g}_CAN_ACCESS_INVENTORIES" \
    "ENSHROUDED_ROLE_${g}_CAN_EDIT_WORLD" \
    "ENSHROUDED_ROLE_${g}_CAN_EDIT_BASE" \
    "ENSHROUDED_ROLE_${g}_CAN_EXTEND_BASE"; do
    if menu_env_override_is_set "$env_var"; then
      printf " %s" "${C_RED}[ENV]${C_RESET}"
      return 0
    fi
  done

  return 0
}

enshrouded_editor_set_string() {
  local file path value
  file="$1"
  path="$2"
  value="$3"
  enshrouded_editor_set_jq "$file" --arg val "$value" "$path = \$val"
}

enshrouded_editor_set_number() {
  local file path value
  file="$1"
  path="$2"
  value="$3"
  enshrouded_editor_set_jq "$file" --argjson val "$value" "$path = \$val"
}

enshrouded_editor_set_bool() {
  local file path value
  file="$1"
  path="$2"
  value="$3"
  enshrouded_editor_set_jq "$file" --argjson val "$value" "$path = \$val"
}

enshrouded_editor_set_tags() {
  local file tags_csv
  file="$1"
  tags_csv="$2"
  if [[ -z "$tags_csv" ]]; then
    enshrouded_editor_set_jq "$file" '.tags = []'
    return $?
  fi
  if ! validate_tags "$tags_csv"; then
    return 1
  fi
  enshrouded_editor_set_jq "$file" --arg tags "$tags_csv" '.tags = ($tags | split(",") | map(gsub("^\\s+|\\s+$";"")) | map(select(length>0)))'
}

enshrouded_editor_game_settings_definitions() {
  # Format: jsonKey:type:suffixForValidation
  cat <<'EOF'
playerHealthFactor:number:PLAYER_HEALTH_FACTOR
playerManaFactor:number:PLAYER_MANA_FACTOR
playerStaminaFactor:number:PLAYER_STAMINA_FACTOR
playerBodyHeatFactor:number:PLAYER_BODY_HEAT_FACTOR
playerDivingTimeFactor:number:PLAYER_DIVING_TIME_FACTOR
enableDurability:bool:ENABLE_DURABILITY
enableStarvingDebuff:bool:ENABLE_STARVING_DEBUFF
foodBuffDurationFactor:number:FOOD_BUFF_DURATION_FACTOR
fromHungerToStarving:number:FROM_HUNGER_TO_STARVING
shroudTimeFactor:number:SHROUD_TIME_FACTOR
tombstoneMode:string:TOMBSTONE_MODE
enableGliderTurbulences:bool:ENABLE_GLIDER_TURBULENCES
weatherFrequency:string:WEATHER_FREQUENCY
fishingDifficulty:string:FISHING_DIFFICULTY
miningDamageFactor:number:MINING_DAMAGE_FACTOR
plantGrowthSpeedFactor:number:PLANT_GROWTH_SPEED_FACTOR
resourceDropStackAmountFactor:number:RESOURCE_DROP_STACK_AMOUNT_FACTOR
factoryProductionSpeedFactor:number:FACTORY_PRODUCTION_SPEED_FACTOR
perkUpgradeRecyclingFactor:number:PERK_UPGRADE_RECYCLING_FACTOR
perkCostFactor:number:PERK_COST_FACTOR
experienceCombatFactor:number:EXPERIENCE_COMBAT_FACTOR
experienceMiningFactor:number:EXPERIENCE_MINING_FACTOR
experienceExplorationQuestsFactor:number:EXPERIENCE_EXPLORATION_QUESTS_FACTOR
randomSpawnerAmount:string:RANDOM_SPAWNER_AMOUNT
aggroPoolAmount:string:AGGRO_POOL_AMOUNT
enemyDamageFactor:number:ENEMY_DAMAGE_FACTOR
enemyHealthFactor:number:ENEMY_HEALTH_FACTOR
enemyStaminaFactor:number:ENEMY_STAMINA_FACTOR
enemyPerceptionRangeFactor:number:ENEMY_PERCEPTION_RANGE_FACTOR
bossDamageFactor:number:BOSS_DAMAGE_FACTOR
bossHealthFactor:number:BOSS_HEALTH_FACTOR
threatBonus:number:THREAT_BONUS
pacifyAllEnemies:bool:PACIFY_ALL_ENEMIES
tamingStartleRepercussion:string:TAMING_STARTLE_REPERCUSSION
dayTimeDuration:number:DAY_TIME_DURATION
nightTimeDuration:number:NIGHT_TIME_DURATION
curseModifier:string:CURSE_MODIFIER
EOF
}

enshrouded_editor_game_settings_menu() {
  local file choice
  file="$1"

  local -a defs keys types suffixes
  mapfile -t defs < <(enshrouded_editor_game_settings_definitions)
  keys=()
  types=()
  suffixes=()

  local d k t s
  for d in "${defs[@]}"; do
    k="${d%%:*}"
    t="${d#*:}"; t="${t%%:*}"
    s="${d##*:}"
    keys+=("$k")
    types+=("$t")
    suffixes+=("$s")
  done

  while :; do
    if menu_nav_is_set; then
      return 0
    fi
    ui_header "Edit Game Settings"
    ui_note "Note: empty input cancels editing (no null writes)."
    ui_note "[ENV] = controlled by container environment (locked)"
    echo

    local i idx current env_var
    idx=1

    echo "${C_DIM}== Player ==${C_RESET}"
    for i in 0 1 2 3 4; do
      env_var="ENSHROUDED_GS_${suffixes[$i]}"
      if menu_env_override_is_set "$env_var"; then
        current="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "$env_var")" "${C_RESET}")"
      else
        current="$(printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_compact "$file" ".gameSettings.${keys[$i]}")" "${C_RESET}")"
      fi
      printf "%s[%s]%s %-36s %s%s\n" "${C_MAGENTA}" "$idx" "${C_RESET}" "${keys[$i]}" "$current" "$(menu_env_locked_badge "$env_var")"
      idx=$((idx + 1))
    done
    echo

    echo "${C_DIM}== Survival / World ==${C_RESET}"
    for i in 5 6 7 8 9 10 11 12 13; do
      env_var="ENSHROUDED_GS_${suffixes[$i]}"
      if menu_env_override_is_set "$env_var"; then
        current="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "$env_var")" "${C_RESET}")"
      else
        current="$(printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_compact "$file" ".gameSettings.${keys[$i]}")" "${C_RESET}")"
      fi
      printf "%s[%s]%s %-36s %s%s\n" "${C_MAGENTA}" "$idx" "${C_RESET}" "${keys[$i]}" "$current" "$(menu_env_locked_badge "$env_var")"
      idx=$((idx + 1))
    done
    echo

    echo "${C_DIM}== Economy / Progress ==${C_RESET}"
    for i in 14 15 16 17 18 19 20 21 22; do
      env_var="ENSHROUDED_GS_${suffixes[$i]}"
      if menu_env_override_is_set "$env_var"; then
        current="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "$env_var")" "${C_RESET}")"
      else
        current="$(printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_compact "$file" ".gameSettings.${keys[$i]}")" "${C_RESET}")"
      fi
      printf "%s[%s]%s %-36s %s%s\n" "${C_MAGENTA}" "$idx" "${C_RESET}" "${keys[$i]}" "$current" "$(menu_env_locked_badge "$env_var")"
      idx=$((idx + 1))
    done
    echo

    echo "${C_DIM}== Enemies ==${C_RESET}"
    for i in 23 24 25 26 27 28 29 30 31 32 33; do
      env_var="ENSHROUDED_GS_${suffixes[$i]}"
      if menu_env_override_is_set "$env_var"; then
        current="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "$env_var")" "${C_RESET}")"
      else
        current="$(printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_compact "$file" ".gameSettings.${keys[$i]}")" "${C_RESET}")"
      fi
      printf "%s[%s]%s %-36s %s%s\n" "${C_MAGENTA}" "$idx" "${C_RESET}" "${keys[$i]}" "$current" "$(menu_env_locked_badge "$env_var")"
      idx=$((idx + 1))
    done
    echo

    echo "${C_DIM}== Time ==${C_RESET}"
    for i in 34 35; do
      env_var="ENSHROUDED_GS_${suffixes[$i]}"
      if menu_env_override_is_set "$env_var"; then
        current="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "$env_var")" "${C_RESET}")"
      else
        current="$(printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_compact "$file" ".gameSettings.${keys[$i]}")" "${C_RESET}")"
      fi
      printf "%s[%s]%s %-36s %s%s\n" "${C_MAGENTA}" "$idx" "${C_RESET}" "${keys[$i]}" "$current" "$(menu_env_locked_badge "$env_var")"
      idx=$((idx + 1))
    done
    echo

    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo

    choice="$(ui_prompt_choice "Choice")"
    choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$choice" in
      0)
        return 0
        ;;
      m)
        menu_nav_set "main"
        return 0
        ;;
      x|q)
        menu_nav_set "exit"
        return 0
        ;;
    esac

    if ! [[ "$choice" =~ ^[0-9]+$ ]]; then
      ui_warn_line "Invalid selection."
      ui_pause
      continue
    fi

    local key_index new_value key type suffix path current_raw
    key_index=$((choice - 1))
    if [[ "$key_index" -lt 0 || "$key_index" -ge "${#keys[@]}" ]]; then
      ui_warn_line "Invalid selection."
      ui_pause
      continue
    fi

    key="${keys[$key_index]}"
    type="${types[$key_index]}"
    suffix="${suffixes[$key_index]}"
    path=".gameSettings.${key}"
    current_raw="$(enshrouded_editor_get_raw "$file" "$path")"

    if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_GS_${suffix}"; then
      continue
    fi

    new_value="$(enshrouded_prompt_scalar "$key" "$current_raw" "")"
    if [[ -z "$new_value" ]]; then
      ui_note "Cancelled."
      ui_pause
      continue
    fi

    if ! validate_game_setting "$suffix" "$new_value"; then
      ui_warn_line "Invalid value, not saved."
      ui_pause
      continue
    fi

    case "$type" in
      bool)
        new_value="$(echo "$new_value" | tr '[:upper:]' '[:lower:]')"
        if ! enshrouded_validate_bool_soft_local "$key" "$new_value"; then
          ui_pause
          continue
        fi
        enshrouded_editor_set_bool "$file" "$path" "$new_value" || true
        ;;
      number)
        if ! is_number "$new_value"; then
          ui_warn_line "Must be numeric (actual: $new_value)"
          ui_pause
          continue
        fi
        enshrouded_editor_set_number "$file" "$path" "$new_value" || true
        ;;
      *)
        enshrouded_editor_set_string "$file" "$path" "$new_value" || true
        ;;
    esac

  done
}

enshrouded_editor_user_groups_menu() {
  local file choice count idx name
  file="$1"

  while :; do
    if menu_nav_is_set; then
      return 0
    fi
    ui_header "Edit User Groups"
    ui_note "[ENV] = controlled by container environment (locked)"
    count="$(jq -r '.userGroups | length' "$file" 2>/dev/null || echo 0)"
    if ! [[ "$count" =~ ^[0-9]+$ ]]; then
      count=0
    fi

    if [[ "$count" -le 0 ]]; then
      ui_warn_line "No userGroups found."
      echo
      ui_actions_bar "0 Back" "m Main" "x Exit"
      echo
      choice="$(ui_prompt_choice "Choice")"
      choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
      case "$choice" in
        0) return 0 ;;
        m) menu_nav_set "main"; return 0 ;;
        x|q) menu_nav_set "exit"; return 0 ;;
      esac
      continue
    fi

    for idx in $(seq 0 $((count - 1))); do
      name="$(jq -r ".userGroups[$idx].name // \"Group $idx\"" "$file" 2>/dev/null || echo "Group $idx")"
      printf "%s[%s]%s %s%s%s\n" "${C_MAGENTA}" "$((idx + 1))" "${C_RESET}" "${C_GREEN}" "$name" "${C_RESET}$(enshrouded_editor_role_locked_badge "$idx")"
    done
    echo
    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo
    choice="$(ui_prompt_choice "Group")"
    choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$choice" in
      0) return 0 ;;
      m) menu_nav_set "main"; return 0 ;;
      x|q) menu_nav_set "exit"; return 0 ;;
    esac

    if ! [[ "$choice" =~ ^[0-9]+$ ]]; then
      ui_warn_line "Invalid selection."
      ui_pause
      continue
    fi

    local g
    g=$((choice - 1))
    if [[ "$g" -lt 0 || "$g" -ge "$count" ]]; then
      ui_warn_line "Invalid selection."
      ui_pause
      continue
    fi

    # Group editor
    while :; do
      if menu_nav_is_set; then
        return 0
      fi

      local base current_name current_pw reserved ck ci cw cb ce
      local name_display pw_display reserved_display ck_display ci_display cw_display cb_display ce_display
      base=".userGroups[$g]"
      current_name="$(enshrouded_editor_get_raw "$file" "$base.name")"
      current_pw="$(jq -r "$base.password | if . == null then \"<null>\" elif . == \"\" then \"<empty>\" else . end" "$file" 2>/dev/null || echo "")"
      reserved="$(enshrouded_editor_get_raw "$file" "$base.reservedSlots")"
      ck="$(enshrouded_editor_get_raw "$file" "$base.canKickBan")"
      ci="$(enshrouded_editor_get_raw "$file" "$base.canAccessInventories")"
      cw="$(enshrouded_editor_get_raw "$file" "$base.canEditWorld")"
      cb="$(enshrouded_editor_get_raw "$file" "$base.canEditBase")"
      ce="$(enshrouded_editor_get_raw "$file" "$base.canExtendBase")"

      ui_header "User Group: ${current_name:-Group $g}"
      ui_note "[ENV] = controlled by container environment (locked)"

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_NAME"; then
        name_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_NAME")" "${C_RESET}")"
      elif [[ -z "$current_name" ]]; then
        name_display="${C_DIM}<empty>${C_RESET}"
      else
        name_display="$(printf "%s%s%s" "${C_GREEN}" "$current_name" "${C_RESET}")"
      fi

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_PASSWORD"; then
        pw_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_PASSWORD")" "${C_RESET}")"
      elif [[ -z "$current_pw" ]]; then
        pw_display="${C_DIM}<empty>${C_RESET}"
      else
        pw_display="$(printf "%s%s%s" "${C_GREEN}" "$current_pw" "${C_RESET}")"
      fi

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_RESERVED_SLOTS"; then
        reserved_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_RESERVED_SLOTS")" "${C_RESET}")"
      elif [[ -z "$reserved" ]]; then
        reserved_display="${C_DIM}0${C_RESET}"
      else
        reserved_display="$(printf "%s%s%s" "${C_GREEN}" "$reserved" "${C_RESET}")"
      fi

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_CAN_KICK_BAN"; then
        ck_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_CAN_KICK_BAN")" "${C_RESET}")"
      else
        ck_display="$(printf "%s%s%s" "${C_GREEN}" "${ck:-false}" "${C_RESET}")"
      fi

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_CAN_ACCESS_INVENTORIES"; then
        ci_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_CAN_ACCESS_INVENTORIES")" "${C_RESET}")"
      else
        ci_display="$(printf "%s%s%s" "${C_GREEN}" "${ci:-false}" "${C_RESET}")"
      fi

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_CAN_EDIT_WORLD"; then
        cw_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_CAN_EDIT_WORLD")" "${C_RESET}")"
      else
        cw_display="$(printf "%s%s%s" "${C_GREEN}" "${cw:-false}" "${C_RESET}")"
      fi

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_CAN_EDIT_BASE"; then
        cb_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_CAN_EDIT_BASE")" "${C_RESET}")"
      else
        cb_display="$(printf "%s%s%s" "${C_GREEN}" "${cb:-false}" "${C_RESET}")"
      fi

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_CAN_EXTEND_BASE"; then
        ce_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_CAN_EXTEND_BASE")" "${C_RESET}")"
      else
        ce_display="$(printf "%s%s%s" "${C_GREEN}" "${ce:-false}" "${C_RESET}")"
      fi

      printf "%s[1]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "name" "$name_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_NAME")"
      printf "%s[2]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "password" "$pw_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_PASSWORD")"
      printf "%s[3]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "reservedSlots" "$reserved_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_RESERVED_SLOTS")"
      printf "%s[4]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "canKickBan" "$ck_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_CAN_KICK_BAN")"
      printf "%s[5]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "canAccessInventories" "$ci_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_CAN_ACCESS_INVENTORIES")"
      printf "%s[6]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "canEditWorld" "$cw_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_CAN_EDIT_WORLD")"
      printf "%s[7]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "canEditBase" "$cb_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_CAN_EDIT_BASE")"
      printf "%s[8]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "canExtendBase" "$ce_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_CAN_EXTEND_BASE")"
      echo
      ui_actions_bar "0 Back" "m Main" "x Exit"
      echo

      local c
      c="$(ui_prompt_choice "Choice")"
      c="$(echo "$c" | tr '[:upper:]' '[:lower:]' | xargs)"
      case "$c" in
        0)
          break
          ;;
        m)
          menu_nav_set "main"
          return 0
          ;;
        x|q)
          menu_nav_set "exit"
          return 0
          ;;
      esac

      if ! [[ "$c" =~ ^[0-9]+$ ]]; then
        ui_warn_line "Invalid selection."
        ui_pause
        continue
      fi

      case "$c" in
        1)
          if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_ROLE_${g}_NAME"; then
            continue
          fi
          local v
          v="$(enshrouded_prompt_scalar "name" "$current_name" "")"
          if [[ -z "$v" ]]; then
            ui_note "Cancelled."
            ui_pause
          else
            enshrouded_editor_set_string "$file" "$base.name" "$v" || true
          fi
          ;;
        2)
          if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_ROLE_${g}_PASSWORD"; then
            continue
          fi
          local v
          echo
          ui_note "Empty = password will be set to null (may be auto-generated after bootstrap)."
          v="$(ui_read "New password: ")"
          v="$(echo "$v" | xargs)"
          if [[ -z "$v" ]]; then
            enshrouded_editor_set_jq "$file" "$base.password = null" || true
          else
            enshrouded_editor_set_string "$file" "$base.password" "$v" || true
          fi
          ;;
        3)
          if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_ROLE_${g}_RESERVED_SLOTS"; then
            continue
          fi
          local v
          v="$(enshrouded_prompt_scalar "reservedSlots" "$reserved" "Allowed: integer >= 0")"
          if [[ -z "$v" ]]; then
            ui_note "Cancelled."
            ui_pause
          elif ! [[ "$v" =~ ^[0-9]+$ ]]; then
            ui_warn_line "reservedSlots must be numeric."
            ui_pause
          else
            enshrouded_editor_set_number "$file" "$base.reservedSlots" "$v" || true
          fi
          ;;
        4|5|6|7|8)
          local field cur next env_var
          case "$c" in
            4) field="canKickBan" ;;
            5) field="canAccessInventories" ;;
            6) field="canEditWorld" ;;
            7) field="canEditBase" ;;
            8) field="canExtendBase" ;;
          esac
          case "$field" in
            canKickBan) env_var="ENSHROUDED_ROLE_${g}_CAN_KICK_BAN" ;;
            canAccessInventories) env_var="ENSHROUDED_ROLE_${g}_CAN_ACCESS_INVENTORIES" ;;
            canEditWorld) env_var="ENSHROUDED_ROLE_${g}_CAN_EDIT_WORLD" ;;
            canEditBase) env_var="ENSHROUDED_ROLE_${g}_CAN_EDIT_BASE" ;;
            canExtendBase) env_var="ENSHROUDED_ROLE_${g}_CAN_EXTEND_BASE" ;;
            *) env_var="" ;;
          esac
          if [[ -n "$env_var" ]] && ! enshrouded_editor_block_if_env_locked "$env_var"; then
            continue
          fi
          cur="$(enshrouded_editor_get_raw "$file" "$base.$field")"
          if [[ "$cur" == "true" ]]; then
            next="false"
          else
            next="true"
          fi
          enshrouded_editor_set_bool "$file" "$base.$field" "$next" || true
          ;;
        *)
          ui_warn_line "Invalid selection."
          ui_pause
          ;;
      esac
    done
  done
}

editor_enshrouded_json() {
  local config_file choice field_count backed_up
  config_file="$(enshrouded_editor_cfg)"
  backed_up="false"

  if [[ ! -f "$config_file" ]]; then
    ui_warn_line "enshrouded_server.json is missing. Creating from profile..."
    ensure_enshrouded_config_from_profile || true
  fi

  if [[ ! -f "$config_file" ]] || ! enshrouded_editor_jq_ok "$config_file"; then
    ui_error "Invalid or missing config: $config_file"
    ui_pause
    return 1
  fi

  if ! menu_stop_server_for_config_change "edit Enshrouded settings"; then
    return 0
  fi

  while :; do
    if menu_nav_is_set; then
      return 0
    fi

    ui_header "Edit Enshrouded Settings"
    ui_kv "File" "$(menu_display_path "$config_file")"
    ui_note "Changes are written immediately."
    ui_note "[ENV] = controlled by container environment (locked)"
    echo

    field_count=0

    echo "${C_DIM}== Server ==${C_RESET}"
    field_count=$((field_count + 1)); printf "%s[%s]%s %-24s %s%s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "name" "$(menu_env_override_is_set "ENSHROUDED_NAME" && printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_NAME")" "${C_RESET}" || printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_raw "$config_file" '.name')" "${C_RESET}")" "$(menu_env_locked_badge "ENSHROUDED_NAME")"
    field_count=$((field_count + 1)); printf "%s[%s]%s %-24s %s%s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "ip" "$(menu_env_override_is_set "ENSHROUDED_IP" && printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_IP")" "${C_RESET}" || printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_raw "$config_file" '.ip')" "${C_RESET}")" "$(menu_env_locked_badge "ENSHROUDED_IP")"
    field_count=$((field_count + 1)); printf "%s[%s]%s %-24s %s%s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "queryPort" "$(menu_env_override_is_set "ENSHROUDED_QUERY_PORT" && printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_QUERY_PORT")" "${C_RESET}" || printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_raw "$config_file" '.queryPort')" "${C_RESET}")" "$(menu_env_locked_badge "ENSHROUDED_QUERY_PORT")"
    field_count=$((field_count + 1)); printf "%s[%s]%s %-24s %s%s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "slotCount" "$(menu_env_override_is_set "ENSHROUDED_SLOT_COUNT" && printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_SLOT_COUNT")" "${C_RESET}" || printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_raw "$config_file" '.slotCount')" "${C_RESET}")" "$(menu_env_locked_badge "ENSHROUDED_SLOT_COUNT")"
    field_count=$((field_count + 1)); printf "%s[%s]%s %-24s %s%s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "saveDirectory" "$(menu_env_override_is_set "ENSHROUDED_SAVE_DIR" && printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_SAVE_DIR")" "${C_RESET}" || printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_raw "$config_file" '.saveDirectory')" "${C_RESET}")" "$(menu_env_locked_badge "ENSHROUDED_SAVE_DIR")"
    field_count=$((field_count + 1)); printf "%s[%s]%s %-24s %s%s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "logDirectory" "$(menu_env_override_is_set "ENSHROUDED_LOG_DIR" && printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_LOG_DIR")" "${C_RESET}" || printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_raw "$config_file" '.logDirectory')" "${C_RESET}")" "$(menu_env_locked_badge "ENSHROUDED_LOG_DIR")"
    field_count=$((field_count + 1)); printf "%s[%s]%s %-24s %s%s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "tags" "$(menu_env_override_is_set "ENSHROUDED_TAGS" && printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_TAGS")" "${C_RESET}" || printf "%s%s%s" "${C_GREEN}" "$(jq -r '.tags // [] | join(\",\")' "$config_file" 2>/dev/null || echo "")" "${C_RESET}")" "$(menu_env_locked_badge "ENSHROUDED_TAGS")"
    echo

    echo "${C_DIM}== Voice / Text ==${C_RESET}"
    field_count=$((field_count + 1)); printf "%s[%s]%s %-24s %s%s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "voiceChatMode" "$(menu_env_override_is_set "ENSHROUDED_VOICE_CHAT_MODE" && printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_VOICE_CHAT_MODE")" "${C_RESET}" || printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_raw "$config_file" '.voiceChatMode')" "${C_RESET}")" "$(menu_env_locked_badge "ENSHROUDED_VOICE_CHAT_MODE")"
    field_count=$((field_count + 1)); printf "%s[%s]%s %-24s %s%s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "enableVoiceChat" "$(menu_env_override_is_set "ENSHROUDED_ENABLE_VOICE_CHAT" && printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ENABLE_VOICE_CHAT")" "${C_RESET}" || printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_raw "$config_file" '.enableVoiceChat')" "${C_RESET}")" "$(menu_env_locked_badge "ENSHROUDED_ENABLE_VOICE_CHAT")"
    field_count=$((field_count + 1)); printf "%s[%s]%s %-24s %s%s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "enableTextChat" "$(menu_env_override_is_set "ENSHROUDED_ENABLE_TEXT_CHAT" && printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ENABLE_TEXT_CHAT")" "${C_RESET}" || printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_raw "$config_file" '.enableTextChat')" "${C_RESET}")" "$(menu_env_locked_badge "ENSHROUDED_ENABLE_TEXT_CHAT")"
    echo

    echo "${C_DIM}== Game ==${C_RESET}"
    field_count=$((field_count + 1)); printf "%s[%s]%s %-24s %s%s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "gameSettingsPreset" "$(menu_env_override_is_set "ENSHROUDED_GS_PRESET" && printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_GS_PRESET")" "${C_RESET}" || printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_raw "$config_file" '.gameSettingsPreset')" "${C_RESET}")" "$(menu_env_locked_badge "ENSHROUDED_GS_PRESET")"
    field_count=$((field_count + 1)); printf "%s[%s]%s %-24s %s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "gameSettings (submenu)" "${C_DIM}<enter>${C_RESET}"
    echo

    echo "${C_DIM}== Access ==${C_RESET}"
    field_count=$((field_count + 1)); printf "%s[%s]%s %-24s %s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "userGroups (submenu)" "${C_DIM}<enter>${C_RESET}"
    echo

    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo

    choice="$(ui_prompt_choice "Choice")"
    choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$choice" in
      0)
        return 0
        ;;
      m)
        menu_nav_set "main"
        return 0
        ;;
      x|q)
        menu_nav_set "exit"
        return 0
        ;;
    esac

    case "$choice" in
      1)
        if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_NAME"; then
          continue
        fi
        local v
        v="$(enshrouded_prompt_scalar "name" "$(enshrouded_editor_get_raw "$config_file" '.name')" "")"
        if [[ -n "$v" ]]; then
          enshrouded_editor_set_string "$config_file" ".name" "$v" || true
        fi
        ;;
      2)
        if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_IP"; then
          continue
        fi
        local v
        v="$(enshrouded_prompt_scalar "ip" "$(enshrouded_editor_get_raw "$config_file" '.ip')" "IPv4 e.g. 0.0.0.0")"
        if [[ -n "$v" ]]; then
          if enshrouded_validate_ipv4_soft "$v"; then
            enshrouded_editor_set_string "$config_file" ".ip" "$v" || true
          else
            ui_pause
          fi
        fi
        ;;
      3)
        if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_QUERY_PORT"; then
          continue
        fi
        local v
        v="$(enshrouded_prompt_scalar "queryPort" "$(enshrouded_editor_get_raw "$config_file" '.queryPort')" "1..65535")"
        if [[ -n "$v" ]]; then
          if enshrouded_validate_int_range_soft "queryPort" "$v" 1 65535; then
            enshrouded_editor_set_number "$config_file" ".queryPort" "$v" || true
          else
            ui_pause
          fi
        fi
        ;;
      4)
        if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_SLOT_COUNT"; then
          continue
        fi
        local v
        v="$(enshrouded_prompt_scalar "slotCount" "$(enshrouded_editor_get_raw "$config_file" '.slotCount')" "1..16")"
        if [[ -n "$v" ]]; then
          if enshrouded_validate_int_range_soft "slotCount" "$v" 1 16; then
            enshrouded_editor_set_number "$config_file" ".slotCount" "$v" || true
          else
            ui_pause
          fi
        fi
        ;;
      5)
        if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_SAVE_DIR"; then
          continue
        fi
        local v
        v="$(enshrouded_prompt_scalar "saveDirectory" "$(enshrouded_editor_get_raw "$config_file" '.saveDirectory')" "")"
        if [[ -n "$v" ]]; then
          enshrouded_editor_set_string "$config_file" ".saveDirectory" "$v" || true
        fi
        ;;
      6)
        if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_LOG_DIR"; then
          continue
        fi
        local v
        v="$(enshrouded_prompt_scalar "logDirectory" "$(enshrouded_editor_get_raw "$config_file" '.logDirectory')" "")"
        if [[ -n "$v" ]]; then
          enshrouded_editor_set_string "$config_file" ".logDirectory" "$v" || true
        fi
        ;;
      7)
        if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_TAGS"; then
          continue
        fi
        local v
        echo
        ui_note "Comma-separated, allowed: A-Z a-z 0-9 . _ -"
        ui_note "Empty = [] (clears all tags)"
        v="$(ui_read "Tags: ")"
        v="$(echo "$v" | xargs)"
        if ! enshrouded_editor_set_tags "$config_file" "$v"; then
          ui_pause
        fi
        ;;
      8)
        if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_VOICE_CHAT_MODE"; then
          continue
        fi
        local v
        v="$(enshrouded_prompt_scalar "voiceChatMode" "$(enshrouded_editor_get_raw "$config_file" '.voiceChatMode')" "Proximity | Global")"
        if [[ -n "$v" ]]; then
          if validate_enum_soft "voiceChatMode" "$v" Proximity Global; then
            enshrouded_editor_set_string "$config_file" ".voiceChatMode" "$v" || true
          else
            ui_pause
          fi
        fi
        ;;
      9)
        if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_ENABLE_VOICE_CHAT"; then
          continue
        fi
        local v cur
        cur="$(enshrouded_editor_get_raw "$config_file" '.enableVoiceChat')"
        ui_note "Enter = toggle (current: ${cur:-false})"
        v="$(ui_read "New value (true/false or empty): ")"
        v="$(echo "$v" | xargs)"
        if [[ -z "$v" ]]; then
          if [[ "$cur" == "true" ]]; then v="false"; else v="true"; fi
        fi
        v="$(echo "$v" | tr '[:upper:]' '[:lower:]')"
        if enshrouded_validate_bool_soft_local "enableVoiceChat" "$v"; then
          enshrouded_editor_set_bool "$config_file" ".enableVoiceChat" "$v" || true
        else
          ui_pause
        fi
        ;;
      10)
        if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_ENABLE_TEXT_CHAT"; then
          continue
        fi
        local v cur
        cur="$(enshrouded_editor_get_raw "$config_file" '.enableTextChat')"
        ui_note "Enter = toggle (current: ${cur:-false})"
        v="$(ui_read "New value (true/false or empty): ")"
        v="$(echo "$v" | xargs)"
        if [[ -z "$v" ]]; then
          if [[ "$cur" == "true" ]]; then v="false"; else v="true"; fi
        fi
        v="$(echo "$v" | tr '[:upper:]' '[:lower:]')"
        if enshrouded_validate_bool_soft_local "enableTextChat" "$v"; then
          enshrouded_editor_set_bool "$config_file" ".enableTextChat" "$v" || true
        else
          ui_pause
        fi
        ;;
      11)
        if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_GS_PRESET"; then
          continue
        fi
        local v
        v="$(enshrouded_prompt_scalar "gameSettingsPreset" "$(enshrouded_editor_get_raw "$config_file" '.gameSettingsPreset')" "Default | Relaxed | Hard | Survival | Custom")"
        if [[ -n "$v" ]]; then
          if validate_game_setting "PRESET" "$v"; then
            enshrouded_editor_set_string "$config_file" ".gameSettingsPreset" "$v" || true
          else
            ui_pause
          fi
        fi
        ;;
      12)
        enshrouded_editor_game_settings_menu "$config_file"
        ;;
      13)
        enshrouded_editor_user_groups_menu "$config_file"
        ;;
      *)
        ui_warn_line "Invalid selection."
        ui_pause
        ;;
    esac
  done
}
