#!/usr/bin/env bash

# Enshrouded JSON editors for the interactive menu.
#
# Top-level + game settings + userGroups are spec-driven via `editor_spec_json`
# (`vars.json` vars + `templates.ENSHROUDED_ROLE`).

enshrouded_editor_cfg() {
  printf "%s/enshrouded_server.json" "$install_path"
}

enshrouded_editor_jq_ok() {
  local file
  file="$1"
  jq -e 'type == "object"' "$file" >/dev/null 2>&1
}

enshrouded_editor_game_settings_menu() {
  local file
  file="$1"
  menu_edit_json_from_spec \
    --title "Edit Game Settings" \
    --file "$file" \
    --metaField "enshroudedJsonPath" \
    --labelMode "path" \
    --labelStripPrefix ".gameSettings." \
    --filterPrefix ".gameSettings." \
    --backupJob "enshrouded-backup-config" \
    --emptyAction "cancel" \
    --boolToggle "false" \
    --emptyLabel "<empty>"
}

enshrouded_editor_user_groups_menu() {
  local file
  file="$1"
  menu_edit_user_groups_from_spec \
    --file "$file" \
    --template "ENSHROUDED_ROLE" \
    --envPrefix "ENSHROUDED_ROLE" \
    --backupJob "enshrouded-backup-config" \
    --emptyLabel "<empty>"
}

editor_enshrouded_json() {
  local config_file backed_up
  config_file="$(enshrouded_editor_cfg)"
  backed_up="false"

  if [[ ! -f "$config_file" ]]; then
    ui_warn_line "enshrouded_server.json is missing. Creating from profile..."
    ensure_enshrouded_config_from_profile || true
  fi

  if [[ ! -f "$config_file" ]] || ! enshrouded_editor_jq_ok "$config_file"; then
    ui_error "Invalid or missing config: $config_file"
    ui_pause
    return 1
  fi

  if ! menu_stop_server_for_config_change "edit Enshrouded settings"; then
    return 0
  fi

  menu_edit_json_from_spec \
    --title "Edit Enshrouded Settings" \
    --file "$config_file" \
    --metaField "enshroudedMenuJsonPath" \
    --labelMode "path" \
    --backupJob "enshrouded-backup-config" \
    --emptyAction "cancel" \
    --boolToggle "true" \
    --emptyLabel "<empty>" \
    --extra "__submenu_game_settings" "gameSettings (submenu)" "Game" "enshrouded_editor_game_settings_menu" \
    --extra "__submenu_user_groups" "userGroups (submenu)" "Access" "enshrouded_editor_user_groups_menu"
}

