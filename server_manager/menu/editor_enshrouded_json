#!/usr/bin/env bash

enshrouded_editor_cfg() {
  printf "%s/enshrouded_server.json" "$install_path"
}

enshrouded_editor_jq_ok() {
  local file
  file="$1"
  jq -e 'type == "object"' "$file" >/dev/null 2>&1
}

enshrouded_editor_get_compact() {
  local file path
  file="$1"
  path="$2"
  jq -c "$path" "$file" 2>/dev/null || echo "null"
}

enshrouded_editor_get_raw() {
  local file path
  file="$1"
  path="$2"
  jq -r "$path // empty" "$file" 2>/dev/null || echo ""
}

enshrouded_editor_session_backup_if_needed() {
  # Create exactly one config backup per edit session (first write wins).
  # Uses dynamic scope: the calling editor sets `backed_up=false` locally.
  local file
  file="$1"

  if [[ "${backed_up:-false}" == "true" ]]; then
    return 0
  fi

  ui_note "Creating config backup (logged via Supervisor)..."
  menu_run_config_backup_job "enshrouded-backup-config" 30 || true
  backed_up="true"
  return 0
}

enshrouded_editor_set_jq() {
  local file tmp
  file="$1"
  shift
  enshrouded_editor_session_backup_if_needed "$file"
  tmp="$(mktemp)"
  if jq "$@" "$file" >"$tmp"; then
    mv "$tmp" "$file"
    chmod 600 "$file" 2>/dev/null || true
    chown enshrouded:enshrouded "$file" 2>/dev/null || true
    return 0
  fi
  rm -f "$tmp"
  return 1
}

enshrouded_prompt_scalar() {
  local env_var label current value normalized desc hint type
  env_var="$1"
  label="$2"
  current="$3"

  echo
  ui_kv "Field" "$label"
  ui_kv "Current" "${current:-<empty>}"
  if [[ -n "$env_var" ]]; then
    desc="$(validation_var_description "$env_var" 2>/dev/null || true)"
    hint="$(validation_var_allowed_hint "$env_var" 2>/dev/null || true)"
    [[ -n "$desc" ]] && ui_note "$desc"
    [[ -n "$hint" ]] && ui_note "$hint"
  fi
  echo

  value="$(ui_read "New value (empty = cancel): ")"
  value="$(echo "$value" | xargs)"
  type="$(validation_var_type "$env_var" 2>/dev/null || true)"
  if [[ "$type" == "bool" ]]; then
    normalized="$(echo "$value" | tr '[:upper:]' '[:lower:]')"
    case "$normalized" in
      1|ja|j|y|yes) value="true" ;;
      0|nein|n|no) value="false" ;;
    esac
  fi
  printf "%s" "$value"
}

enshrouded_editor_block_if_env_locked() {
  # Returns 0 if editable, 1 if locked by external env override.
  local env_var env_value
  env_var="$1"

  if ! declare -F menu_env_override_is_set >/dev/null 2>&1; then
    return 0
  fi
  if ! menu_env_override_is_set "$env_var"; then
    return 0
  fi

  env_value="$(menu_env_override_value "$env_var")"
  ui_warn_line "This setting is controlled by an environment variable and cannot be edited here."
  ui_kv "ENV" "$env_var=$(menu_env_override_pretty_value "$env_var" "$env_value")"
  ui_note "Remove it from your docker-compose/container environment to edit this value."
  ui_pause
  return 1
}

enshrouded_editor_role_locked_badge() {
  local g env_var field
  g="$1"

  if ! declare -F menu_env_override_is_set >/dev/null 2>&1; then
    return 0
  fi

  while IFS= read -r field; do
    [[ -z "$field" ]] && continue
    env_var="ENSHROUDED_ROLE_${g}_${field}"
    if menu_env_override_is_set "$env_var"; then
      printf " %s" "${C_RED}[ENV]${C_RESET}"
      return 0
    fi
  done < <(validation_list_template_fields "ENSHROUDED_ROLE")

  return 0
}

enshrouded_editor_set_string() {
  local file path value
  file="$1"
  path="$2"
  value="$3"
  enshrouded_editor_set_jq "$file" --arg val "$value" "$path = \$val"
}

enshrouded_editor_set_number() {
  local file path value
  file="$1"
  path="$2"
  value="$3"
  enshrouded_editor_set_jq "$file" --argjson val "$value" "$path = \$val"
}

enshrouded_editor_set_bool() {
  local file path value
  file="$1"
  path="$2"
  value="$3"
  enshrouded_editor_set_jq "$file" --argjson val "$value" "$path = \$val"
}

enshrouded_editor_set_tags() {
  local file env_var tags_csv
  file="$1"
  env_var="$2"
  tags_csv="$3"
  if [[ -z "$tags_csv" ]]; then
    enshrouded_editor_set_jq "$file" '.tags = []'
    return $?
  fi
  if ! validation_check "$env_var" "$tags_csv"; then
    ui_warn_line "${VALIDATION_LAST_ERROR:-Invalid tags}"
    return 1
  fi
  enshrouded_editor_set_jq "$file" --arg tags "$tags_csv" '.tags = ($tags | split(",") | map(gsub("^\\s+|\\s+$";"")) | map(select(length>0)))'
}

enshrouded_editor_label_from_json_path() {
  local path
  path="$1"
  path="${path#.}"
  printf "%s" "$path"
}

enshrouded_editor_display_value_for_var() {
  local file env_var json_path raw
  file="$1"
  env_var="$2"
  json_path="$3"

  if menu_env_override_is_set "$env_var"; then
    raw="$(menu_env_override_value "$env_var")"
    if [[ -z "$raw" ]]; then
      printf "%s" "${C_DIM}<empty>${C_RESET}"
    else
      printf "%s%s%s" "${C_RED}" "$raw" "${C_RESET}"
    fi
    return 0
  fi

  if [[ "$json_path" == ".tags" ]]; then
    raw="$(jq -r '.tags // [] | join(",")' "$file" 2>/dev/null || echo "")"
  else
    raw="$(enshrouded_editor_get_raw "$file" "$json_path")"
  fi

  if [[ -z "$raw" ]]; then
    printf "%s" "${C_DIM}<empty>${C_RESET}"
  else
    printf "%s%s%s" "${C_GREEN}" "$raw" "${C_RESET}"
  fi
}

enshrouded_editor_edit_var() {
  # Edit a top-level config value based on the validation spec.
  local file env_var json_path label type current v desc hint cur normalized
  file="$1"
  env_var="$2"

  if ! enshrouded_editor_block_if_env_locked "$env_var"; then
    return 0
  fi

  json_path="$(validation_var_meta_field "$env_var" "enshroudedMenuJsonPath" 2>/dev/null || true)"
  if [[ -z "$json_path" ]]; then
    ui_warn_line "No config mapping for: $env_var"
    ui_pause
    return 0
  fi

  label="$(enshrouded_editor_label_from_json_path "$json_path")"
  type="$(validation_var_type "$env_var" 2>/dev/null || true)"
  [[ -z "$type" ]] && type="string"

  if [[ "$json_path" == ".tags" ]]; then
    current="$(jq -r '.tags // [] | join(",")' "$file" 2>/dev/null || echo "")"
    echo
    ui_kv "Field" "$label"
    ui_kv "Current" "${current:-<empty>}"
    desc="$(validation_var_description "$env_var" 2>/dev/null || true)"
    hint="$(validation_var_allowed_hint "$env_var" 2>/dev/null || true)"
    [[ -n "$desc" ]] && ui_note "$desc"
    [[ -n "$hint" ]] && ui_note "$hint"
    echo
    v="$(ui_read "Tags (empty = clear): ")"
    v="$(echo "$v" | xargs)"
    if ! enshrouded_editor_set_tags "$file" "$env_var" "$v"; then
      ui_pause
    fi
    return 0
  fi

  if [[ "$type" == "bool" ]]; then
    cur="$(enshrouded_editor_get_raw "$file" "$json_path")"
    [[ -z "$cur" ]] && cur="false"
    echo
    ui_kv "Field" "$label"
    ui_kv "Current" "$cur"
    ui_note "Enter = toggle (current: $cur)"
    desc="$(validation_var_description "$env_var" 2>/dev/null || true)"
    hint="$(validation_var_allowed_hint "$env_var" 2>/dev/null || true)"
    [[ -n "$desc" ]] && ui_note "$desc"
    [[ -n "$hint" ]] && ui_note "$hint"
    v="$(ui_read "New value (true/false or empty): ")"
    v="$(echo "$v" | xargs)"
    if [[ -z "$v" ]]; then
      if [[ "$cur" == "true" ]]; then v="false"; else v="true"; fi
    fi
    normalized="$(echo "$v" | tr '[:upper:]' '[:lower:]')"
    case "$normalized" in
      1|ja|j|y|yes) v="true" ;;
      0|nein|n|no) v="false" ;;
      *) v="$normalized" ;;
    esac
    if validation_check "$env_var" "$v"; then
      enshrouded_editor_set_bool "$file" "$json_path" "$v" || true
    else
      ui_warn_line "${VALIDATION_LAST_ERROR:-Invalid value}"
      ui_pause
    fi
    return 0
  fi

  current="$(enshrouded_editor_get_raw "$file" "$json_path")"
  v="$(enshrouded_prompt_scalar "$env_var" "$label" "$current")"
  if [[ -z "$v" ]]; then
    return 0
  fi
  if ! validation_check "$env_var" "$v"; then
    ui_warn_line "${VALIDATION_LAST_ERROR:-Invalid value}"
    ui_pause
    return 0
  fi

  case "$type" in
    int|number)
      enshrouded_editor_set_number "$file" "$json_path" "$v" || true
      ;;
    *)
      enshrouded_editor_set_string "$file" "$json_path" "$v" || true
      ;;
  esac

  return 0
}

enshrouded_editor_game_settings_definitions() {
  # Format: jsonKey:type:suffixForValidation
  cat <<'EOF'
playerHealthFactor:number:PLAYER_HEALTH_FACTOR
playerManaFactor:number:PLAYER_MANA_FACTOR
playerStaminaFactor:number:PLAYER_STAMINA_FACTOR
playerBodyHeatFactor:number:PLAYER_BODY_HEAT_FACTOR
playerDivingTimeFactor:number:PLAYER_DIVING_TIME_FACTOR
enableDurability:bool:ENABLE_DURABILITY
enableStarvingDebuff:bool:ENABLE_STARVING_DEBUFF
foodBuffDurationFactor:number:FOOD_BUFF_DURATION_FACTOR
fromHungerToStarving:number:FROM_HUNGER_TO_STARVING
shroudTimeFactor:number:SHROUD_TIME_FACTOR
tombstoneMode:string:TOMBSTONE_MODE
enableGliderTurbulences:bool:ENABLE_GLIDER_TURBULENCES
weatherFrequency:string:WEATHER_FREQUENCY
fishingDifficulty:string:FISHING_DIFFICULTY
miningDamageFactor:number:MINING_DAMAGE_FACTOR
plantGrowthSpeedFactor:number:PLANT_GROWTH_SPEED_FACTOR
resourceDropStackAmountFactor:number:RESOURCE_DROP_STACK_AMOUNT_FACTOR
factoryProductionSpeedFactor:number:FACTORY_PRODUCTION_SPEED_FACTOR
perkUpgradeRecyclingFactor:number:PERK_UPGRADE_RECYCLING_FACTOR
perkCostFactor:number:PERK_COST_FACTOR
experienceCombatFactor:number:EXPERIENCE_COMBAT_FACTOR
experienceMiningFactor:number:EXPERIENCE_MINING_FACTOR
experienceExplorationQuestsFactor:number:EXPERIENCE_EXPLORATION_QUESTS_FACTOR
randomSpawnerAmount:string:RANDOM_SPAWNER_AMOUNT
aggroPoolAmount:string:AGGRO_POOL_AMOUNT
enemyDamageFactor:number:ENEMY_DAMAGE_FACTOR
enemyHealthFactor:number:ENEMY_HEALTH_FACTOR
enemyStaminaFactor:number:ENEMY_STAMINA_FACTOR
enemyPerceptionRangeFactor:number:ENEMY_PERCEPTION_RANGE_FACTOR
bossDamageFactor:number:BOSS_DAMAGE_FACTOR
bossHealthFactor:number:BOSS_HEALTH_FACTOR
threatBonus:number:THREAT_BONUS
pacifyAllEnemies:bool:PACIFY_ALL_ENEMIES
tamingStartleRepercussion:string:TAMING_STARTLE_REPERCUSSION
dayTimeDuration:number:DAY_TIME_DURATION
nightTimeDuration:number:NIGHT_TIME_DURATION
curseModifier:string:CURSE_MODIFIER
EOF
}

enshrouded_editor_game_settings_menu() {
  local file choice
  file="$1"

  local -a defs keys types suffixes
  mapfile -t defs < <(enshrouded_editor_game_settings_definitions)
  keys=()
  types=()
  suffixes=()

  local d k t s
  for d in "${defs[@]}"; do
    k="${d%%:*}"
    t="${d#*:}"; t="${t%%:*}"
    s="${d##*:}"
    keys+=("$k")
    types+=("$t")
    suffixes+=("$s")
  done

  while :; do
    if menu_nav_is_set; then
      return 0
    fi
    ui_header "Edit Game Settings"
    ui_note "Note: empty input cancels editing (no null writes)."
    ui_note "[ENV] = controlled by container environment (locked)"
    echo

    local i idx current env_var
    idx=1

    echo "${C_DIM}== Player ==${C_RESET}"
    for i in 0 1 2 3 4; do
      env_var="ENSHROUDED_GS_${suffixes[$i]}"
      if menu_env_override_is_set "$env_var"; then
        current="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "$env_var")" "${C_RESET}")"
      else
        current="$(printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_compact "$file" ".gameSettings.${keys[$i]}")" "${C_RESET}")"
      fi
      printf "%s[%s]%s %-36s %s%s\n" "${C_MAGENTA}" "$idx" "${C_RESET}" "${keys[$i]}" "$current" "$(menu_env_locked_badge "$env_var")"
      idx=$((idx + 1))
    done
    echo

    echo "${C_DIM}== Survival / World ==${C_RESET}"
    for i in 5 6 7 8 9 10 11 12 13; do
      env_var="ENSHROUDED_GS_${suffixes[$i]}"
      if menu_env_override_is_set "$env_var"; then
        current="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "$env_var")" "${C_RESET}")"
      else
        current="$(printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_compact "$file" ".gameSettings.${keys[$i]}")" "${C_RESET}")"
      fi
      printf "%s[%s]%s %-36s %s%s\n" "${C_MAGENTA}" "$idx" "${C_RESET}" "${keys[$i]}" "$current" "$(menu_env_locked_badge "$env_var")"
      idx=$((idx + 1))
    done
    echo

    echo "${C_DIM}== Economy / Progress ==${C_RESET}"
    for i in 14 15 16 17 18 19 20 21 22; do
      env_var="ENSHROUDED_GS_${suffixes[$i]}"
      if menu_env_override_is_set "$env_var"; then
        current="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "$env_var")" "${C_RESET}")"
      else
        current="$(printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_compact "$file" ".gameSettings.${keys[$i]}")" "${C_RESET}")"
      fi
      printf "%s[%s]%s %-36s %s%s\n" "${C_MAGENTA}" "$idx" "${C_RESET}" "${keys[$i]}" "$current" "$(menu_env_locked_badge "$env_var")"
      idx=$((idx + 1))
    done
    echo

    echo "${C_DIM}== Enemies ==${C_RESET}"
    for i in 23 24 25 26 27 28 29 30 31 32 33; do
      env_var="ENSHROUDED_GS_${suffixes[$i]}"
      if menu_env_override_is_set "$env_var"; then
        current="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "$env_var")" "${C_RESET}")"
      else
        current="$(printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_compact "$file" ".gameSettings.${keys[$i]}")" "${C_RESET}")"
      fi
      printf "%s[%s]%s %-36s %s%s\n" "${C_MAGENTA}" "$idx" "${C_RESET}" "${keys[$i]}" "$current" "$(menu_env_locked_badge "$env_var")"
      idx=$((idx + 1))
    done
    echo

    echo "${C_DIM}== Time ==${C_RESET}"
    for i in 34 35; do
      env_var="ENSHROUDED_GS_${suffixes[$i]}"
      if menu_env_override_is_set "$env_var"; then
        current="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "$env_var")" "${C_RESET}")"
      else
        current="$(printf "%s%s%s" "${C_GREEN}" "$(enshrouded_editor_get_compact "$file" ".gameSettings.${keys[$i]}")" "${C_RESET}")"
      fi
      printf "%s[%s]%s %-36s %s%s\n" "${C_MAGENTA}" "$idx" "${C_RESET}" "${keys[$i]}" "$current" "$(menu_env_locked_badge "$env_var")"
      idx=$((idx + 1))
    done
    echo

    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo

    choice="$(ui_prompt_choice "Choice")"
    choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$choice" in
      0)
        return 0
        ;;
      m)
        menu_nav_set "main"
        return 0
        ;;
      x|q)
        menu_nav_set "exit"
        return 0
        ;;
    esac

    if ! [[ "$choice" =~ ^[0-9]+$ ]]; then
      ui_warn_line "Invalid selection."
      ui_pause
      continue
    fi

    local key_index new_value key type suffix path current_raw env_var
    key_index=$((choice - 1))
    if [[ "$key_index" -lt 0 || "$key_index" -ge "${#keys[@]}" ]]; then
      ui_warn_line "Invalid selection."
      ui_pause
      continue
    fi

    key="${keys[$key_index]}"
    type="${types[$key_index]}"
    suffix="${suffixes[$key_index]}"
    path=".gameSettings.${key}"
    current_raw="$(enshrouded_editor_get_raw "$file" "$path")"
    env_var="ENSHROUDED_GS_${suffix}"

    if ! enshrouded_editor_block_if_env_locked "$env_var"; then
      continue
    fi

    new_value="$(enshrouded_prompt_scalar "$env_var" "$key" "$current_raw")"
    if [[ -z "$new_value" ]]; then
      ui_note "Cancelled."
      ui_pause
      continue
    fi

    if [[ "$type" == "bool" ]]; then
      new_value="$(echo "$new_value" | tr '[:upper:]' '[:lower:]')"
    fi

    if ! validation_check "$env_var" "$new_value"; then
      ui_warn_line "${VALIDATION_LAST_ERROR:-Invalid value, not saved.}"
      ui_pause
      continue
    fi

    case "$type" in
      bool)
        enshrouded_editor_set_bool "$file" "$path" "$new_value" || true
        ;;
      number)
        enshrouded_editor_set_number "$file" "$path" "$new_value" || true
        ;;
      *)
        enshrouded_editor_set_string "$file" "$path" "$new_value" || true
        ;;
    esac

  done
}

enshrouded_editor_user_groups_menu() {
  local file choice count idx name
  file="$1"

  while :; do
    if menu_nav_is_set; then
      return 0
    fi
    ui_header "Edit User Groups"
    ui_note "[ENV] = controlled by container environment (locked)"
    count="$(jq -r '.userGroups | length' "$file" 2>/dev/null || echo 0)"
    if ! [[ "$count" =~ ^[0-9]+$ ]]; then
      count=0
    fi

    if [[ "$count" -le 0 ]]; then
      ui_warn_line "No userGroups found."
      echo
      ui_actions_bar "0 Back" "m Main" "x Exit"
      echo
      choice="$(ui_prompt_choice "Choice")"
      choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
      case "$choice" in
        0) return 0 ;;
        m) menu_nav_set "main"; return 0 ;;
        x|q) menu_nav_set "exit"; return 0 ;;
      esac
      continue
    fi

    for idx in $(seq 0 $((count - 1))); do
      name="$(jq -r ".userGroups[$idx].name // \"Group $idx\"" "$file" 2>/dev/null || echo "Group $idx")"
      printf "%s[%s]%s %s%s%s\n" "${C_MAGENTA}" "$((idx + 1))" "${C_RESET}" "${C_GREEN}" "$name" "${C_RESET}$(enshrouded_editor_role_locked_badge "$idx")"
    done
    echo
    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo
    choice="$(ui_prompt_choice "Group")"
    choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$choice" in
      0) return 0 ;;
      m) menu_nav_set "main"; return 0 ;;
      x|q) menu_nav_set "exit"; return 0 ;;
    esac

    if ! [[ "$choice" =~ ^[0-9]+$ ]]; then
      ui_warn_line "Invalid selection."
      ui_pause
      continue
    fi

    local g
    g=$((choice - 1))
    if [[ "$g" -lt 0 || "$g" -ge "$count" ]]; then
      ui_warn_line "Invalid selection."
      ui_pause
      continue
    fi

    # Group editor
    while :; do
      if menu_nav_is_set; then
        return 0
      fi

      local base current_name current_pw reserved ck ci cw cb ce
      local name_display pw_display reserved_display ck_display ci_display cw_display cb_display ce_display
      base=".userGroups[$g]"
      current_name="$(enshrouded_editor_get_raw "$file" "$base.name")"
      current_pw="$(jq -r "$base.password | if . == null then \"<null>\" elif . == \"\" then \"<empty>\" else . end" "$file" 2>/dev/null || echo "")"
      reserved="$(enshrouded_editor_get_raw "$file" "$base.reservedSlots")"
      ck="$(enshrouded_editor_get_raw "$file" "$base.canKickBan")"
      ci="$(enshrouded_editor_get_raw "$file" "$base.canAccessInventories")"
      cw="$(enshrouded_editor_get_raw "$file" "$base.canEditWorld")"
      cb="$(enshrouded_editor_get_raw "$file" "$base.canEditBase")"
      ce="$(enshrouded_editor_get_raw "$file" "$base.canExtendBase")"

      ui_header "User Group: ${current_name:-Group $g}"
      ui_note "[ENV] = controlled by container environment (locked)"

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_NAME"; then
        name_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_NAME")" "${C_RESET}")"
      elif [[ -z "$current_name" ]]; then
        name_display="${C_DIM}<empty>${C_RESET}"
      else
        name_display="$(printf "%s%s%s" "${C_GREEN}" "$current_name" "${C_RESET}")"
      fi

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_PASSWORD"; then
        pw_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_PASSWORD")" "${C_RESET}")"
      elif [[ -z "$current_pw" ]]; then
        pw_display="${C_DIM}<empty>${C_RESET}"
      else
        pw_display="$(printf "%s%s%s" "${C_GREEN}" "$current_pw" "${C_RESET}")"
      fi

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_RESERVED_SLOTS"; then
        reserved_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_RESERVED_SLOTS")" "${C_RESET}")"
      elif [[ -z "$reserved" ]]; then
        reserved_display="${C_DIM}0${C_RESET}"
      else
        reserved_display="$(printf "%s%s%s" "${C_GREEN}" "$reserved" "${C_RESET}")"
      fi

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_CAN_KICK_BAN"; then
        ck_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_CAN_KICK_BAN")" "${C_RESET}")"
      else
        ck_display="$(printf "%s%s%s" "${C_GREEN}" "${ck:-false}" "${C_RESET}")"
      fi

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_CAN_ACCESS_INVENTORIES"; then
        ci_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_CAN_ACCESS_INVENTORIES")" "${C_RESET}")"
      else
        ci_display="$(printf "%s%s%s" "${C_GREEN}" "${ci:-false}" "${C_RESET}")"
      fi

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_CAN_EDIT_WORLD"; then
        cw_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_CAN_EDIT_WORLD")" "${C_RESET}")"
      else
        cw_display="$(printf "%s%s%s" "${C_GREEN}" "${cw:-false}" "${C_RESET}")"
      fi

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_CAN_EDIT_BASE"; then
        cb_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_CAN_EDIT_BASE")" "${C_RESET}")"
      else
        cb_display="$(printf "%s%s%s" "${C_GREEN}" "${cb:-false}" "${C_RESET}")"
      fi

      if menu_env_override_is_set "ENSHROUDED_ROLE_${g}_CAN_EXTEND_BASE"; then
        ce_display="$(printf "%s%s%s" "${C_RED}" "$(menu_env_override_value "ENSHROUDED_ROLE_${g}_CAN_EXTEND_BASE")" "${C_RESET}")"
      else
        ce_display="$(printf "%s%s%s" "${C_GREEN}" "${ce:-false}" "${C_RESET}")"
      fi

      printf "%s[1]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "name" "$name_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_NAME")"
      printf "%s[2]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "password" "$pw_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_PASSWORD")"
      printf "%s[3]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "reservedSlots" "$reserved_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_RESERVED_SLOTS")"
      printf "%s[4]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "canKickBan" "$ck_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_CAN_KICK_BAN")"
      printf "%s[5]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "canAccessInventories" "$ci_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_CAN_ACCESS_INVENTORIES")"
      printf "%s[6]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "canEditWorld" "$cw_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_CAN_EDIT_WORLD")"
      printf "%s[7]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "canEditBase" "$cb_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_CAN_EDIT_BASE")"
      printf "%s[8]%s %-22s %s%s\n" "${C_MAGENTA}" "${C_RESET}" "canExtendBase" "$ce_display" "$(menu_env_locked_badge "ENSHROUDED_ROLE_${g}_CAN_EXTEND_BASE")"
      echo
      ui_actions_bar "0 Back" "m Main" "x Exit"
      echo

      local c
      c="$(ui_prompt_choice "Choice")"
      c="$(echo "$c" | tr '[:upper:]' '[:lower:]' | xargs)"
      case "$c" in
        0)
          break
          ;;
        m)
          menu_nav_set "main"
          return 0
          ;;
        x|q)
          menu_nav_set "exit"
          return 0
          ;;
      esac

      if ! [[ "$c" =~ ^[0-9]+$ ]]; then
        ui_warn_line "Invalid selection."
        ui_pause
        continue
      fi

      case "$c" in
        1)
          if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_ROLE_${g}_NAME"; then
            continue
          fi
          local v env_var
          env_var="ENSHROUDED_ROLE_${g}_NAME"
          v="$(enshrouded_prompt_scalar "$env_var" "name" "$current_name")"
          if [[ -z "$v" ]]; then
            ui_note "Cancelled."
            ui_pause
          else
            enshrouded_editor_set_string "$file" "$base.name" "$v" || true
          fi
          ;;
        2)
          if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_ROLE_${g}_PASSWORD"; then
            continue
          fi
          local v
          echo
          local env_var desc hint
          env_var="ENSHROUDED_ROLE_${g}_PASSWORD"
          desc="$(validation_var_description "$env_var" 2>/dev/null || true)"
          hint="$(validation_var_allowed_hint "$env_var" 2>/dev/null || true)"
          [[ -n "$desc" ]] && ui_note "$desc"
          [[ -n "$hint" ]] && ui_note "$hint"
          ui_note "Empty = password will be set to null (may be auto-generated after bootstrap)."
          v="$(ui_read "New password: ")"
          v="$(echo "$v" | xargs)"
          if [[ -z "$v" ]]; then
            enshrouded_editor_set_jq "$file" "$base.password = null" || true
          else
            enshrouded_editor_set_string "$file" "$base.password" "$v" || true
          fi
          ;;
        3)
          if ! enshrouded_editor_block_if_env_locked "ENSHROUDED_ROLE_${g}_RESERVED_SLOTS"; then
            continue
          fi
          local v env_var
          env_var="ENSHROUDED_ROLE_${g}_RESERVED_SLOTS"
          v="$(enshrouded_prompt_scalar "$env_var" "reservedSlots" "$reserved")"
          if [[ -z "$v" ]]; then
            ui_note "Cancelled."
            ui_pause
          elif validation_check "$env_var" "$v"; then
            enshrouded_editor_set_number "$file" "$base.reservedSlots" "$v" || true
          else
            ui_warn_line "${VALIDATION_LAST_ERROR:-Invalid value}"
            ui_pause
          fi
          ;;
        4|5|6|7|8)
          local field cur next env_var
          case "$c" in
            4) field="canKickBan" ;;
            5) field="canAccessInventories" ;;
            6) field="canEditWorld" ;;
            7) field="canEditBase" ;;
            8) field="canExtendBase" ;;
          esac
          case "$field" in
            canKickBan) env_var="ENSHROUDED_ROLE_${g}_CAN_KICK_BAN" ;;
            canAccessInventories) env_var="ENSHROUDED_ROLE_${g}_CAN_ACCESS_INVENTORIES" ;;
            canEditWorld) env_var="ENSHROUDED_ROLE_${g}_CAN_EDIT_WORLD" ;;
            canEditBase) env_var="ENSHROUDED_ROLE_${g}_CAN_EDIT_BASE" ;;
            canExtendBase) env_var="ENSHROUDED_ROLE_${g}_CAN_EXTEND_BASE" ;;
            *) env_var="" ;;
          esac
          if [[ -n "$env_var" ]] && ! enshrouded_editor_block_if_env_locked "$env_var"; then
            continue
          fi
          cur="$(enshrouded_editor_get_raw "$file" "$base.$field")"
          if [[ "$cur" == "true" ]]; then
            next="false"
          else
            next="true"
          fi
          enshrouded_editor_set_bool "$file" "$base.$field" "$next" || true
          ;;
        *)
          ui_warn_line "Invalid selection."
          ui_pause
          ;;
      esac
    done
  done
}

editor_enshrouded_json() {
  local config_file choice field_count backed_up
  config_file="$(enshrouded_editor_cfg)"
  backed_up="false"

  if [[ ! -f "$config_file" ]]; then
    ui_warn_line "enshrouded_server.json is missing. Creating from profile..."
    ensure_enshrouded_config_from_profile || true
  fi

  if [[ ! -f "$config_file" ]] || ! enshrouded_editor_jq_ok "$config_file"; then
    ui_error "Invalid or missing config: $config_file"
    ui_pause
    return 1
  fi

  if ! menu_stop_server_for_config_change "edit Enshrouded settings"; then
    return 0
  fi

  while :; do
    if menu_nav_is_set; then
      return 0
    fi

    ui_header "Edit Enshrouded Settings"
    ui_kv "File" "$(menu_display_path "$config_file")"
    ui_note "Changes are written immediately."
    ui_note "[ENV] = controlled by container environment (locked)"
    echo

    field_count=0
    local -a options
    options=()
    local last_group var group json_path label
    last_group=""

    while IFS= read -r var; do
      [[ -z "$var" ]] && continue
      json_path="$(validation_var_meta_field "$var" "enshroudedMenuJsonPath" 2>/dev/null || true)"
      [[ -z "$json_path" ]] && continue
      group="$(validation_var_meta_field "$var" "menuGroup" 2>/dev/null || true)"
      label="$(enshrouded_editor_label_from_json_path "$json_path")"

      if [[ "$group" != "$last_group" ]]; then
        [[ -n "$last_group" ]] && echo
        echo "${C_DIM}== ${group:-Settings} ==${C_RESET}"
        last_group="$group"
      fi

      options+=("$var")
      field_count=$((field_count + 1))
      printf "%s[%s]%s %-24s %s%s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "$label" "$(enshrouded_editor_display_value_for_var "$config_file" "$var" "$json_path")" "$(menu_env_locked_badge "$var")"
    done < <(validation_list_vars_by_meta_field_ordered "enshroudedMenuJsonPath" "menuOrder")

    # Keep submenu entries visible in the top-level editor.
    options+=("__submenu_game_settings")
    field_count=$((field_count + 1))
    printf "%s[%s]%s %-24s %s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "gameSettings (submenu)" "${C_DIM}<enter>${C_RESET}"
    echo

    echo "${C_DIM}== Access ==${C_RESET}"
    options+=("__submenu_user_groups")
    field_count=$((field_count + 1))
    printf "%s[%s]%s %-24s %s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "userGroups (submenu)" "${C_DIM}<enter>${C_RESET}"
    echo

    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo

    choice="$(ui_prompt_choice "Choice")"
    choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"
    case "$choice" in
      0)
        return 0
        ;;
      m)
        menu_nav_set "main"
        return 0
        ;;
      x|q)
        menu_nav_set "exit"
        return 0
        ;;
    esac

    if ! [[ "$choice" =~ ^[0-9]+$ ]] || [[ "$choice" -lt 1 || "$choice" -gt "$field_count" ]]; then
      ui_warn_line "Invalid selection."
      ui_pause
      continue
    fi

    local selected
    selected="${options[$((choice - 1))]}"
    case "$selected" in
      __submenu_game_settings)
        enshrouded_editor_game_settings_menu "$config_file"
        ;;
      __submenu_user_groups)
        enshrouded_editor_user_groups_menu "$config_file"
        ;;
      *)
        enshrouded_editor_edit_var "$config_file" "$selected" || true
        ;;
    esac
  done
}
