#!/usr/bin/env bash

manager_editor_label() {
  case "$1" in
    PUID) echo "PUID (User ID)" ;;
    PGID) echo "PGID (Group ID)" ;;
    LOG_COLOR) echo "LOG_COLOR (Colors)" ;;
    SAVEFILE_NAME) echo "SAVEFILE_NAME" ;;
    STEAM_APP_ID) echo "STEAM_APP_ID" ;;
    GAME_BRANCH) echo "GAME_BRANCH" ;;
    STEAMCMD_ARGS) echo "STEAMCMD_ARGS" ;;
    WINEDEBUG) echo "WINEDEBUG" ;;
    UPDATE_CHECK_PLAYERS) echo "UPDATE_CHECK_PLAYERS" ;;
    RESTART_CHECK_PLAYERS) echo "RESTART_CHECK_PLAYERS" ;;
    BACKUP_DIR) echo "BACKUP_DIR" ;;
    BACKUP_MAX_COUNT) echo "BACKUP_MAX_COUNT" ;;
    BACKUP_PRE_HOOK) echo "BACKUP_PRE_HOOK" ;;
    BACKUP_POST_HOOK) echo "BACKUP_POST_HOOK" ;;
    UPDATE_CRON) echo "UPDATE_CRON" ;;
    BACKUP_CRON) echo "BACKUP_CRON" ;;
    RESTART_CRON) echo "RESTART_CRON" ;;
    BOOTSTRAP_HOOK) echo "BOOTSTRAP_HOOK" ;;
    UPDATE_PRE_HOOK) echo "UPDATE_PRE_HOOK" ;;
    UPDATE_POST_HOOK) echo "UPDATE_POST_HOOK" ;;
    RESTART_PRE_HOOK) echo "RESTART_PRE_HOOK" ;;
    RESTART_POST_HOOK) echo "RESTART_POST_HOOK" ;;
    *) echo "$1" ;;
  esac
}

manager_editor_display_value() {
  local file var value
  file="$1"
  var="$2"
  value="$(manager_json_get "$file" "$var")"
  if [[ -z "$value" ]]; then
    printf "%s" "${C_DIM}<null>${C_RESET}"
  else
    printf "%s" "$value"
  fi
}

manager_editor_prompt_value() {
  local var current type prompt value normalized
  var="$1"
  current="$2"
  type="${MANAGER_TYPE[$var]-string}"

  echo
  ui_kv "Key" "$var"
  ui_kv "Current" "${current:-<null>}"
  case "$type" in
    bool)
      ui_note "Allowed: true | false (empty = null)"
      ;;
    int)
      ui_note "Allowed: integer (empty = null)"
      ;;
    *)
      ui_note "String (empty = null)"
      ;;
  esac
  echo

  prompt="New value"
  value="$(ui_read "$prompt: ")"
  value="$(echo "$value" | xargs)"

  # Normalize booleans for convenience.
  if [[ "$type" == "bool" ]]; then
    normalized="$(echo "$value" | tr '[:upper:]' '[:lower:]')"
    case "$normalized" in
      true|false) value="$normalized" ;;
      1|yes|y|ja|j) value="true" ;;
      0|no|n|nein) value="false" ;;
    esac
  fi

  printf "%s" "$value"
}

editor_manager_json() {
  local config_file tmp changed choice field_count save_choice save_restart_choice
  config_file="$(manager_config_path)"
  changed="false"

  # Ensure config exists and is valid.
  if [[ ! -f "$config_file" ]] || ! jq -e 'type == "object"' "$config_file" >/dev/null 2>&1; then
    ui_warn_line "server_manager.json is missing or invalid. Initializing..."
    update_or_create_manager_config || true
  fi

  if [[ ! -f "$config_file" ]]; then
    ui_error "Could not find server_manager.json: $config_file"
    ui_pause
    return 1
  fi

  tmp="$(mktemp)"
  cp "$config_file" "$tmp"
  chmod 600 "$tmp" 2>/dev/null || true
  trap 'rm -f "$tmp" 2>/dev/null || true' RETURN

  while :; do
    local -a options_vars
    options_vars=()

    ui_header "Edit Server Manager JSON"
    ui_kv "File" "$config_file"
    if [[ "$changed" == "true" ]]; then
      ui_warn_line "Unsaved changes."
    fi
    ui_note "[ENV] = controlled by container environment (locked)"
    echo

    field_count=0

    echo "${C_DIM}== Identity ==${C_RESET}"
    for v in PUID PGID; do
      options_vars+=("$v")
      field_count=$((field_count + 1))
      printf "[%s] %-26s %s%s\n" "$field_count" "$(manager_editor_label "$v")" "$(manager_editor_display_value "$tmp" "$v")" "$(menu_env_locked_badge "$v")"
    done
    echo

    echo "${C_DIM}== Steam ==${C_RESET}"
    for v in STEAM_APP_ID GAME_BRANCH STEAMCMD_ARGS; do
      options_vars+=("$v")
      field_count=$((field_count + 1))
      printf "[%s] %-26s %s%s\n" "$field_count" "$(manager_editor_label "$v")" "$(manager_editor_display_value "$tmp" "$v")" "$(menu_env_locked_badge "$v")"
    done
    echo

    echo "${C_DIM}== Logging ==${C_RESET}"
    for v in LOG_COLOR WINEDEBUG; do
      options_vars+=("$v")
      field_count=$((field_count + 1))
      printf "[%s] %-26s %s%s\n" "$field_count" "$(manager_editor_label "$v")" "$(manager_editor_display_value "$tmp" "$v")" "$(menu_env_locked_badge "$v")"
    done
    echo

    echo "${C_DIM}== Save ==${C_RESET}"
    for v in SAVEFILE_NAME; do
      options_vars+=("$v")
      field_count=$((field_count + 1))
      printf "[%s] %-26s %s%s\n" "$field_count" "$(manager_editor_label "$v")" "$(manager_editor_display_value "$tmp" "$v")" "$(menu_env_locked_badge "$v")"
    done
    echo

    echo "${C_DIM}== Update / Restart ==${C_RESET}"
    for v in UPDATE_CHECK_PLAYERS RESTART_CHECK_PLAYERS UPDATE_CRON RESTART_CRON UPDATE_PRE_HOOK UPDATE_POST_HOOK RESTART_PRE_HOOK RESTART_POST_HOOK; do
      options_vars+=("$v")
      field_count=$((field_count + 1))
      printf "[%s] %-26s %s%s\n" "$field_count" "$(manager_editor_label "$v")" "$(manager_editor_display_value "$tmp" "$v")" "$(menu_env_locked_badge "$v")"
    done
    echo

    echo "${C_DIM}== Backup ==${C_RESET}"
    for v in BACKUP_DIR BACKUP_MAX_COUNT BACKUP_CRON BACKUP_PRE_HOOK BACKUP_POST_HOOK; do
      options_vars+=("$v")
      field_count=$((field_count + 1))
      printf "[%s] %-26s %s%s\n" "$field_count" "$(manager_editor_label "$v")" "$(manager_editor_display_value "$tmp" "$v")" "$(menu_env_locked_badge "$v")"
    done
    echo

    echo "${C_DIM}== Bootstrap ==${C_RESET}"
    for v in BOOTSTRAP_HOOK; do
      options_vars+=("$v")
      field_count=$((field_count + 1))
      printf "[%s] %-26s %s%s\n" "$field_count" "$(manager_editor_label "$v")" "$(manager_editor_display_value "$tmp" "$v")" "$(menu_env_locked_badge "$v")"
    done
    echo

    save_choice=$((field_count + 1))
    save_restart_choice=$((field_count + 2))
    echo "[${save_choice}] Save"
    echo "[${save_restart_choice}] Save and run bootstrap (recommended)"
    echo
    echo "[0] Back"
    echo

    choice="$(ui_prompt_number "Choice")"
    if [[ "$choice" -eq 0 ]]; then
      if [[ "$changed" != "true" ]]; then
        return 0
      fi
      ui_warn_line "Discard unsaved changes?"
      echo "[1] Save"
      echo "[2] Discard"
      echo "[0] Cancel"
      echo
      case "$(ui_prompt_number "Action")" in
        1)
          if ! menu_stop_server_for_config_change "save Server Manager settings"; then
            ui_pause
            continue
          fi
          local config_dir save_tmp
          config_dir="$(dirname "$config_file")"
          mkdir -p "$config_dir" 2>/dev/null || true
          save_tmp="$(mktemp "${config_dir}/.server_manager.json.save.XXXXXX")"
          if ! cp "$tmp" "$save_tmp"; then
            rm -f "$save_tmp" 2>/dev/null || true
            ui_error "Failed to save file."
            ui_pause
            continue
          fi
          backup_config_file "$config_file" "server_manager" || true
          mv -f "$save_tmp" "$config_file"
          chmod 600 "$config_file" 2>/dev/null || true
          chown enshrouded:enshrouded "$config_file" 2>/dev/null || true
          ui_success "Saved: $config_file"
          echo
          menu_prompt_start_server "Start enshrouded-server now to apply changes?"
          ui_pause
          return 0
          ;;
        2)
          ui_note "Discarded."
          ui_pause
          return 0
          ;;
        0)
          continue
          ;;
        *)
          continue
          ;;
      esac
    fi

    if [[ "$choice" -eq "$save_choice" ]]; then
      if ! menu_stop_server_for_config_change "save Server Manager settings"; then
        ui_pause
        continue
      fi
      local config_dir save_tmp
      config_dir="$(dirname "$config_file")"
      mkdir -p "$config_dir" 2>/dev/null || true
      save_tmp="$(mktemp "${config_dir}/.server_manager.json.save.XXXXXX")"
      if ! cp "$tmp" "$save_tmp"; then
        rm -f "$save_tmp" 2>/dev/null || true
        ui_error "Failed to save file."
        ui_pause
        continue
      fi
      backup_config_file "$config_file" "server_manager" || true
      mv -f "$save_tmp" "$config_file"
      chmod 600 "$config_file" 2>/dev/null || true
      chown enshrouded:enshrouded "$config_file" 2>/dev/null || true
      ui_success "Saved: $config_file"
      echo
      menu_prompt_start_server "Start enshrouded-server now to apply changes?"
      ui_pause
      return 0
    fi

    if [[ "$choice" -eq "$save_restart_choice" ]]; then
      if ! menu_stop_server_for_config_change "save Server Manager settings"; then
        ui_pause
        continue
      fi
      local config_dir save_tmp
      config_dir="$(dirname "$config_file")"
      mkdir -p "$config_dir" 2>/dev/null || true
      save_tmp="$(mktemp "${config_dir}/.server_manager.json.save.XXXXXX")"
      if ! cp "$tmp" "$save_tmp"; then
        rm -f "$save_tmp" 2>/dev/null || true
        ui_error "Failed to save file."
        ui_pause
        continue
      fi
      backup_config_file "$config_file" "server_manager" || true
      mv -f "$save_tmp" "$config_file"
      chmod 600 "$config_file" 2>/dev/null || true
      chown enshrouded:enshrouded "$config_file" 2>/dev/null || true
      ui_success "Saved: $config_file"
      supervisorctl start enshrouded-bootstrap || true
      ui_success "Bootstrap started."
      ui_note "Note: bootstrap does not start the server."
      if menu_wait_for_program_exit "enshrouded-bootstrap" 600; then
        echo
        menu_prompt_start_server "Start enshrouded-server now?"
      else
        ui_note "Start the server later once bootstrap has finished."
      fi
      ui_pause
      return 0
    fi

    if [[ "$choice" -ge 1 && "$choice" -le "$field_count" ]]; then
      local var current new_value
      var="${options_vars[$((choice - 1))]}"

      if menu_env_override_is_set "$var"; then
        local env_value
        env_value="$(menu_env_override_value "$var")"
        ui_warn_line "This setting is controlled by an environment variable and cannot be edited here."
        ui_kv "ENV" "$var=$(menu_env_override_pretty_value "$var" "$env_value")"
        ui_note "Remove it from your docker-compose/container environment to edit this value."
        ui_pause
        continue
      fi

      current="$(manager_json_get "$tmp" "$var")"

      new_value="$(manager_editor_prompt_value "$var" "$current")"
      if ! validate_manager_value "$var" "$new_value" "soft"; then
        ui_warn_line "Invalid value, not saved."
        ui_pause
        continue
      fi

      manager_config_set_value "$tmp" "$var" "$new_value"
      changed="true"
      continue
    fi

    ui_warn_line "Invalid selection."
    ui_pause
  done
}
