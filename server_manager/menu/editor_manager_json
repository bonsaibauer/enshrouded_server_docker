#!/usr/bin/env bash

manager_editor_label() {
  case "$1" in
    PUID) echo "PUID (User ID)" ;;
    PGID) echo "PGID (Group ID)" ;;
    LOG_COLOR) echo "LOG_COLOR (Colors)" ;;
    SAVEFILE_NAME) echo "SAVEFILE_NAME" ;;
    STEAM_APP_ID) echo "STEAM_APP_ID" ;;
    GAME_BRANCH) echo "GAME_BRANCH" ;;
    STEAMCMD_ARGS) echo "STEAMCMD_ARGS" ;;
    WINEDEBUG) echo "WINEDEBUG" ;;
    UPDATE_CHECK_PLAYERS) echo "UPDATE_CHECK_PLAYERS" ;;
    RESTART_CHECK_PLAYERS) echo "RESTART_CHECK_PLAYERS" ;;
    BACKUP_DIR) echo "BACKUP_DIR" ;;
    BACKUP_MAX_COUNT) echo "BACKUP_MAX_COUNT" ;;
    BACKUP_PRE_HOOK) echo "BACKUP_PRE_HOOK" ;;
    BACKUP_POST_HOOK) echo "BACKUP_POST_HOOK" ;;
    UPDATE_CRON) echo "UPDATE_CRON" ;;
    BACKUP_CRON) echo "BACKUP_CRON" ;;
    RESTART_CRON) echo "RESTART_CRON" ;;
    BOOTSTRAP_HOOK) echo "BOOTSTRAP_HOOK" ;;
    UPDATE_PRE_HOOK) echo "UPDATE_PRE_HOOK" ;;
    UPDATE_POST_HOOK) echo "UPDATE_POST_HOOK" ;;
    RESTART_PRE_HOOK) echo "RESTART_PRE_HOOK" ;;
    RESTART_POST_HOOK) echo "RESTART_POST_HOOK" ;;
    *) echo "$1" ;;
  esac
}

manager_editor_display_value() {
  local file var value
  file="$1"
  var="$2"
  if menu_env_override_is_set "$var"; then
    value="$(menu_env_override_value "$var")"
    if [[ -z "$value" ]]; then
      printf "%s" "${C_DIM}<empty>${C_RESET}"
    else
      printf "%s%s%s" "${C_RED}" "$value" "${C_RESET}"
    fi
    return 0
  fi

  value="$(manager_json_get "$file" "$var")"
  if [[ -z "$value" ]]; then
    printf "%s" "${C_DIM}<null>${C_RESET}"
  else
    printf "%s%s%s" "${C_GREEN}" "$value" "${C_RESET}"
  fi
}

manager_editor_prompt_value() {
  local var current type prompt value normalized
  var="$1"
  current="$2"
  type="$(validation_var_type "$var" 2>/dev/null || true)"
  [[ -z "$type" ]] && type="string"

  echo
  ui_kv "Key" "$var"
  ui_kv "Current" "${current:-<null>}"
  local desc allowed_hint
  desc="$(validation_var_description "$var" 2>/dev/null || true)"
  allowed_hint="$(validation_var_allowed_hint "$var" 2>/dev/null || true)"
  if [[ -n "$desc" ]]; then
    ui_note "$desc"
  fi
  if [[ -n "$allowed_hint" ]]; then
    ui_note "$allowed_hint"
  fi
  local required allow_empty
  required="$(validation_var_required "$var" 2>/dev/null || true)"
  allow_empty="$(validation_rule_json "$var" 2>/dev/null | jq -r '.allowEmpty // true' 2>/dev/null || echo "true")"
  if [[ "$required" == "true" ]]; then
    ui_note "Empty is not allowed"
  elif [[ "$allow_empty" == "true" ]]; then
    ui_note "Empty = null"
  else
    ui_note "Empty is not allowed"
  fi
  echo

  prompt="New value"
  value="$(ui_read "$prompt: ")"
  value="$(echo "$value" | xargs)"

  # Normalize booleans for convenience.
  if [[ "$type" == "bool" ]]; then
    normalized="$(echo "$value" | tr '[:upper:]' '[:lower:]')"
    case "$normalized" in
      true|false) value="$normalized" ;;
      1|yes|y|ja|j) value="true" ;;
      0|no|n|nein) value="false" ;;
    esac
  fi

  printf "%s" "$value"
}

editor_manager_json() {
  local config_file choice field_count backed_up
  config_file="$(manager_config_path)"
  backed_up="false"

  # Ensure config exists and is valid.
  if [[ ! -f "$config_file" ]] || ! jq -e 'type == "object"' "$config_file" >/dev/null 2>&1; then
    ui_warn_line "server_manager.json is missing or invalid. Initializing..."
    update_or_create_manager_config || true
  fi

  if [[ ! -f "$config_file" ]]; then
    ui_error "Could not find server_manager.json: $config_file"
    ui_pause
    return 1
  fi

  if ! menu_stop_server_for_config_change "edit Server Manager settings"; then
    return 0
  fi

  while :; do
    local -a options_vars
    options_vars=()

    if menu_nav_is_set; then
      return 0
    fi

    ui_header "Edit Server Manager Settings"
    ui_kv "File" "$(menu_display_path "$config_file")"
    ui_note "Changes are written immediately."
    ui_note "[ENV] = controlled by container environment (locked)"
    echo

    field_count=0

    echo "${C_DIM}== Settings ==${C_RESET}"
    while IFS= read -r v; do
      [[ -z "$v" ]] && continue
      options_vars+=("$v")
      field_count=$((field_count + 1))
      printf "%s[%s]%s %-26s %s%s\n" "${C_MAGENTA}" "$field_count" "${C_RESET}" "$(manager_editor_label "$v")" "$(manager_editor_display_value "$config_file" "$v")" "$(menu_env_locked_badge "$v")"
    done < <(validation_list_vars_by_meta_field "managerJsonPath")
    echo

    ui_actions_bar "0 Back" "m Main" "x Exit"
    echo

    choice="$(ui_prompt_choice "Choice")"
    choice="$(echo "$choice" | tr '[:upper:]' '[:lower:]' | xargs)"

    case "$choice" in
      0)
        return 0
        ;;
      m)
        menu_nav_set "main"
        return 0
        ;;
      x|q)
        menu_nav_set "exit"
        return 0
        ;;
    esac

    if [[ "$choice" =~ ^[0-9]+$ ]] && [[ "$choice" -ge 1 && "$choice" -le "$field_count" ]]; then
      local var current new_value
      var="${options_vars[$((choice - 1))]}"

      if menu_env_override_is_set "$var"; then
        local env_value
        env_value="$(menu_env_override_value "$var")"
        ui_warn_line "This setting is controlled by an environment variable and cannot be edited here."
        ui_kv "ENV" "$var=$(menu_env_override_pretty_value "$var" "$env_value")"
        ui_note "Remove it from your docker-compose/container environment to edit this value."
        ui_pause
        continue
      fi

      current="$(manager_json_get "$config_file" "$var")"

      new_value="$(manager_editor_prompt_value "$var" "$current")"
      if ! validation_check "$var" "$new_value"; then
        ui_warn_line "${VALIDATION_LAST_ERROR:-Invalid value, not saved.}"
        ui_pause
        continue
      fi

      if [[ "$backed_up" != "true" ]]; then
        ui_note "Creating config backup (logged via Supervisor)..."
        menu_run_config_backup_job "server-manager-backup-config" 30 || true
        backed_up="true"
      fi
      manager_config_set_value "$config_file" "$var" "$new_value"
      ui_success "Updated: $var"
      continue
    fi

    ui_warn_line "Invalid selection."
    ui_pause
  done
}
