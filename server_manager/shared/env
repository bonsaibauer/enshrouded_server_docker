#!/usr/bin/env bash

ENV_SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
. "$ENV_SCRIPT_DIR/validation/lib"

validate_template_env_vars() {
  # Validate any template-driven env vars declared in vars.json (.templates).
  local template var_name value
  while IFS= read -r template; do
    [[ -z "$template" ]] && continue
    for var_name in $(compgen -A variable "${template}_" || true); do
      [[ "$var_name" =~ ^${template}_[0-9]+_ ]] || continue
      value="${!var_name-}"
      env_validate_var_from_spec "$var_name" "$value" || true
    done
  done < <(validation_list_templates)
}

validate_known_vars_from_spec() {
  local var_name value
  while IFS= read -r var_name; do
    [[ -z "$var_name" ]] && continue
    value="${!var_name-}"
    env_validate_var_from_spec "$var_name" "$value" || true
  done < <(validation_list_vars)
}

validate_unknown_game_settings_env_vars() {
  local var_name
  if [[ ! -f "${VALIDATION_SPEC_FILE:-}" ]] || ! command -v jq >/dev/null 2>&1; then
    return 0
  fi
  for var_name in $(compgen -A variable | grep '^ENSHROUDED_GS_' || true); do
    if ! validation_rule_json "$var_name" >/dev/null 2>&1; then
      warn "Unknown game setting env var detected: $var_name"
    fi
  done
}

env_validate_var() {
  # Usage: env_validate_var <var_name> <value> hard|soft
  local var value mode rc
  var="$1"
  value="${2-}"
  mode="$3"

  if validation_check "$var" "$value"; then
    return 0
  fi
  rc=$?
  case "$rc" in
    1)
      if [[ "$mode" == "hard" ]]; then
        fatal "$VALIDATION_LAST_ERROR"
      fi
      warn "$VALIDATION_LAST_ERROR"
      return 1
      ;;
    *)
      # Unknown rule / unavailable validator: warn but do not block bootstrap.
      warn "$VALIDATION_LAST_ERROR"
      return 0
      ;;
  esac
}

env_validate_var_from_spec() {
  # Usage: env_validate_var_from_spec <var_name> <value>
  local var value mode required
  var="$1"
  value="${2-}"
  mode="$(validation_var_env_mode "$var" 2>/dev/null || true)"
  if [[ "$mode" != "hard" && "$mode" != "soft" ]]; then
    required="$(validation_var_required "$var" 2>/dev/null || true)"
    if [[ "$required" == "true" ]]; then
      mode="hard"
    else
      mode="soft"
    fi
  fi
  env_validate_var "$var" "$value" "$mode"
}

verify_variables() {
  validate_known_vars_from_spec
  validate_template_env_vars
  validate_unknown_game_settings_env_vars
}
