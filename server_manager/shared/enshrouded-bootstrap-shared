#!/bin/bash

_enshrouded_bootstrap_shared_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
. "${_enshrouded_bootstrap_shared_dir}/spec_apply"

prepareEnshroudedAppFolders() {
  mkdir -p "$install_path"
}

initCrontab() {
  crontab=$(mktemp)

  if [ -n "$UPDATE_CRON" ]; then
    debug "creating cron for update checks (schedule: $UPDATE_CRON)"
    echo "$UPDATE_CRON supervisorctl start enshrouded-updater >/dev/null 2>&1" >>"$crontab"
  fi

  if [ -n "$BACKUP_CRON" ]; then
    debug "creating cron for backups (schedule: $BACKUP_CRON)"
    echo "$BACKUP_CRON supervisorctl start backup >/dev/null 2>&1" >>"$crontab"
  fi

  if [ -n "$RESTART_CRON" ]; then
    debug "creating cron for server restarts (schedule: $RESTART_CRON)"
    echo "$RESTART_CRON supervisorctl start enshrouded-restart >/dev/null 2>&1" >>"$crontab"
  fi

  crontab "$crontab"
  rm -f "$crontab"
}

prepareSteamA2sPythonLibrary() {
  pip3 install python-a2s==1.3.0 --break-system-packages
}

bootstrapHook() {
  if [ -n "$BOOTSTRAP_HOOK" ]; then
    info "Running bootstrap hook: $BOOTSTRAP_HOOK"
    eval "$BOOTSTRAP_HOOK"
  fi
}

enshrouded_bootstrap_apply_top_level_env_to_config() {
  # Applies all known top-level vars (and gameSettingsPreset) based on validation spec.
  local file
  file="$1"

  if ! apply_env_to_json --file "$file" --metaField "enshroudedMenuJsonPath" --orderField "menuOrder"; then
    warn "Failed to apply some top-level ENV values to enshrouded_server.json (jq error)"
  fi
}

updateOrCreateEnshroudedServerConfig() {
  if declare -F ensure_enshrouded_config_from_profile >/dev/null 2>&1; then
    ensure_enshrouded_config_from_profile || fatal "Failed to initialize enshrouded_server.json from profile"
  fi

  local config_file
  config_file="${install_path}/enshrouded_server.json"
  if [[ ! -e "$config_file" ]]; then
    fatal "Missing enshrouded_server.json at $config_file"
  fi

  enshrouded_bootstrap_apply_top_level_env_to_config "$config_file"

  updateUserGroupConfig
  updateGameSettingsConfig
}

updateUserGroupConfig() {
  local config_file
  config_file="${install_path}/enshrouded_server.json"
  if ! apply_env_template_to_json_array \
    --file "$config_file" \
    --template "ENSHROUDED_ROLE" \
    --envPrefix "ENSHROUDED_ROLE" \
    --arrayPath ".userGroups"; then
    warn "Failed to apply some role ENV values to enshrouded_server.json (jq error)"
  fi

  ensureUserGroupPasswords
}

generatePassword() {
  if [ -r /dev/urandom ]; then
    # Avoid `tr | head` which can emit a noisy SIGPIPE warning when `head` exits early.
    # Read bounded random bytes first, then filter and slice in bash.
    local out=""
    while [ "${#out}" -lt 12 ]; do
      out="${out}$(dd if=/dev/urandom bs=64 count=1 2>/dev/null | LC_ALL=C tr -dc 'A-Za-z0-9')"
    done
    printf '%s' "${out:0:12}"
    return 0
  fi
  date +%s%N | sha256sum | cut -c1-12
}

ensureUserGroupPasswords() {
  local count idx env_var current_password new_password

  if ! jq -e '.userGroups' ${install_path}/enshrouded_server.json >/dev/null 2>&1; then
    return 0
  fi

  count=$(jq -r '.userGroups | length' ${install_path}/enshrouded_server.json 2>/dev/null || echo 0)
  if ! [[ "$count" =~ ^[0-9]+$ ]] || [[ "$count" -le 0 ]]; then
    return 0
  fi

  for idx in $(seq 0 $((count - 1))); do
    env_var="ENSHROUDED_ROLE_${idx}_PASSWORD"
    if [[ -n "${!env_var-}" ]]; then
      continue
    fi

    current_password="$(jq -r ".userGroups[$idx].password // empty" ${install_path}/enshrouded_server.json 2>/dev/null || echo "")"
    if [[ -n "$current_password" ]]; then
      continue
    fi

    new_password="$(generatePassword)"
    if [[ -z "$new_password" ]]; then
      warn "Could not generate password for group index $idx"
      continue
    fi

    spec_apply__jq_set "${install_path}/enshrouded_server.json" --argjson group_index "$idx" --arg password "$new_password" '.userGroups[$group_index].password = $password' || warn "Failed to set generated password for group index $idx"
  done
}

updateGameSettingsConfig() {
  local config_file
  config_file="${install_path}/enshrouded_server.json"

  if ! apply_env_to_json --file "$config_file" --metaField "enshroudedJsonPath" --orderField "menuOrder" --filterPrefix ".gameSettings."; then
    warn "Failed to apply some game settings ENV values to enshrouded_server.json (jq error)"
  fi
}
