#!/bin/bash

prepareEnshroudedAppFolders() {
  mkdir -p "$install_path"
}

initCrontab() {
  crontab=$(mktemp)

  if [ -n "$UPDATE_CRON" ]; then
    debug "creating cron for update checks (schedule: $UPDATE_CRON)"
    echo "$UPDATE_CRON supervisorctl start enshrouded-updater >/dev/null 2>&1" >>"$crontab"
  fi

  if [ -n "$BACKUP_CRON" ]; then
    debug "creating cron for backups (schedule: $BACKUP_CRON)"
    echo "$BACKUP_CRON supervisorctl start enshrouded-backup >/dev/null 2>&1" >>"$crontab"
  fi

  if [ -n "$RESTART_CRON" ]; then
    debug "creating cron for server restarts (schedule: $RESTART_CRON)"
    echo "$RESTART_CRON supervisorctl start enshrouded-restart >/dev/null 2>&1" >>"$crontab"
  fi

  crontab "$crontab"
  rm -f "$crontab"
}

prepareSteamA2sPythonLibrary() {
  pip3 install python-a2s==1.3.0 --break-system-packages
}

bootstrapHook() {
  if [ -n "$BOOTSTRAP_HOOK" ]; then
    info "Running bootstrap hook: $BOOTSTRAP_HOOK"
    eval "$BOOTSTRAP_HOOK"
  fi
}

enshrouded_bootstrap__snake_to_lower_camel() {
  # Convert UPPER_SNAKE_CASE to lowerCamelCase (e.g. RESERVED_SLOTS -> reservedSlots).
  local in
  in="$1"
  echo "$in" | tr '[:upper:]' '[:lower:]' | awk -F_ '{for(i=1;i<=NF;i++){if(i==1){out=$i}else{out=out toupper(substr($i,1,1)) substr($i,2)}}}END{print out}'
}

enshrouded_bootstrap_jq_set() {
  # Apply a jq transform to $file atomically.
  local file tmp
  file="$1"
  shift

  tmp="$(mktemp)"
  if jq "$@" "$file" >"$tmp"; then
    mv "$tmp" "$file"
    return 0
  fi
  rm -f "$tmp" 2>/dev/null || true
  return 1
}

enshrouded_bootstrap_apply_top_level_env_to_config() {
  # Applies all known top-level vars (and gameSettingsPreset) based on validation spec.
  local file var value json_path type jq_arg
  file="$1"

  while IFS= read -r var; do
    [[ -z "$var" ]] && continue
    json_path="$(validation_var_meta_field "$var" "enshroudedMenuJsonPath" 2>/dev/null || true)"
    [[ -z "$json_path" ]] && continue

    value="${!var-}"
    [[ -z "$value" ]] && continue

    case "$json_path" in
      .tags)
        debug "updating tags to $value"
        if ! enshrouded_bootstrap_jq_set "$file" --arg tags "$value" '.tags = ($tags | split(",") | map(gsub("^\\s+|\\s+$";"")) | map(select(length>0)))'; then
          warn "Failed to update $var in enshrouded_server.json (jq error)"
        fi
        ;;
      *)
        type="$(validation_var_type "$var" 2>/dev/null || echo "string")"
        case "$type" in
          bool|int|number) jq_arg="--argjson" ;;
          *) jq_arg="--arg" ;;
        esac

        debug "Updating config: $var -> $json_path = $value"
        if ! enshrouded_bootstrap_jq_set "$file" "$jq_arg" val "$value" "$json_path = \\$val"; then
          warn "Failed to update $var in enshrouded_server.json (jq error)"
        fi
        ;;
    esac
  done < <(validation_list_vars_by_meta_field "enshroudedMenuJsonPath")
}

updateOrCreateEnshroudedServerConfig() {
  if declare -F ensure_enshrouded_config_from_profile >/dev/null 2>&1; then
    ensure_enshrouded_config_from_profile || fatal "Failed to initialize enshrouded_server.json from profile"
  fi

  local config_file
  config_file="${install_path}/enshrouded_server.json"
  if [[ ! -e "$config_file" ]]; then
    fatal "Missing enshrouded_server.json at $config_file"
  fi

  enshrouded_bootstrap_apply_top_level_env_to_config "$config_file"

  updateUserGroupConfig
  updateGameSettingsConfig
}

updateUserGroupConfig() {
  local group_count group_index group_param group_value
  group_count=$(compgen -A variable | grep -E "^ENSHROUDED_ROLE_[0-9]+_" | cut -d'_' -f3 | sort -nr | head -n1)

  local config_file
  config_file="${install_path}/enshrouded_server.json"

  if ! jq -e 'has("userGroups")' "$config_file" >/dev/null; then
    debug "userGroups array does not exist, creating empty array"
    enshrouded_bootstrap_jq_set "$config_file" '.userGroups = []' || true
  fi

  if [[ -n "$group_count" ]]; then
    for group_index in $(seq 0 $group_count); do
      if ! jq -e --argjson group_index "$group_index" '.userGroups | has($group_index)' "$config_file" >/dev/null; then
        debug "group $group_index does not exist, creating default group"
        enshrouded_bootstrap_jq_set "$config_file" '.userGroups += [{"name": "Default", "password": "", "canKickBan": false, "canAccessInventories": false, "canEditWorld": false, "canEditBase": false, "canExtendBase": false, "reservedSlots": 0}]' || true
      fi
    done
  fi

  for i in $(compgen -A variable | grep -E "^ENSHROUDED_ROLE_[0-9]+_"); do
    group_index=$(echo "$i" | cut -d'_' -f3)
    group_param=$(echo "$i" | cut -d'_' -f4-)
    group_value="${!i-}"

    # Skip unknown fields (also avoids accidental JSON injection from env var names).
    if ! validation_rule_json "$i" >/dev/null 2>&1; then
      continue
    fi

    local field_key type jq_arg prog
    field_key="$(enshrouded_bootstrap__snake_to_lower_camel "$group_param")"
    type="$(validation_var_type "$i" 2>/dev/null || echo "string")"

    if [[ "$type" == "string" ]]; then
      jq_arg="--arg"
    else
      # For bool/int/number fields: treat empty as "not set" (do not overwrite config).
      [[ -z "$group_value" ]] && continue
      jq_arg="--argjson"
    fi

    if [[ "$group_param" == "PASSWORD" ]]; then
      debug "Updating group $group_index $field_key to [hidden]"
    else
      debug "Updating group $group_index $field_key to $group_value"
    fi

    prog=".userGroups[\\$idx].${field_key} = \\$val"
    enshrouded_bootstrap_jq_set "$config_file" --argjson idx "$group_index" "$jq_arg" val "$group_value" "$prog" || true
  done

  ensureUserGroupPasswords
}

generatePassword() {
  if [ -r /dev/urandom ]; then
    # Avoid `tr | head` which can emit a noisy SIGPIPE warning when `head` exits early.
    # Read bounded random bytes first, then filter and slice in bash.
    local out=""
    while [ "${#out}" -lt 12 ]; do
      out="${out}$(dd if=/dev/urandom bs=64 count=1 2>/dev/null | LC_ALL=C tr -dc 'A-Za-z0-9')"
    done
    printf '%s' "${out:0:12}"
    return 0
  fi
  date +%s%N | sha256sum | cut -c1-12
}

ensureUserGroupPasswords() {
  local count idx env_var current_password new_password

  if ! jq -e '.userGroups' ${install_path}/enshrouded_server.json >/dev/null 2>&1; then
    return 0
  fi

  count=$(jq -r '.userGroups | length' ${install_path}/enshrouded_server.json 2>/dev/null || echo 0)
  if ! [[ "$count" =~ ^[0-9]+$ ]] || [[ "$count" -le 0 ]]; then
    return 0
  fi

  for idx in $(seq 0 $((count - 1))); do
    env_var="ENSHROUDED_ROLE_${idx}_PASSWORD"
    if compgen -A variable | grep -q "^${env_var}$"; then
      continue
    fi

    current_password="$(jq -r ".userGroups[$idx].password // empty" ${install_path}/enshrouded_server.json 2>/dev/null || echo "")"
    if [[ -n "$current_password" ]]; then
      continue
    fi

    new_password="$(generatePassword)"
    if [[ -z "$new_password" ]]; then
      warn "Could not generate password for group index $idx"
      continue
    fi

    enshrouded_bootstrap_jq_set "${install_path}/enshrouded_server.json" --argjson group_index "$idx" --arg password "$new_password" '.userGroups[$group_index].password = $password' || warn "Failed to set generated password for group index $idx"
  done
}

updateGameSettingsConfig() {
  for var_name in $(compgen -A variable | grep '^ENSHROUDED_GS_'); do
    local var_value
    var_value="${!var_name-}"

    if [[ -z "$var_value" ]]; then
      continue
    fi

    local suffix="${var_name#ENSHROUDED_GS_}"
    if [[ "$suffix" == "PRESET" ]]; then
      # gameSettingsPreset is a top-level key and handled by enshrouded_bootstrap_apply_top_level_env_to_config.
      continue
    fi
    local jq_key_name
    local full_jq_path
    local jq_arg_option

    jq_key_name="$(enshrouded_bootstrap__snake_to_lower_camel "$suffix")"
    full_jq_path=".gameSettings.$jq_key_name"

    # Prefer type info from validation spec when available.
    local type
    type="$(validation_var_type "$var_name" 2>/dev/null || echo "")"
    case "$type" in
      bool|int|number)
        jq_arg_option="--argjson"
        ;;
      string)
        jq_arg_option="--arg"
        ;;
      *)
        # Fallback for unknown vars (keeps old behavior).
        if [[ "$var_value" == "true" || "$var_value" == "false" || "$var_value" =~ ^[+-]?[0-9]+([.][0-9]+)?$ ]]; then
          jq_arg_option="--argjson"
        else
          jq_arg_option="--arg"
        fi
        ;;
    esac

    debug "Updating game setting: $var_name -> $full_jq_path = $var_value (using $jq_arg_option)"

    enshrouded_bootstrap_jq_set "${install_path}/enshrouded_server.json" "$jq_arg_option" val "$var_value" "$full_jq_path = \\$val" || warn "Failed to update $var_name in enshrouded_server.json. JQ command failed."
  done
}
