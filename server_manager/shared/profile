#!/usr/bin/env bash

EN_PROFILE="${EN_PROFILE:-}"
MANAGER_PROFILE="${MANAGER_PROFILE:-}"

EN_PROFILE_DEFAULT="default"
MANAGER_PROFILE_DEFAULT="default"

PROFILE_SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MANAGER_ROOT="${MANAGER_ROOT:-$(cd "$PROFILE_SCRIPT_DIR/.." && pwd)}"

. "$PROFILE_SCRIPT_DIR/validation/lib"

MANAGER_DATA_DIR="${MANAGER_DATA_DIR:-${install_path}/server_manager}"
MANAGER_PROFILE_ROOT="${MANAGER_PROFILE_ROOT:-${install_path}/profile}"
MANAGER_PROFILE_DIR="$MANAGER_PROFILE_ROOT"

# Server Manager profile templates:
# - MANAGER_PROFILE_TEMPLATE_SHIPPED_DIR: templates shipped with the image (read-only layer)
# - MANAGER_PROFILE_TEMPLATE_DIR: runtime profile catalog used by menu/apply/reset (default: persistent volume)
MANAGER_PROFILE_TEMPLATE_SHIPPED_DIR="${MANAGER_PROFILE_TEMPLATE_SHIPPED_DIR:-${MANAGER_ROOT}/profiles/manager}"
MANAGER_PROFILE_TEMPLATE_DIR="${MANAGER_PROFILE_TEMPLATE_DIR:-${install_path}/profiles/manager}"

# Enshrouded profile templates:
# - EN_PROFILE_TEMPLATE_DIR: templates shipped with the image (read-only layer)
# - EN_PROFILE_DIR: runtime profile catalog used by menu/apply/reset (default: persistent volume)
EN_PROFILE_TEMPLATE_DIR="${EN_PROFILE_TEMPLATE_DIR:-${MANAGER_ROOT}/profiles/enshrouded}"
EN_PROFILE_DIR="${EN_PROFILE_DIR:-${install_path}/profiles/enshrouded}"

# Profile selection persistence (single source of truth):
# Stored in server_manager.json as top-level keys:
#   actualProfilManager       (selected Server Manager profile name)
#   actualProfilEnshrouded    (selected Enshrouded profile name)
#
# Additionally, the initial ENV selectors are captured once for transparency:
#   MANAGER_PROFILE
#   EN_PROFILE

profiles_config_json_key() {
  # Map internal selector names to JSON keys.
  # Usage: profiles_config_json_key manager|enshrouded
  case "$1" in
    manager) echo "actualProfilManager" ;;
    enshrouded) echo "actualProfilEnshrouded" ;;
    *) echo "" ;;
  esac
}

profiles_ensure_schema() {
  # Ensure the 4 profile selection keys exist (always strings, never null).
  local file tmp mdef edef
  file="$(manager_config_path)"
  mdef="$MANAGER_PROFILE_DEFAULT"
  edef="$EN_PROFILE_DEFAULT"

  if ! command -v jq >/dev/null 2>&1; then
    return 0
  fi
  if [[ ! -f "$file" ]] || ! jq -e 'type == "object"' "$file" >/dev/null 2>&1; then
    return 0
  fi

  tmp="$(mktemp)"
  jq --arg mdef "$mdef" --arg edef "$edef" '
    .MANAGER_PROFILE = (if (.MANAGER_PROFILE == null or .MANAGER_PROFILE == "") then $mdef else .MANAGER_PROFILE end)
    | .EN_PROFILE = (if (.EN_PROFILE == null or .EN_PROFILE == "") then $edef else .EN_PROFILE end)
    | .actualProfilManager = (if (.actualProfilManager == null or .actualProfilManager == "") then $mdef else .actualProfilManager end)
    | .actualProfilEnshrouded = (if (.actualProfilEnshrouded == null or .actualProfilEnshrouded == "") then $edef else .actualProfilEnshrouded end)
    | del(.profiles)
  ' "$file" >"$tmp" || {
    rm -f "$tmp"
    return 0
  }
  mv "$tmp" "$file"
  chmod 600 "$file" 2>/dev/null || true
  chown enshrouded:enshrouded "$file" 2>/dev/null || true
  return 0
}

profiles_config_get() {
  # Get a profile selector value from server_manager.json (top-level keys).
  # Usage: profiles_config_get manager|enshrouded
  local key json_key file value
  key="$1"
  json_key="$(profiles_config_json_key "$key")"
  if [[ -z "$json_key" ]]; then
    echo ""
    return 0
  fi
  file="$(manager_config_path)"
  if ! command -v jq >/dev/null 2>&1; then
    echo ""
    return 0
  fi
  if [[ ! -f "$file" ]] || ! jq -e 'type == "object"' "$file" >/dev/null 2>&1; then
    echo ""
    return 0
  fi
  value="$(jq -r --arg key "$json_key" '.[$key] // empty' "$file" 2>/dev/null || true)"
  if [[ "$value" == "null" ]]; then
    value=""
  fi

  echo "$value"
}

profiles_env_get() {
  # Get a captured ENV selector value from server_manager.json (top-level keys).
  # Usage: profiles_env_get EN_PROFILE|MANAGER_PROFILE
  local key file value
  key="$1"
  file="$(manager_config_path)"
  if ! command -v jq >/dev/null 2>&1; then
    echo ""
    return 0
  fi
  if [[ ! -f "$file" ]] || ! jq -e 'type == "object"' "$file" >/dev/null 2>&1; then
    echo ""
    return 0
  fi
  value="$(jq -r --arg key "$key" '.[$key] // empty' "$file" 2>/dev/null || true)"
  if [[ "$value" == "null" ]]; then
    value=""
  fi

  echo "$value"
}

profiles_config_set() {
  # Set a profile selector value in server_manager.json (top-level keys).
  # Usage: profiles_config_set manager|enshrouded <value>
  local key json_key value file tmp def
  key="$1"
  value="${2-}"
  json_key="$(profiles_config_json_key "$key")"
  if [[ -z "$json_key" ]]; then
    return 0
  fi
  file="$(manager_config_path)"
  case "$key" in
    enshrouded) def="$EN_PROFILE_DEFAULT" ;;
    *) def="$MANAGER_PROFILE_DEFAULT" ;;
  esac

  if ! command -v jq >/dev/null 2>&1; then
    warn "jq not found: cannot persist profile selection"
    return 1
  fi
  if [[ ! -f "$file" ]] || ! jq -e 'type == "object"' "$file" >/dev/null 2>&1; then
    warn "server_manager.json missing/invalid: cannot persist profile selection"
    return 1
  fi

  tmp="$(mktemp)"
  if [[ -z "$value" ]]; then
    value="$def"
  fi

  jq --arg key "$json_key" --arg value "$value" '.[$key] = $value | del(.profiles)' "$file" >"$tmp" || {
    rm -f "$tmp"
    return 1
  }

  mv "$tmp" "$file"
  chmod 600 "$file" 2>/dev/null || true
  chown enshrouded:enshrouded "$file" 2>/dev/null || true
  return 0
}

profiles_env_set_if_missing() {
  # Capture ENV selector values once (do not overwrite a non-empty existing value).
  #
  # If the key exists but is "default"/null/empty (e.g., seeded by a template),
  # this will set it if the provided value is non-empty.
  # Usage: profiles_env_set_if_missing EN_PROFILE|MANAGER_PROFILE <value>
  local key value file tmp current def
  key="$1"
  value="${2-}"
  case "$key" in
    EN_PROFILE) def="$EN_PROFILE_DEFAULT" ;;
    *) def="$MANAGER_PROFILE_DEFAULT" ;;
  esac

  current="$(profiles_env_get "$key")"
  if [[ -n "$current" && "$current" != "$def" ]]; then
    return 0
  fi
  if [[ -z "$value" ]]; then
    return 0
  fi

  file="$(manager_config_path)"
  if ! command -v jq >/dev/null 2>&1; then
    return 0
  fi
  if [[ ! -f "$file" ]] || ! jq -e 'type == "object"' "$file" >/dev/null 2>&1; then
    return 0
  fi

  tmp="$(mktemp)"
  jq --arg key "$key" --arg value "$value" '.[$key] = $value | del(.profiles)' "$file" >"$tmp" || {
    rm -f "$tmp"
    return 0
  }
  mv "$tmp" "$file"
  chmod 600 "$file" 2>/dev/null || true
  chown enshrouded:enshrouded "$file" 2>/dev/null || true
  return 0
}

manager_config_path() {
  printf "%s/server_manager.json" "$MANAGER_DATA_DIR"
}

backup_dir_resolve() {
  # Resolve BACKUP_DIR to an absolute path (same behavior as enshrouded-backup job).
  local dir
  dir="${BACKUP_DIR:-backups}"
  if [[ "$dir" == /* ]]; then
    printf "%s" "$dir"
  else
    printf "%s/%s" "$install_path" "$dir"
  fi
}

config_backups_dir() {
  # Store config backups under BACKUP_DIR/profiles (default: /home/enshrouded/server/backups/profiles).
  printf "%s/profiles" "$(backup_dir_resolve)"
}

backup_config_file() {
  # Create a timestamped backup of a config JSON file.
  # Usage: backup_config_file <src_file> <label>
  local src label backup_root ts dest n
  src="$1"
  label="$2"

  if [[ -z "$src" || -z "$label" ]]; then
    warn "backup_config_file: missing arguments"
    return 1
  fi

  if [[ ! -f "$src" ]]; then
    return 0
  fi

  backup_root="$(config_backups_dir)"
  mkdir -p "$backup_root" 2>/dev/null || true
  chmod 700 "$backup_root" 2>/dev/null || true
  chown enshrouded:enshrouded "$backup_root" 2>/dev/null || true

  ts="$(date +%Y-%m-%d_%H-%M-%S)"
  dest="${backup_root}/${ts}_${label}.json"
  if [[ -e "$dest" ]]; then
    n=1
    while [[ -e "${backup_root}/${ts}_${label}_${n}.json" ]]; do
      n=$((n + 1))
    done
    dest="${backup_root}/${ts}_${label}_${n}.json"
  fi

  if cp "$src" "$dest" 2>/dev/null; then
    chmod 600 "$dest" 2>/dev/null || true
    chown enshrouded:enshrouded "$dest" 2>/dev/null || true
    if declare -F ui_success >/dev/null 2>&1; then
      ui_success "Backup created: $dest"
    elif declare -F info >/dev/null 2>&1; then
      info "Backup created: $dest"
    fi
    return 0
  fi

  warn "Failed to create backup: $dest"
  return 1
}

manager_profile_path() {
  local name
  name="${1:-$MANAGER_PROFILE_DEFAULT}"
  printf "%s/%s/%s_server_manager.json" "$MANAGER_PROFILE_DIR" "$name" "$name"
}

manager_profile_template_path() {
  local name
  name="${1:-$MANAGER_PROFILE_DEFAULT}"
  printf "%s/%s_server_manager.json" "$MANAGER_PROFILE_TEMPLATE_DIR" "$name"
}

manager_profile_template_shipped_path() {
  local name
  name="${1:-$MANAGER_PROFILE_DEFAULT}"
  printf "%s/%s_server_manager.json" "$MANAGER_PROFILE_TEMPLATE_SHIPPED_DIR" "$name"
}

enshrouded_profile_path() {
  local name
  name="${1:-$EN_PROFILE_DEFAULT}"
  printf "%s/%s_enshrouded_server.json" "$EN_PROFILE_DIR" "$name"
}

enshrouded_profile_template_path() {
  local name
  name="${1:-$EN_PROFILE_DEFAULT}"
  printf "%s/%s_enshrouded_server.json" "$EN_PROFILE_TEMPLATE_DIR" "$name"
}

manager_profile_resolve() {
  local name
  name="$(profiles_config_get "manager")"
  if [[ -z "$name" ]]; then
    # Only used when server_manager.json does not have a persisted selector (bootstrap/new volume).
    name="${MANAGER_PROFILE:-}"
  fi
  if [[ -n "$name" ]]; then
    if validation_check "MANAGER_PROFILE" "$name"; then
      :
    else
      local rc
      rc=$?
      if [[ "$rc" -eq 1 ]]; then
        warn "Invalid manager profile selector: $name (fallback: $MANAGER_PROFILE_DEFAULT)"
        name=""
      fi
    fi
  fi
  if [[ -z "$name" ]]; then
    echo "$MANAGER_PROFILE_DEFAULT"
    return 0
  fi
  if [[ -f "$(manager_profile_path "$name")" || -f "$(manager_profile_template_path "$name")" || -f "$(manager_profile_template_shipped_path "$name")" ]]; then
    echo "$name"
    return 0
  fi
  warn "Profile not found: $name (fallback: $MANAGER_PROFILE_DEFAULT)"
  echo "$MANAGER_PROFILE_DEFAULT"
}

enshrouded_profile_resolve() {
  local name
  name="$(profiles_config_get "enshrouded")"
  if [[ -z "$name" ]]; then
    # Only used when server_manager.json does not have a persisted selector (bootstrap/new volume).
    name="${EN_PROFILE:-}"
  fi
  if [[ -n "$name" ]]; then
    if validation_check "EN_PROFILE" "$name"; then
      :
    else
      local rc
      rc=$?
      if [[ "$rc" -eq 1 ]]; then
        warn "Invalid enshrouded profile selector: $name (fallback: $EN_PROFILE_DEFAULT)"
        name=""
      fi
    fi
  fi
  if [[ -z "$name" ]]; then
    echo "$EN_PROFILE_DEFAULT"
    return 0
  fi
  if [[ -f "$(enshrouded_profile_path "$name")" || -f "$(enshrouded_profile_template_path "$name")" ]]; then
    echo "$name"
    return 0
  fi
  warn "Enshrouded profile not found: $name (fallback: $EN_PROFILE_DEFAULT)"
  echo "$EN_PROFILE_DEFAULT"
}

enshrouded_profile_resolve_from_value() {
  # Resolve an Enshrouded profile name without reading persisted selectors.
  # Usage: enshrouded_profile_resolve_from_value <name>
  local name
  name="${1-}"
  if [[ -n "$name" ]]; then
    if validation_check "EN_PROFILE" "$name"; then
      :
    else
      local rc
      rc=$?
      if [[ "$rc" -eq 1 ]]; then
        warn "Invalid enshrouded profile selector: $name (fallback: $EN_PROFILE_DEFAULT)"
        name=""
      fi
    fi
  fi
  if [[ -z "$name" ]]; then
    echo "$EN_PROFILE_DEFAULT"
    return 0
  fi
  if [[ -f "$(enshrouded_profile_path "$name")" || -f "$(enshrouded_profile_template_path "$name")" ]]; then
    echo "$name"
    return 0
  fi
  warn "Enshrouded profile not found: $name (fallback: $EN_PROFILE_DEFAULT)"
  echo "$EN_PROFILE_DEFAULT"
}

ensure_manager_paths() {
  mkdir -p "$MANAGER_DATA_DIR" "$MANAGER_PROFILE_ROOT"
}

ensure_manager_profile_file() {
  local profile profile_file template_file
  profile="$1"
  profile_file="$(manager_profile_path "$profile")"
  template_file="$(manager_profile_template_path "$profile")"

  if [[ -f "$profile_file" ]]; then
    return 0
  fi
  if [[ ! -f "$template_file" ]]; then
    # If the persistent template catalog is empty (fresh volume), fall back to shipped templates.
    local shipped
    shipped="$(manager_profile_template_shipped_path "$profile")"
    if [[ -f "$shipped" ]]; then
      mkdir -p "$(dirname "$template_file")" 2>/dev/null || true
      if cp "$shipped" "$template_file" 2>/dev/null; then
        chmod 600 "$template_file" 2>/dev/null || true
        chown enshrouded:enshrouded "$template_file" 2>/dev/null || true
      fi
    fi
  fi
  if [[ ! -f "$template_file" ]]; then
    warn "Server Manager profile template not found: $template_file"
    return 1
  fi
  if ! jq -e '.' "$template_file" >/dev/null 2>&1; then
    warn "Invalid JSON in server manager profile template: $template_file"
    return 1
  fi

  mkdir -p "$(dirname "$profile_file")" 2>/dev/null || true
  cp "$template_file" "$profile_file"
  info "Server Manager profile created: $profile_file"
}

ensure_manager_profile_catalog() {
  # Seed MANAGER_PROFILE_TEMPLATE_DIR with shipped templates (copy only missing files).
  local src_dir dest_dir f dest
  src_dir="${MANAGER_PROFILE_TEMPLATE_SHIPPED_DIR:-}"
  dest_dir="${MANAGER_PROFILE_TEMPLATE_DIR:-}"

  if [[ -z "$src_dir" || -z "$dest_dir" ]]; then
    return 0
  fi
  if [[ "$src_dir" == "$dest_dir" ]]; then
    return 0
  fi

  mkdir -p "$dest_dir" 2>/dev/null || true

  shopt -s nullglob
  for f in "$src_dir"/*_server_manager.json; do
    dest="$dest_dir/$(basename "$f")"
    if [[ -e "$dest" ]]; then
      continue
    fi
    if ! jq -e '.' "$f" >/dev/null 2>&1; then
      warn "Invalid JSON in server manager profile template: $f (skipping)"
      continue
    fi
    if cp "$f" "$dest" 2>/dev/null; then
      chmod 600 "$dest" 2>/dev/null || true
      chown enshrouded:enshrouded "$dest" 2>/dev/null || true
    else
      warn "Failed to seed Server Manager profile template: $dest"
    fi
  done
  shopt -u nullglob
}

ensure_enshrouded_profile_file() {
  local profile profile_file template_file
  profile="$1"
  profile_file="$(enshrouded_profile_path "$profile")"
  template_file="$(enshrouded_profile_template_path "$profile")"

  if [[ -f "$profile_file" ]]; then
    return 0
  fi
  if [[ ! -f "$template_file" ]]; then
    warn "Enshrouded profile template not found: $template_file"
    return 1
  fi
  if ! jq -e '.' "$template_file" >/dev/null 2>&1; then
    warn "Invalid JSON in enshrouded profile template: $template_file"
    return 1
  fi

  mkdir -p "$(dirname "$profile_file")" 2>/dev/null || true
  if cp "$template_file" "$profile_file" 2>/dev/null; then
    chmod 600 "$profile_file" 2>/dev/null || true
    chown enshrouded:enshrouded "$profile_file" 2>/dev/null || true
    info "Enshrouded profile created: $profile_file"
    return 0
  fi

  warn "Failed to create Enshrouded profile: $profile_file"
  return 1
}

ensure_enshrouded_profile_catalog() {
  # Seed EN_PROFILE_DIR with shipped templates (copy only missing files).
  local src_dir dest_dir f dest
  src_dir="${EN_PROFILE_TEMPLATE_DIR:-}"
  dest_dir="${EN_PROFILE_DIR:-}"

  if [[ -z "$src_dir" || -z "$dest_dir" ]]; then
    return 0
  fi
  if [[ "$src_dir" == "$dest_dir" ]]; then
    return 0
  fi

  mkdir -p "$dest_dir" 2>/dev/null || true

  shopt -s nullglob
  for f in "$src_dir"/*_enshrouded_server.json; do
    dest="$dest_dir/$(basename "$f")"
    if [[ -e "$dest" ]]; then
      continue
    fi
    if ! jq -e '.' "$f" >/dev/null 2>&1; then
      warn "Invalid JSON in enshrouded profile template: $f (skipping)"
      continue
    fi
    if cp "$f" "$dest" 2>/dev/null; then
      chmod 600 "$dest" 2>/dev/null || true
      chown enshrouded:enshrouded "$dest" 2>/dev/null || true
    else
      warn "Failed to seed Enshrouded profile template: $dest"
    fi
  done
  shopt -u nullglob
}

manager_json_get() {
  local file var path
  file="$1"
  var="$2"
  path="$(validation_var_meta_field "$var" "managerJsonPath" 2>/dev/null || true)"
  if [[ -z "$path" || ! -f "$file" ]]; then
    echo ""
    return 0
  fi
  jq -r "$path // empty" "$file" 2>/dev/null || true
}

manager_value_is_valid() {
  local var value rc
  var="$1"
  value="$2"

  if validation_check "$var" "$value"; then
    return 0
  fi
  rc=$?
  case "$rc" in
    0) return 0 ;;
    1) return 1 ;;
    *) return 0 ;; # Unknown rule/unavailable validator: do not block bootstrap.
  esac
}

manager_config_set() {
  local file temp_file
  file="$1"
  shift
  temp_file="$(mktemp)"
  if jq "$@" "$file" >"$temp_file"; then
    mv "$temp_file" "$file"
    chmod 600 "$file" 2>/dev/null || true
    chown enshrouded:enshrouded "$file" 2>/dev/null || true
  else
    rm -f "$temp_file"
    warn "Failed to update $file (jq error)"
  fi
}

manager_config_set_value() {
  local file var value path type
  file="$1"
  var="$2"
  value="${3-}"
  path="$(validation_var_meta_field "$var" "managerJsonPath" 2>/dev/null || true)"
  type="$(validation_var_type "$var" 2>/dev/null || true)"
  [[ -z "$type" ]] && type="string"
  if [[ -z "$path" ]]; then
    return 0
  fi
  if [[ -z "$value" ]]; then
    manager_config_set "$file" "$path = null"
    return 0
  fi
  case "$type" in
    bool|int|number)
      manager_config_set "$file" --argjson val "$value" "$path = \$val"
      ;;
    *)
      manager_config_set "$file" --arg val "$value" "$path = \$val"
      ;;
  esac
}

profiles_env_set_if_empty_validated() {
  # Set an env var only if it is currently empty/unset and the candidate is valid.
  # Usage: profiles_env_set_if_empty_validated <VAR_NAME> <candidate_value> <source_label>
  local var candidate source rc
  var="$1"
  candidate="${2-}"
  source="${3-}"

  if [[ -n "${!var-}" ]]; then
    return 0
  fi
  if [[ -z "$candidate" ]]; then
    return 0
  fi

  if validation_check "$var" "$candidate"; then
    printf -v "$var" '%s' "$candidate"
    return 0
  fi

  rc=$?
  case "$rc" in
    1)
      warn "Invalid $var in $source (actual: $candidate)"
      return 1
      ;;
    *)
      # Unknown rule/unavailable validator: accept candidate (keeps older behavior).
      printf -v "$var" '%s' "$candidate"
      return 0
      ;;
  esac
}

manager_profile_value_for_var() {
  local profile var file value
  profile="$1"
  var="$2"
  file="$(manager_profile_path "$profile")"
  value="$(manager_json_get "$file" "$var")"
  echo "$value"
}

update_or_create_manager_config() {
  local config_file profile value env_value var created_config
  created_config="false"

  if ! command -v jq >/dev/null 2>&1; then
    warn "jq not found: skipping server_manager.json initialization"
    return 0
  fi

  ensure_manager_paths
  profile="$(manager_profile_resolve)"

  if ! ensure_manager_profile_file "$MANAGER_PROFILE_DEFAULT"; then
    return 1
  fi
  if ! ensure_manager_profile_file "$profile"; then
    return 1
  fi

  config_file="$(manager_config_path)"
  if [[ ! -f "$config_file" ]] || ! jq -e 'type == "object"' "$config_file" >/dev/null 2>&1; then
    cp "$(manager_profile_path "$profile")" "$config_file"
    info "server_manager.json initialized from profile: $profile"
    created_config="true"
  fi

  # Ensure profile selection keys exist (and drop legacy .profiles if present).
  profiles_ensure_schema || true

  while IFS= read -r var; do
    [[ -z "$var" ]] && continue
    env_value="$(printenv "$var" 2>/dev/null || true)"
    value=""

    # ENV override (docker-compose/container environment) wins, but should never poison config.
    if [[ -n "$env_value" ]]; then
      if manager_value_is_valid "$var" "$env_value"; then
        value="$env_value"
      else
        warn "Invalid ENV value for $var (actual: $env_value) - ignoring"
      fi
    fi

    # Fallback: active config -> profile template.
    if [[ -z "$value" ]]; then
      value="$(manager_json_get "$config_file" "$var")"
      if [[ -n "$value" ]] && ! manager_value_is_valid "$var" "$value"; then
        warn "Invalid server_manager.json value for $var (actual: $value) - resetting to profile/default"
        value=""
      fi
      if [[ -z "$value" ]]; then
        value="$(manager_profile_value_for_var "$profile" "$var")"
        if [[ -n "$value" ]] && ! manager_value_is_valid "$var" "$value"; then
          warn "Invalid manager profile value for $var (profile: $profile, actual: $value)"
          value=""
        fi
      fi
    fi

    printf -v "$var" '%s' "$value"
    if [[ -n "$value" ]]; then
      export "$var"
    fi
    manager_config_set_value "$config_file" "$var" "$value"
  done < <(validation_list_vars_by_meta_field "managerJsonPath")

  # Persist profile selection in server_manager.json (single source of truth).
  profiles_env_set_if_missing "MANAGER_PROFILE" "${MANAGER_PROFILE:-}" || true
  profiles_env_set_if_missing "EN_PROFILE" "${EN_PROFILE:-}" || true

  # Keep persisted selectors in sync with resolved profiles.
  profiles_config_set "manager" "$profile" || true
  if [[ "$created_config" == "true" ]]; then
    # On first init, allow EN_PROFILE to seed the persisted Enshrouded profile selection.
    profiles_config_set "enshrouded" "$(enshrouded_profile_resolve_from_value "${EN_PROFILE:-}")" || true
  else
    profiles_config_set "enshrouded" "$(enshrouded_profile_resolve)" || true
  fi
}

load_enshrouded_env_from_profile() {
  local profile profile_file config_file
  config_file="${install_path}/enshrouded_server.json"

  # Prefer existing runtime config as the source of truth for runtime defaults.
  # This keeps manual edits (e.g. via ctl menu) consistent across restarts.
  if command -v jq >/dev/null 2>&1 && [[ -f "$config_file" ]] && jq -e '.' "$config_file" >/dev/null 2>&1; then
    local var path candidate
    while IFS= read -r var; do
      [[ -z "$var" ]] && continue
      [[ -n "${!var-}" ]] && continue
      path="$(validation_var_meta_field "$var" "enshroudedJsonPath" 2>/dev/null || true)"
      [[ -z "$path" ]] && continue
      candidate="$(jq -r "$path // empty" "$config_file" 2>/dev/null || true)"
      profiles_env_set_if_empty_validated "$var" "$candidate" "$config_file" || true
    done < <(validation_list_vars_by_meta_field "enshroudedJsonPath")
  fi

  profile="$(enshrouded_profile_resolve)"
  # Prefer a persisted profile file in EN_PROFILE_DIR, seed from shipped templates if needed.
  ensure_enshrouded_profile_file "$profile" || true
  profile_file="$(enshrouded_profile_path "$profile")"
  if [[ ! -f "$profile_file" ]]; then
    profile_file="$(enshrouded_profile_template_path "$profile")"
  fi

  if [[ ! -f "$profile_file" ]]; then
    return 1
  fi
  if ! jq -e '.' "$profile_file" >/dev/null 2>&1; then
    return 1
  fi

  local var path candidate
  while IFS= read -r var; do
    [[ -z "$var" ]] && continue
    [[ -n "${!var-}" ]] && continue
    path="$(validation_var_meta_field "$var" "enshroudedJsonPath" 2>/dev/null || true)"
    [[ -z "$path" ]] && continue
    candidate="$(jq -r "$path // empty" "$profile_file" 2>/dev/null || true)"
    profiles_env_set_if_empty_validated "$var" "$candidate" "$profile_file" || true
  done < <(validation_list_vars_by_meta_field "enshroudedJsonPath")

  return 0
}

init_runtime_env() {
  # Ensure MANAGER_PROFILE_TEMPLATE_DIR contains a persistent copy of shipped Server Manager templates.
  ensure_manager_profile_catalog || true

  if ! update_or_create_manager_config; then
    fatal "Failed to initialize server_manager.json from profile"
  fi

  # Ensure EN_PROFILE_DIR contains a persistent copy of shipped Enshrouded templates.
  ensure_enshrouded_profile_catalog || true

  if ! load_enshrouded_env_from_profile; then
    fatal "Failed to load Enshrouded profile defaults"
  fi

  savefile_name="$SAVEFILE_NAME"
  steam_app_id="$STEAM_APP_ID"
}

ensure_enshrouded_config_from_profile() {
  local profile source_profile config_file temp_file

  config_file="${install_path}/enshrouded_server.json"
  if [[ -f "$config_file" ]]; then
    return 0
  fi

  profile="$(enshrouded_profile_resolve)"
  source_profile="$(enshrouded_profile_path "$profile")"
  if [[ ! -f "$source_profile" ]]; then
    # If EN_PROFILE_DIR is empty (fresh volume), fall back to shipped templates.
    ensure_enshrouded_profile_file "$profile" || true
    source_profile="$(enshrouded_profile_path "$profile")"
  fi
  if [[ ! -f "$source_profile" ]]; then
    source_profile="$(enshrouded_profile_template_path "$profile")"
  fi
  if [[ ! -f "$source_profile" ]]; then
    warn "No enshrouded profile file found for '$profile' (searched: $EN_PROFILE_DIR, $EN_PROFILE_TEMPLATE_DIR)"
    return 1
  fi
  if ! jq -e '.' "$source_profile" >/dev/null 2>&1; then
    warn "Invalid JSON in enshrouded profile: $source_profile"
    return 1
  fi

  mkdir -p "$install_path"
  temp_file="$(mktemp)"
  if jq 'if has("bans") then . else . + {bans: []} end' "$source_profile" >"$temp_file"; then
    mv "$temp_file" "$config_file"
    chmod 600 "$config_file" 2>/dev/null || true
    chown enshrouded:enshrouded "$config_file" 2>/dev/null || true
    info "Created enshrouded_server.json from profile: $profile"
    return 0
  fi

  rm -f "$temp_file"
  warn "Failed to create enshrouded_server.json from profile: $profile"
  return 1
}
